# OpenClaw AI 个人助理平台 - 测试用例详细清单

> 版本: 1.0 | 创建日期: 2026-02-08 | 状态: 执行中
>
> 本文档包含每个模块的详细测试用例、输入输出、日志检查点

---

## 修订记录

| 版本 | 日期 | 修订内容 |
|------|------|----------|
| 1.0 | 2026-02-08 | 初始版本 |

---

## 1. 密码工具测试 (src/db/utils/password.ts)

### 1.1 hashPassword() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| PWD-HASH-001 | 正常密码哈希 | `"Test@123"` | 以 `$scrypt$` 开头的字符串 | 无 |
| PWD-HASH-002 | 空密码 | `""` | 正常返回哈希 | 无 |
| PWD-HASH-003 | 长密码 | 128 字符密码 | 正常返回哈希 | 无 |

**测试代码示例:**

```typescript
import { describe, it, expect } from 'vitest';
import { hashPassword } from './password.js';

describe('hashPassword', () => {
  it('PWD-HASH-001: 应该正确哈希正常密码', async () => {
    console.log('[TEST] ========== PWD-HASH-001 ==========');
    const password = 'Test@123';
    console.log('[TEST] 输入密码:', password);

    const hash = await hashPassword(password);
    console.log('[TEST] 生成哈希:', hash);

    expect(hash).toMatch(/^\$scrypt\$/);
    expect(hash.split('$')).toHaveLength(7);
    console.log('[TEST] 测试状态: ✅ PASS');
  });
});
```

### 1.2 verifyPassword() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| PWD-VERIFY-001 | 正确密码验证 | 密码 + 正确哈希 | `true` | 无 |
| PWD-VERIFY-002 | 错误密码验证 | 错误密码 + 哈希 | `false` | 无 |
| PWD-VERIFY-003 | 无效哈希格式 | 密码 + 无效哈希 | `false` | 无 |
| PWD-VERIFY-004 | 空密码验证 | `""` + 哈希 | `false` | 无 |

**测试代码示例:**

```typescript
describe('verifyPassword', () => {
  it('PWD-VERIFY-001: 应该验证正确密码', async () => {
    console.log('[TEST] ========== PWD-VERIFY-001 ==========');
    const password = 'Test@123';
    const hash = await hashPassword(password);
    console.log('[TEST] 原始密码:', password);
    console.log('[TEST] 哈希值:', hash);

    const result = await verifyPassword(password, hash);
    console.log('[TEST] 验证结果:', result);

    expect(result).toBe(true);
    console.log('[TEST] 测试状态: ✅ PASS');
  });

  it('PWD-VERIFY-002: 应该拒绝错误密码', async () => {
    console.log('[TEST] ========== PWD-VERIFY-002 ==========');
    const password = 'Test@123';
    const wrongPassword = 'Wrong@123';
    const hash = await hashPassword(password);
    console.log('[TEST] 正确密码:', password);
    console.log('[TEST] 错误密码:', wrongPassword);

    const result = await verifyPassword(wrongPassword, hash);
    console.log('[TEST] 验证结果:', result);

    expect(result).toBe(false);
    console.log('[TEST] 测试状态: ✅ PASS');
  });
});
```

### 1.3 validatePasswordStrength() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| PWD-VALID-001 | 强密码 | `"Test@123"` | `{ valid: true, errors: [] }` | 无 |
| PWD-VALID-002 | 太短密码 | `"Test@1"` | `{ valid: false, errors: ["密码长度至少 8 位"] }` | 无 |
| PWD-VALID-003 | 缺少小写字母 | `"TEST@123"` | `{ valid: false, errors: ["密码需包含小写字母"] }` | 无 |
| PWD-VALID-004 | 缺少大写字母 | `"test@123"` | `{ valid: false, errors: ["密码需包含大写字母"] }` | 无 |
| PWD-VALID-005 | 缺少数字 | `"Test@abc"` | `{ valid: false, errors: ["密码需包含数字"] }` | 无 |

---

## 2. JWT 工具测试 (src/assistant/auth/jwt.ts)

### 2.1 generateAccessToken() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| JWT-GEN-001 | 生成用户 Token | `userId: "test-user-1"` | `{ accessToken: string, expiresIn: 900 }` | `[jwt] Access token generated` |
| JWT-GEN-002 | 自定义过期时间 | `userId, expiresIn: "1h"` | `{ accessToken: string, expiresIn: 3600 }` | `[jwt] Access token generated` |
| JWT-GEN-003 | 缺少 JWT_SECRET | 未设置环境变量 | 抛出错误 | 无 |

**测试代码示例:**

```typescript
import { describe, it, expect, beforeAll } from 'vitest';
import { generateAccessToken, verifyAccessToken } from './jwt.js';

describe('generateAccessToken', () => {
  beforeAll(() => {
    process.env.JWT_SECRET = 'test-jwt-secret-at-least-32-characters-long';
  });

  it('JWT-GEN-001: 应该生成有效的 Access Token', () => {
    console.log('[TEST] ========== JWT-GEN-001 ==========');
    const userId = 'test-user-1';
    console.log('[TEST] 用户ID:', userId);

    const result = generateAccessToken(userId);
    console.log('[TEST] 生成结果:', {
      accessToken: result.accessToken.substring(0, 20) + '...',
      expiresIn: result.expiresIn,
    });

    expect(result.accessToken).toBeTruthy();
    expect(result.expiresIn).toBe(900); // 15分钟

    // 验证 Token 可以被解析
    const payload = verifyAccessToken(result.accessToken);
    expect(payload).toBeTruthy();
    expect(payload?.sub).toBe(userId);
    expect(payload?.type).toBe('user');

    console.log('[TEST] Token payload:', payload);
    console.log('[TEST] 测试状态: ✅ PASS');
  });
});
```

### 2.2 verifyAccessToken() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| JWT-VERIFY-001 | 验证有效 Token | 有效 Token | `UserAccessTokenPayload` | 无 |
| JWT-VERIFY-002 | 验证过期 Token | 过期 Token | `null` | `[jwt] Token expired` |
| JWT-VERIFY-003 | 验证无效 Token | 无效字符串 | `null` | `[jwt] Invalid token` |
| JWT-VERIFY-004 | 验证错误类型 Token | Device Token | `null` | `[jwt] Invalid token type` |
| JWT-VERIFY-005 | 验证篡改 Token | 篡改的 Token | `null` | `[jwt] Invalid token` |

### 2.3 extractBearerToken() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| JWT-EXTRACT-001 | 提取正常 Bearer Token | `"Bearer abc123"` | `"abc123"` | 无 |
| JWT-EXTRACT-002 | 无 Bearer 前缀 | `"abc123"` | `null` | 无 |
| JWT-EXTRACT-003 | 空 Header | `undefined` | `null` | 无 |

---

## 3. 用户仓库测试 (src/db/repositories/users.ts)

### 3.1 UserRepository.create() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| USER-CREATE-001 | 创建手机号用户 | `{ phone: "+8613800138000", passwordHash: "..." }` | 返回用户对象 | `[user-repo] User created` |
| USER-CREATE-002 | 创建邮箱用户 | `{ email: "test@example.com", passwordHash: "..." }` | 返回用户对象 | `[user-repo] User created` |
| USER-CREATE-003 | 自动哈希密码 | `{ phone: "...", passwordHash: "plaintext" }` | 密码被哈希 | `[user-repo] User created` |
| USER-CREATE-004 | 创建微信用户 | `{ wechatOpenId: "wx123", displayName: "..." }` | 返回用户对象 | `[user-repo] User created` |

**测试代码示例:**

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import {
  enableMockDatabase,
  clearMockDatabase,
  getMockDatabase
} from '../../db/mock-connection.js';
import { UserRepository } from './users.js';

describe('UserRepository.create', () => {
  let userRepo: UserRepository;

  beforeEach(() => {
    enableMockDatabase();
    clearMockDatabase();
    userRepo = new UserRepository(getMockDatabase());
  });

  it('USER-CREATE-001: 应该创建手机号用户', async () => {
    console.log('[TEST] ========== USER-CREATE-001 ==========');
    const input = {
      phone: '+8613800138000',
      passwordHash: 'Test@123',
      displayName: '测试用户',
    };
    console.log('[TEST] 输入数据:', input);

    const user = await userRepo.create(input);
    console.log('[TEST] 创建结果:', {
      id: user.id,
      phone: user.phone,
      displayName: user.displayName,
    });

    expect(user.id).toBeTruthy();
    expect(user.phone).toBe(input.phone);
    expect(user.passwordHash).toMatch(/^\$scrypt\$/);
    expect(user.isActive).toBe(true);

    console.log('[TEST] 测试状态: ✅ PASS');
  });
});
```

### 3.2 UserRepository.findByIdentifier() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| USER-FIND-001 | 通过手机号查找 | `"+8613800138000"` | 返回用户对象 | 无 |
| USER-FIND-002 | 通过邮箱查找 | `"test@example.com"` | 返回用户对象 | 无 |
| USER-FIND-003 | 用户不存在 | `"nonexist@example.com"` | `null` | 无 |

### 3.3 UserSessionRepository.create() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| SESSION-CREATE-001 | 创建会话 | `userId, { ipAddress, userAgent }` | `{ session, refreshToken }` | `[user-session-repo] Session created` |
| SESSION-CREATE-002 | 自定义过期时间 | `userId, { expiresInMs: 3600000 }` | 1小时后过期 | `[user-session-repo] Session created` |
| SESSION-CREATE-003 | 默认过期时间 | `userId, {}` | 7天后过期 | `[user-session-repo] Session created` |

### 3.4 VerificationCodeRepository.verify() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| CODE-VERIFY-001 | 验证正确验证码 | `target, code, purpose` | `true` | `[verification-code-repo] Code verified` |
| CODE-VERIFY-002 | 验证错误验证码 | `target, wrongCode, purpose` | `false` | 无 |
| CODE-VERIFY-003 | 验证过期验证码 | `target, expiredCode, purpose` | `false` | 无 |
| CODE-VERIFY-004 | 验证已使用验证码 | `target, usedCode, purpose` | `false` | 无 |

---

## 4. 用户认证服务测试 (src/assistant/auth/auth-service.ts)

### 4.1 register() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| AUTH-REG-001 | 手机号注册成功 | `{ phone, code, password }` | `{ success: true, user, accessToken }` | `[auth] User registered successfully` |
| AUTH-REG-002 | 邮箱注册成功 | `{ email, code, password }` | `{ success: true, user, accessToken }` | `[auth] User registered successfully` |
| AUTH-REG-003 | 缺少标识符 | `{ code, password }` | `{ success: false, errorCode: "MISSING_IDENTIFIER" }` | 无 |
| AUTH-REG-004 | 用户已存在 | 已注册的 phone | `{ success: false, errorCode: "USER_EXISTS" }` | `[auth] Registration failed: user already exists` |
| AUTH-REG-005 | 验证码错误 | `{ phone, wrongCode }` | `{ success: false, errorCode: "INVALID_CODE" }` | `[auth] Registration failed: invalid code` |
| AUTH-REG-006 | 弱密码 | `{ phone, code, password: "123" }` | `{ success: false, errorCode: "WEAK_PASSWORD" }` | 无 |

**测试代码示例:**

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import {
  enableMockDatabase,
  clearMockDatabase,
  seedMockTable
} from '../../db/mock-connection.js';
import { register } from './auth-service.js';

describe('register', () => {
  beforeEach(() => {
    enableMockDatabase();
    clearMockDatabase();
    process.env.JWT_SECRET = 'test-jwt-secret-at-least-32-characters-long';

    // 预置验证码
    seedMockTable('verification_codes', [{
      id: 'code-1',
      target: '+8613800138000',
      targetType: 'phone',
      code: '123456',
      purpose: 'register',
      expiresAt: new Date(Date.now() + 5 * 60 * 1000),
      used: false,
      attempts: '0',
    }]);
  });

  it('AUTH-REG-001: 应该成功注册手机号用户', async () => {
    console.log('[TEST] ========== AUTH-REG-001 ==========');
    const request = {
      phone: '+8613800138000',
      code: '123456',
      password: 'Test@123',
      displayName: '测试用户',
    };
    console.log('[TEST] 注册请求:', request);

    const result = await register(request);
    console.log('[TEST] 注册结果:', {
      success: result.success,
      userId: result.user?.id,
      hasToken: !!result.accessToken,
    });

    expect(result.success).toBe(true);
    expect(result.user).toBeTruthy();
    expect(result.user?.phone).toBe(request.phone);
    expect(result.accessToken).toBeTruthy();
    expect(result.refreshToken).toBeTruthy();

    console.log('[TEST] 测试状态: ✅ PASS');
  });
});
```

### 4.2 login() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| AUTH-LOGIN-001 | 密码登录成功 | `{ identifier, password }` | `{ success: true, user, accessToken }` | `[auth] User logged in successfully` |
| AUTH-LOGIN-002 | 验证码登录成功 | `{ identifier, code }` | `{ success: true, user, accessToken }` | `[auth] User logged in successfully` |
| AUTH-LOGIN-003 | 用户不存在 | 不存在的 identifier | `{ success: false, errorCode: "INVALID_CREDENTIALS" }` | `[auth] Login failed: user not found` |
| AUTH-LOGIN-004 | 密码错误 | `{ identifier, wrongPassword }` | `{ success: false, errorCode: "INVALID_CREDENTIALS" }` | `[auth] Login failed: invalid credentials` |
| AUTH-LOGIN-005 | 账户被停用 | 停用用户的 identifier | `{ success: false, errorCode: "ACCOUNT_DISABLED" }` | 无 |
| AUTH-LOGIN-006 | IP 限流 | 超过 20 次失败 | `{ success: false, errorCode: "IP_RATE_LIMITED" }` | `[auth] Login blocked: IP rate limit exceeded` |
| AUTH-LOGIN-007 | 账户锁定 | 超过 5 次失败 | `{ success: false, errorCode: "ACCOUNT_LOCKED" }` | `[auth] Login blocked: account locked` |
| AUTH-LOGIN-008 | 缺少凭据 | `{ identifier }` | `{ success: false, errorCode: "MISSING_CREDENTIALS" }` | 无 |

### 4.3 refreshToken() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| AUTH-REFRESH-001 | 刷新成功 | 有效 refreshToken | `{ success: true, accessToken }` | `[auth] Token refreshed successfully` |
| AUTH-REFRESH-002 | 无效 Token | 无效 refreshToken | `{ success: false, errorCode: "INVALID_REFRESH_TOKEN" }` | `[auth] Token refresh failed: invalid refresh token` |
| AUTH-REFRESH-003 | 用户不存在 | 已删除用户的 Token | `{ success: false, errorCode: "USER_INACTIVE" }` | `[auth] Token refresh failed: user not found or inactive` |
| AUTH-REFRESH-004 | Token 轮转 | 即将过期的 Token | 返回新的 refreshToken | `[auth] Refresh token rotated` |

### 4.4 logout() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| AUTH-LOGOUT-001 | 登出成功 | 有效 refreshToken | `{ success: true }` | `[auth] User logged out` |
| AUTH-LOGOUT-002 | Token 不存在 | 不存在的 Token | `{ success: true }` | 无 |

---

## 5. 管理员认证服务测试 (src/assistant/admin-auth/admin-auth-service.ts)

### 5.1 adminLogin() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| ADMIN-LOGIN-001 | 登录成功 | `{ username, password }` | `{ success: true, admin, accessToken }` | `[admin-auth] Admin logged in successfully` |
| ADMIN-LOGIN-002 | 用户名不存在 | 不存在的 username | `{ success: false, errorCode: "INVALID_CREDENTIALS" }` | `[admin-auth] Login failed: admin not found` |
| ADMIN-LOGIN-003 | 密码错误 | `{ username, wrongPassword }` | `{ success: false, errorCode: "INVALID_CREDENTIALS" }` | `[admin-auth] Login failed: invalid password` |
| ADMIN-LOGIN-004 | 账户被停用 | suspended 状态账户 | `{ success: false, errorCode: "ACCOUNT_SUSPENDED" }` | 无 |
| ADMIN-LOGIN-005 | 账户被锁定 | locked 状态账户 | `{ success: false, errorCode: "ACCOUNT_LOCKED" }` | 无 |
| ADMIN-LOGIN-006 | IP 限流 | 超过 20 次失败 | `{ success: false, errorCode: "IP_RATE_LIMITED" }` | `[admin-auth] Login blocked: IP rate limit exceeded` |
| ADMIN-LOGIN-007 | 账户级限流 | 超过 5 次失败 | `{ success: false, errorCode: "ACCOUNT_LOCKED" }` | `[admin-auth] Account locked due to too many failed attempts` |
| ADMIN-LOGIN-008 | MFA 验证 | 启用 MFA 的账户 | `{ success: false, mfaRequired: true }` | 无 |

---

## 6. 订阅服务测试 (src/assistant/subscription/service.ts)

### 6.1 getUserSubscription() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| SUB-GET-001 | 获取有效订阅 | userId | 返回订阅对象 | 无 |
| SUB-GET-002 | 用户无订阅 | 新用户 userId | `null` | 无 |
| SUB-GET-003 | 订阅已过期 | 过期订阅的 userId | 返回过期订阅 | 无 |

### 6.2 createSubscription() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| SUB-CREATE-001 | 创建订阅成功 | `{ userId, planId, billingPeriod }` | 返回订阅对象 | `创建订阅` |
| SUB-CREATE-002 | 用户已有订阅 | 已订阅用户 | 抛出错误 | 无 |
| SUB-CREATE-003 | 试用订阅 | `{ startTrial: true }` | status = "trialing" | `创建订阅` |
| SUB-CREATE-004 | 终身订阅 | `{ billingPeriod: "lifetime" }` | 100年后过期 | `创建订阅` |

### 6.3 checkQuota() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| QUOTA-CHECK-001 | 配额充足 | `userId, "conversations"` | `{ allowed: true, remaining: N }` | 无 |
| QUOTA-CHECK-002 | 配额耗尽 | 已达上限的 userId | `{ allowed: false, reason: "..." }` | 记录 quota.exceeded 事件 |
| QUOTA-CHECK-003 | 无限配额 | pro 用户 | `{ allowed: true, remaining: -1 }` | 无 |
| QUOTA-CHECK-004 | 每日配额重置 | 跨天查询 | 配额重置 | 无 |
| QUOTA-CHECK-005 | 每月配额重置 | 跨月查询 | 配额重置 | 无 |

---

## 7. 技能服务测试 (src/assistant/skills/skill-service.ts)

### 7.1 getSkillList() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| SKILL-LIST-001 | 获取全部技能 | `{}` | 返回分页列表 | `[SkillService] getSkillList` |
| SKILL-LIST-002 | 搜索技能 | `{ search: "文件" }` | 返回匹配结果 | `[SkillService] getSkillList` |
| SKILL-LIST-003 | 按分类筛选 | `{ categoryId: "cat-1" }` | 返回该分类技能 | `[SkillService] getSkillList` |
| SKILL-LIST-004 | 按状态筛选 | `{ status: "published" }` | 只返回已发布技能 | `[SkillService] getSkillList` |
| SKILL-LIST-005 | 分页查询 | `{ page: 2, pageSize: 10 }` | 返回第2页 | `[SkillService] getSkillList` |

### 7.2 createSkill() 测试

| 用例ID | 测试场景 | 输入 | 预期输出 | 日志检查点 |
|--------|----------|------|----------|------------|
| SKILL-CREATE-001 | 创建技能成功 | 完整技能数据 | 返回技能对象 | `[SkillService] createSkill` |
| SKILL-CREATE-002 | 自动生成ID | 不提供 id | 自动生成 UUID | `[SkillService] createSkill` |
| SKILL-CREATE-003 | 更新分类计数 | 指定 categoryId | 分类 skillCount +1 | `[SkillService] createSkill` |

---

## 8. 测试执行检查清单

### 8.1 测试前准备

- [ ] 设置 `JWT_SECRET` 环境变量
- [ ] 启用 Mock 数据库
- [ ] 清空 Mock 数据
- [ ] 准备种子数据

### 8.2 测试执行

- [ ] 运行所有测试: `pnpm test`
- [ ] 检查测试通过率
- [ ] 检查日志输出
- [ ] 验证覆盖率报告

### 8.3 测试后清理

- [ ] 禁用 Mock 数据库
- [ ] 清理临时文件
- [ ] 记录测试结果

---

*— 文档结束 —*
