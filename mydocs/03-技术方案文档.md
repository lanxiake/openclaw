# AI 个人助理平台 - 技术方案文档

> 版本: 1.0 | 创建日期: 2026-02-06 | 状态: 草稿

---

## 1. 技术选型

### 1.1 后端技术栈

| 层级 | 技术 | 选型理由 |
|------|------|----------|
| 运行时 | Node.js 22+ | 长期支持版本，性能优异，与现有项目一致 |
| Web 框架 | Fastify 4.x | 高性能，TypeScript 友好，插件生态丰富 |
| WebSocket | ws 8.x | 成熟稳定，性能优秀，与 OpenClaw 一致 |
| 数据库 | PostgreSQL 16 | 功能强大，ACID 事务，JSON 支持 |
| ORM | Drizzle ORM | 类型安全，性能好，SQL-like 语法 |
| 缓存/队列 | Redis 7.x | 会话存储、消息队列、分布式锁 |
| AI 服务 | Claude API | 最强推理能力，工具调用支持完善 |

### 1.2 前端技术栈

| 类型 | 技术 | 选型理由 |
|------|------|----------|
| Web 框架 | React 18+ | 生态成熟，组件丰富，团队熟悉 |
| 构建工具 | Vite 5.x | 开发体验好，构建速度快 |
| UI 库 | shadcn/ui | 可定制性强，Tailwind 集成 |
| 状态管理 | Zustand | 轻量简洁，TypeScript 友好 |
| 桌面框架 | Electron 28+ | 跨平台，系统 API 访问，成熟稳定 |

---

## 2. 系统架构详解

### 2.1 Gateway 服务架构

Gateway 是系统的核心枢纽，负责连接管理、消息路由、技能分发等核心功能。

| 模块 | 职责说明 |
|------|----------|
| ConnectionManager | 管理 WebSocket 连接，心跳检测，自动重连 |
| MessageRouter | 消息路由分发，请求响应匹配，事件广播 |
| AuthService | 用户认证，Token 验证，设备授权 |
| SkillLoader | 技能代码加载，版本管理，授权验证 |
| AIProxy | AI API 调用代理，意图识别，任务规划 |
| AuditLogger | 操作审计日志，安全事件记录 |

### 2.2 客户端架构

Windows 客户端基于 Electron 构建，分为主进程和渲染进程两部分。

#### 主进程模块

| 模块 | 职责说明 |
|------|----------|
| GatewayClient | 与 Gateway 的 WebSocket 通信 |
| SkillExecutor | 技能沙箱执行，资源隔离 |
| LocalSkillManager | 本地技能的增删改查 |
| SystemService | 系统 API 调用（文件、进程、注册表） |
| TrayManager | 系统托盘图标和菜单 |
| AutoUpdater | 客户端自动更新 |

---

## 3. 技能系统技术方案

### 3.1 服务端技能加载流程

服务端技能采用动态加载机制，代码不持久化到客户端：

1. 用户请求执行某个服务端技能
2. Gateway 验证用户订阅状态和授权
3. 从技能仓库获取技能代码（已加密）
4. 通过 WebSocket 发送到客户端
5. 客户端解密并在沙箱中执行
6. 执行完成后立即从内存卸载
7. 返回执行结果给用户

### 3.2 技能沙箱设计

技能在隔离的沙箱环境中执行，确保安全性：

| 安全机制 | 实现方式 |
|----------|----------|
| 代码隔离 | 使用 VM2 或 Worker Thread 隔离执行上下文 |
| 资源限制 | 限制 CPU 时间（30秒）、内存（256MB）、执行超时 |
| API 白名单 | 只暴露预定义的安全 API，禁止直接访问 Node.js 核心模块 |
| 文件系统隔离 | 只能访问用户授权的目录，禁止访问系统目录 |
| 网络限制 | 禁止发起外部网络请求（除非明确授权） |

### 3.3 技能 API 设计

技能可以调用的安全 API 列表：

| API 分类 | 方法 | 说明 |
|----------|------|------|
| 文件操作 | fs.readFile, fs.writeFile | 读写白名单目录内的文件 |
| 文件操作 | fs.readdir, fs.stat | 列出目录、获取文件信息 |
| 系统信息 | system.getCpuUsage | 获取 CPU 使用率 |
| 系统信息 | system.getMemoryUsage | 获取内存使用情况 |
| 进程管理 | process.list, process.kill | 列出进程、结束进程 |
| 程序启动 | app.launch, app.open | 启动程序、打开文件 |
| 用户交互 | ui.confirm, ui.notify | 弹出确认框、发送通知 |

---

## 4. 通信协议设计

### 4.1 WebSocket 消息格式

所有 WebSocket 消息采用 JSON 格式，统一结构如下：

```typescript
interface Message {
  type: 'req' | 'resp' | 'event';  // 消息类型
  id: string;                       // 消息唯一标识
  method?: string;                  // 请求方法名（仅 req）
  params?: object;                  // 请求参数（仅 req）
  ok?: boolean;                     // 是否成功（仅 resp）
  payload?: any;                    // 响应数据或事件数据
  error?: {                         // 错误信息（失败时）
    code: string;
    message: string;
  };
}
```

### 4.2 核心消息类型

| 消息方法 | 说明 |
|----------|------|
| auth.connect | 客户端连接认证 |
| device.pair | 设备配对请求 |
| command.execute | 执行指令 |
| command.result | 指令执行结果 |
| skill.load | 加载服务端技能 |
| skill.execute | 执行技能 |
| confirm.request | 敏感操作确认请求 |
| confirm.response | 用户确认响应 |
| heartbeat | 心跳保活 |

---

## 5. 安全方案

### 5.1 传输安全

- 所有通信强制使用 TLS 1.3
- 客户端使用证书固定（Certificate Pinning）
- 技能代码传输使用 AES-256-GCM 加密
- WebSocket 连接 30 秒心跳检测

### 5.2 认证授权

| 机制 | 实现说明 |
|------|----------|
| 用户认证 | JWT Token，有效期 7 天，支持刷新 |
| 设备认证 | 设备指纹 + 配对码绑定，一次性配对 |
| 技能授权 | 订阅状态实时验证，支持授权撤销 |
| 操作授权 | 敏感操作需要用户实时确认 |

### 5.3 审计日志

所有操作记录审计日志，包含以下信息：

- 操作时间（精确到毫秒）
- 操作用户 ID 和设备 ID
- 操作类型和详细参数
- 执行结果（成功/失败）
- 客户端 IP 和 User-Agent
- 日志保留 90 天，支持导出

---

## 6. 部署方案

### 6.1 云端部署架构

| 组件 | 规格 | 说明 |
|------|------|------|
| 负载均衡 | Nginx / ALB | SSL 终结，WebSocket 代理 |
| Gateway 服务 | 2核4G × 2 | Docker 容器部署，支持水平扩展 |
| PostgreSQL | 2核4G RDS | 主从复制，自动备份 |
| Redis | 2G 内存 | 会话存储，消息队列 |
| 对象存储 | S3 / OSS | 技能代码存储，日志归档 |

### 6.2 客户端分发

| 分发方式 | 说明 |
|----------|------|
| 官网下载 | 提供 Windows 安装包下载 |
| 自动更新 | 客户端内置 electron-updater |
| 增量更新 | 仅下载变更部分，减少流量 |

### 6.3 监控告警

| 监控项 | 阈值 | 告警方式 |
|--------|------|----------|
| CPU 使用率 | > 80% | 钉钉/企业微信 |
| 内存使用率 | > 85% | 钉钉/企业微信 |
| 连接数 | > 800/实例 | 钉钉/企业微信 |
| 错误率 | > 1% | 钉钉/企业微信 |
| 响应延迟 | > 500ms | 钉钉/企业微信 |

---

## 7. 项目结构

```
ai-assistant-platform/
├── packages/
│   ├── gateway/           # Gateway 服务
│   │   ├── src/
│   │   │   ├── server.ts
│   │   │   ├── routes/
│   │   │   ├── services/
│   │   │   └── ws/
│   │   └── package.json
│   │
│   ├── client/            # Windows 客户端
│   │   ├── src/
│   │   │   ├── main/      # Electron 主进程
│   │   │   ├── renderer/  # 渲染进程
│   │   │   └── preload/
│   │   └── package.json
│   │
│   ├── shared/            # 共享代码
│   │   ├── src/
│   │   │   ├── types/
│   │   │   ├── protocol/
│   │   │   └── utils/
│   │   └── package.json
│   │
│   └── web/               # Web 管理后台
│       ├── src/
│       └── package.json
│
├── skills/                # 官方技能
│   ├── file-organizer/
│   ├── system-cleaner/
│   └── ...
│
├── docs/                  # 文档
├── scripts/               # 脚本
└── package.json           # 根配置
```

---

*— 文档结束 —*
