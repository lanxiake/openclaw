# AI ä¸ªäººåŠ©ç†å¹³å° - ç”¨æˆ·ç®¡ç†ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬: 2.0 | åˆ›å»ºæ—¥æœŸ: 2026-02-07 | æ›´æ–°æ—¥æœŸ: 2026-02-07 | çŠ¶æ€: è¯„å®¡åä¿®è®¢
>
> æœ¬æ–‡æ¡£è¡¥å…… 03-æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£.md ä¸­ç”¨æˆ·ç®¡ç†ç›¸å…³çš„ç¼ºå¤±éƒ¨åˆ†

---

## ä¿®è®¢è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ       | ä¿®è®¢å†…å®¹                                                                          |
| ---- | ---------- | --------------------------------------------------------------------------------- |
| 1.0  | 2026-02-07 | åˆå§‹è®¾è®¡                                                                          |
| 2.0  | 2026-02-07 | æ ¹æ®è¯„å®¡åé¦ˆä¿®è®¢ï¼šé‡æ„ç”¨æˆ·-è®¾å¤‡å…³ç³»ã€ç®€åŒ–è®¤è¯æ¶æ„ã€å¢å¼ºå®‰å…¨æœºåˆ¶ã€è¡¥å……æ•°æ®è¿ç§»ç­–ç•¥ |

---

## 1. æ¦‚è¿°

### 1.1 èƒŒæ™¯

ç°æœ‰ OpenClaw ä»£ç é‡‡ç”¨**è®¾å¤‡é…å¯¹ + ä¼šè¯éš”ç¦»**æ¨¡å¼ï¼Œç¼ºå°‘å®Œæ•´çš„ç”¨æˆ·è´¦å·ä½“ç³»ã€‚æœ¬æ–‡æ¡£è®¾è®¡ç”¨æˆ·ç®¡ç†ç³»ç»Ÿï¼Œè¡¥å……ä»¥ä¸‹èƒ½åŠ›ï¼š

| è®¾è®¡æ–‡æ¡£æè¿°             | ç°æœ‰å®ç°                 | æœ¬æ–‡æ¡£è¡¥å……        |
| ------------------------ | ------------------------ | ----------------- |
| PostgreSQL å­˜å‚¨ç”¨æˆ·æ•°æ®  | JSON æ–‡ä»¶å­˜å‚¨            | âœ… å®Œæ•´æ•°æ®åº“è®¾è®¡ |
| User å®ä½“ (phone, email) | åŸºäºè®¾å¤‡é…å¯¹ï¼Œæ— ç”¨æˆ·å®ä½“ | âœ… ç”¨æˆ·è´¦å·ä½“ç³»   |
| JWT Token                | ç®€å• Tokenï¼Œéæ ‡å‡† JWT   | âœ… æ ‡å‡† JWT è®¤è¯  |
| Subscription è®¢é˜…ç³»ç»Ÿ    | æœªå®ç°                   | âœ… è®¢é˜…ä¸è®¡è´¹ç³»ç»Ÿ |
| AuditLog å®¡è®¡æ—¥å¿—        | æ“ä½œæ—¥å¿—ä½†éæ•°æ®åº“å­˜å‚¨   | âœ… ç»“æ„åŒ–å®¡è®¡ç³»ç»Ÿ |

### 1.2 è®¾è®¡åŸåˆ™

1. **æ¸è¿›å¼é›†æˆ** - ä¸ç°æœ‰ Gateway è®¤è¯ã€è®¾å¤‡é…å¯¹æœºåˆ¶å…¼å®¹
2. **æœ€å°ä¾µå…¥** - æ–°å¢æ¨¡å—ï¼Œä¸ä¿®æ”¹ç°æœ‰æ ¸å¿ƒä»£ç 
3. **èŒè´£åˆ†ç¦»** - ç”¨æˆ·ç®¡èº«ä»½ï¼Œè®¾å¤‡ç®¡æƒé™ï¼ˆå…³é”®æ”¹è¿›ï¼‰
4. **å¯æ‰©å±•æ€§** - æ”¯æŒæœªæ¥å¤šç§Ÿæˆ·ã€ä¼ä¸šç‰ˆæ‰©å±•
5. **å®‰å…¨ä¼˜å…ˆ** - éµå¾ª OWASP å®‰å…¨æœ€ä½³å®è·µ

### 1.3 æ ¸å¿ƒè®¾è®¡å†³ç­–

#### 1.3.1 ç”¨æˆ·ä¸è®¾å¤‡çš„èŒè´£åˆ†ç¦»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ ¸å¿ƒè®¾è®¡åŸåˆ™                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ· (User)              è®¾å¤‡ (Device)                        â”‚
â”‚   â”œâ”€â”€ èº«ä»½æ ‡è¯†             â”œâ”€â”€ æ“ä½œæƒé™ (role, scopes)          â”‚
â”‚   â”œâ”€â”€ ç™»å½•å‡­æ®             â”œâ”€â”€ è®¾å¤‡ Token                       â”‚
â”‚   â”œâ”€â”€ è®¢é˜…çŠ¶æ€             â”œâ”€â”€ å¹³å°ä¿¡æ¯                         â”‚
â”‚   â””â”€â”€ ä¸ªäººèµ„æ–™             â””â”€â”€ æœ€åæ´»è·ƒæ—¶é—´                      â”‚
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·ç™»å½• â†’ è·å– User Token (ç”¨äºèº«ä»½éªŒè¯)                      â”‚
â”‚   è®¾å¤‡é…å¯¹ â†’ è·å– Device Token (ç”¨äºæ“ä½œæˆæƒï¼Œå¤ç”¨ç°æœ‰æœºåˆ¶)       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**ï¼š

- ç”¨æˆ·è¡¨**ä¸å­˜å‚¨** role å’Œ scopesï¼ˆè¿™äº›å±äºè®¾å¤‡ï¼‰
- è®¾å¤‡è¡¨**å…³è”**åˆ°ç°æœ‰ device-pairing.tsï¼Œè€Œéé‡å¤å­˜å‚¨
- ä¸€ä¸ªç”¨æˆ·å¯ä»¥ç»‘å®šå¤šä¸ªè®¾å¤‡ï¼Œæ¯ä¸ªè®¾å¤‡å¯ä»¥æœ‰ä¸åŒæƒé™

#### 1.3.2 åŒ Token è®¤è¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è®¤è¯ Token æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   User Access Token (JWT)        Device Token (ç°æœ‰æœºåˆ¶)         â”‚
â”‚   â”œâ”€â”€ ç”¨é€”: èº«ä»½éªŒè¯             â”œâ”€â”€ ç”¨é€”: æ“ä½œæˆæƒ              â”‚
â”‚   â”œâ”€â”€ æœ‰æ•ˆæœŸ: 15 åˆ†é’Ÿ            â”œâ”€â”€ æœ‰æ•ˆæœŸ: é•¿æœŸ                â”‚
â”‚   â”œâ”€â”€ å­˜å‚¨: å†…å­˜/Cookie          â”œâ”€â”€ å­˜å‚¨: è®¾å¤‡æœ¬åœ°              â”‚
â”‚   â”œâ”€â”€ åˆ·æ–°: é€šè¿‡ Refresh Token   â”œâ”€â”€ åˆ·æ–°: é€šè¿‡ç°æœ‰è½®è½¬æœºåˆ¶      â”‚
â”‚   â””â”€â”€ åŒ…å«: userId               â””â”€â”€ åŒ…å«: role, scopes          â”‚
â”‚                                                                 â”‚
â”‚   æ“ä½œè¯·æ±‚æ—¶:                                                    â”‚
â”‚   1. éªŒè¯ Device Token â†’ ç¡®è®¤è®¾å¤‡æœ‰æƒé™æ‰§è¡Œæ“ä½œ                  â”‚
â”‚   2. å¯é€‰éªŒè¯ User Token â†’ ç¡®è®¤ç”¨æˆ·èº«ä»½ï¼ˆç”¨äºå®¡è®¡ï¼‰              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 æŠ€æœ¯é€‰å‹

| ç»„ä»¶     | é€‰å‹             | è¯´æ˜                          |
| -------- | ---------------- | ----------------------------- |
| æ•°æ®åº“   | PostgreSQL 16    | æˆç†Ÿç¨³å®šï¼Œæ”¯æŒ JSONã€å…¨æ–‡æœç´¢ |
| ORM      | Drizzle ORM      | ç±»å‹å®‰å…¨ï¼Œè½»é‡çº§              |
| è¿ç§»å·¥å…· | Drizzle Kit      | å†…ç½®è¿ç§»ç®¡ç†                  |
| è¿æ¥æ±    | pg-pool          | PostgreSQL å®˜æ–¹è¿æ¥æ±          |
| å‚æ•°éªŒè¯ | Zod              | ç±»å‹å®‰å…¨çš„ schema éªŒè¯        |
| å¯†ç å“ˆå¸Œ | bcrypt (cost=12) | è¡Œä¸šæ ‡å‡†                      |

---

## 2. æ•°æ®åº“è®¾è®¡

### 2.1 ER å…³ç³»å›¾ï¼ˆä¿®è®¢ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      users      â”‚       â”‚  user_devices   â”‚       â”‚  user_sessions  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â—„â”€â”€â”€â”€â”€â”€â”‚ user_id (FK)    â”‚       â”‚ id (PK)         â”‚
â”‚ phone           â”‚       â”‚ id (PK)         â”‚       â”‚ user_id (FK)    â”‚â—„â”€â”
â”‚ email           â”‚       â”‚ device_id       â”‚â”€â”€â”€â”€â”€â”€â”€â”‚ refresh_token   â”‚  â”‚
â”‚ password_hash   â”‚       â”‚ display_name    â”‚  â–²    â”‚ expires_at      â”‚  â”‚
â”‚ display_name    â”‚       â”‚ linked_at       â”‚  â”‚    â”‚ revoked_at      â”‚  â”‚
â”‚ status          â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚ created_at      â”‚  â”‚
â”‚ is_verified     â”‚                            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ created_at      â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                         â”‚
â”‚ updated_at      â”‚       â”‚ device-pairing  â”‚  â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ (ç°æœ‰ JSON å­˜å‚¨) â”‚â”€â”€â”˜                         â”‚
         â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
         â”‚                â”‚ deviceId        â”‚                            â”‚
         â”‚                â”‚ publicKey       â”‚                            â”‚
         â”‚                â”‚ role            â”‚                            â”‚
         â”‚                â”‚ scopes          â”‚                            â”‚
         â”‚                â”‚ tokens          â”‚                            â”‚
         â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
         â”‚                                                               â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
         â”‚  â”‚  subscriptions  â”‚       â”‚   audit_logs    â”‚               â”‚
         â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
         â””â”€â”€â”‚ user_id (FK)    â”‚       â”‚ id (PK)         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ id (PK)         â”‚       â”‚ user_id (FK)    â”‚
            â”‚ plan_id (FK)    â”‚       â”‚ device_id       â”‚
            â”‚ skill_id (FK)   â”‚       â”‚ action          â”‚
            â”‚ status          â”‚       â”‚ resource        â”‚
            â”‚ started_at      â”‚       â”‚ details (JSONB) â”‚
            â”‚ expires_at      â”‚       â”‚ ip_address      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ created_at      â”‚
                     â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      plans      â”‚     â”‚     skills      â”‚     â”‚  user_skills    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚     â”‚ id (PK)         â”‚     â”‚ id (PK)         â”‚
â”‚ name            â”‚     â”‚ name            â”‚     â”‚ user_id (FK)    â”‚
â”‚ slug            â”‚     â”‚ slug            â”‚     â”‚ skill_id (FK)   â”‚
â”‚ price           â”‚     â”‚ price           â”‚     â”‚ installed_at    â”‚
â”‚ period          â”‚     â”‚ type            â”‚     â”‚ configuration   â”‚
â”‚ features (JSONB)â”‚     â”‚ status          â”‚     â”‚ is_favorite     â”‚
â”‚ limits (JSONB)  â”‚     â”‚ is_active       â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç”¨æˆ·è¡¨ (users) - ä¿®è®¢ç‰ˆ

```sql
CREATE TABLE users (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- è®¤è¯ä¿¡æ¯
    phone           VARCHAR(20) UNIQUE,           -- æ‰‹æœºå· (E.164 æ ¼å¼)
    email           VARCHAR(255) UNIQUE,          -- é‚®ç®±
    password_hash   VARCHAR(255),                 -- bcrypt å“ˆå¸Œ (cost=12)

    -- ç¬¬ä¸‰æ–¹ç™»å½•
    wechat_openid   VARCHAR(100) UNIQUE,          -- å¾®ä¿¡ OpenID
    wechat_unionid  VARCHAR(100),                 -- å¾®ä¿¡ UnionID

    -- ç”¨æˆ·èµ„æ–™
    display_name    VARCHAR(100) NOT NULL,        -- æ˜¾ç¤ºåç§°
    avatar_url      VARCHAR(500),                 -- å¤´åƒ URL

    -- ğŸ†• éªŒè¯çŠ¶æ€
    is_phone_verified BOOLEAN DEFAULT FALSE,      -- æ‰‹æœºå·å·²éªŒè¯
    is_email_verified BOOLEAN DEFAULT FALSE,      -- é‚®ç®±å·²éªŒè¯

    -- ğŸ†• å›½é™…åŒ–
    timezone        VARCHAR(50) DEFAULT 'Asia/Shanghai',
    locale          VARCHAR(10) DEFAULT 'zh-CN',

    -- è´¦æˆ·çŠ¶æ€
    status          VARCHAR(20) NOT NULL DEFAULT 'active',
    -- å¯é€‰å€¼: 'active' | 'suspended' | 'deleted'
    account_type    VARCHAR(20) DEFAULT 'personal', -- personal | business

    -- ğŸ†• MFA å¢å¼º
    mfa_enabled     BOOLEAN DEFAULT FALSE,
    mfa_method      VARCHAR(20),                  -- totp | sms | email
    mfa_secret      VARCHAR(255),                 -- åŠ å¯†å­˜å‚¨çš„ TOTP å¯†é’¥
    mfa_backup_codes TEXT[],                      -- å¤‡ç”¨ç æ•°ç»„

    -- å®‰å…¨ç›¸å…³
    login_attempts  INTEGER DEFAULT 0,            -- ç™»å½•å¤±è´¥æ¬¡æ•°
    locked_until    TIMESTAMP WITH TIME ZONE,     -- é”å®šæˆªæ­¢æ—¶é—´
    password_changed_at TIMESTAMP WITH TIME ZONE, -- å¯†ç æœ€åä¿®æ”¹æ—¶é—´

    -- æ—¶é—´æˆ³
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login_at   TIMESTAMP WITH TIME ZONE,
    deleted_at      TIMESTAMP WITH TIME ZONE,     -- ğŸ†• è½¯åˆ é™¤

    -- çº¦æŸï¼šè‡³å°‘æœ‰ä¸€ç§ç™»å½•æ–¹å¼
    CONSTRAINT chk_login_method CHECK (
        phone IS NOT NULL OR email IS NOT NULL OR wechat_openid IS NOT NULL
    )
);

-- ç´¢å¼•
CREATE INDEX idx_users_phone ON users(phone) WHERE phone IS NOT NULL;
CREATE INDEX idx_users_email ON users(email) WHERE email IS NOT NULL;
CREATE INDEX idx_users_wechat ON users(wechat_openid) WHERE wechat_openid IS NOT NULL;
CREATE INDEX idx_users_status ON users(status) WHERE deleted_at IS NULL;
```

**ä¿®è®¢è¯´æ˜**ï¼š

- âŒ ç§»é™¤ `role` å’Œ `scopes`ï¼ˆè¿™äº›å±äºè®¾å¤‡ï¼‰
- âœ… æ–°å¢ `is_phone_verified`ã€`is_email_verified` éªŒè¯çŠ¶æ€
- âœ… æ–°å¢ `timezone`ã€`locale` å›½é™…åŒ–æ”¯æŒ
- âœ… æ–°å¢å®Œæ•´çš„ MFA å­—æ®µï¼ˆ`mfa_method`ã€`mfa_secret`ã€`mfa_backup_codes`ï¼‰
- âœ… æ–°å¢ `deleted_at` æ”¯æŒè½¯åˆ é™¤
- âœ… æ–°å¢ `password_changed_at` å®‰å…¨è¿½è¸ª

### 2.3 ç”¨æˆ·è®¾å¤‡å…³è”è¡¨ (user_devices) - ä¿®è®¢ç‰ˆ

```sql
-- ğŸ†• ç”¨æˆ·è®¾å¤‡å…³è”è¡¨ï¼ˆå…³è”åˆ°ç°æœ‰ device-pairingï¼Œè€Œéé‡å¤å­˜å‚¨ï¼‰
CREATE TABLE user_devices (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- å…³è”åˆ°ç°æœ‰ device-pairing.ts ä¸­çš„è®¾å¤‡
    device_id       VARCHAR(100) NOT NULL,        -- å¯¹åº” PairedDevice.deviceId

    -- ç”¨æˆ·è‡ªå®šä¹‰ä¿¡æ¯
    display_name    VARCHAR(100),                 -- ç”¨æˆ·ç»™è®¾å¤‡çš„æ˜µç§°
    is_primary      BOOLEAN DEFAULT FALSE,        -- æ˜¯å¦ä¸ºä¸»è®¾å¤‡

    -- æ—¶é—´æˆ³
    linked_at       TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_used_at    TIMESTAMP WITH TIME ZONE,

    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uq_user_device UNIQUE(user_id, device_id)
);

-- ç´¢å¼•
CREATE INDEX idx_user_devices_user_id ON user_devices(user_id);
CREATE INDEX idx_user_devices_device_id ON user_devices(device_id);
```

**ä¿®è®¢è¯´æ˜**ï¼š

- âŒ ç§»é™¤ `public_key`ã€`fingerprint`ã€`role`ã€`scopes`ã€`token_hash`ï¼ˆè¿™äº›åœ¨ç°æœ‰ device-pairing.ts ä¸­ç®¡ç†ï¼‰
- âœ… ç®€åŒ–ä¸ºçº¯å…³è”è¡¨ï¼Œåªå­˜å‚¨ç”¨æˆ·ä¸è®¾å¤‡çš„ç»‘å®šå…³ç³»
- âœ… æ–°å¢ `is_primary` æ ‡è¯†ä¸»è®¾å¤‡

### 2.4 ç”¨æˆ·ä¼šè¯è¡¨ (user_sessions)

```sql
-- ç”¨æˆ·ç™»å½•ä¼šè¯è¡¨ï¼ˆå­˜å‚¨ Refresh Tokenï¼‰
CREATE TABLE user_sessions (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id             UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- Token ä¿¡æ¯
    refresh_token_hash  VARCHAR(64) NOT NULL,     -- SHA256(refresh_token)

    -- ğŸ†• å…³è”è®¾å¤‡ï¼ˆå¯é€‰ï¼ŒæŒ‡å‘ user_devicesï¼‰
    user_device_id      UUID REFERENCES user_devices(id) ON DELETE SET NULL,

    -- æ¥æºä¿¡æ¯
    ip_address          VARCHAR(45),              -- IPv6 æœ€é•¿ 45 å­—ç¬¦
    user_agent          VARCHAR(500),

    -- æœ‰æ•ˆæœŸ
    expires_at          TIMESTAMP WITH TIME ZONE NOT NULL,
    revoked_at          TIMESTAMP WITH TIME ZONE,
    last_used_at        TIMESTAMP WITH TIME ZONE,

    created_at          TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_token ON user_sessions(refresh_token_hash);
CREATE INDEX idx_user_sessions_expires ON user_sessions(expires_at)
    WHERE revoked_at IS NULL;
```

### 2.5 ç™»å½•å°è¯•è®°å½•è¡¨ (login_attempts) - æ–°å¢

```sql
-- ğŸ†• ç™»å½•å°è¯•è®°å½•è¡¨ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
CREATE TABLE login_attempts (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- ç›®æ ‡ï¼ˆç”¨æˆ·å¯èƒ½ä¸å­˜åœ¨ï¼‰
    user_id         UUID REFERENCES users(id) ON DELETE SET NULL,
    identifier      VARCHAR(255) NOT NULL,        -- æ‰‹æœºå·/é‚®ç®±

    -- å°è¯•ä¿¡æ¯
    ip_address      VARCHAR(45) NOT NULL,
    user_agent      VARCHAR(500),
    success         BOOLEAN NOT NULL,
    failure_reason  VARCHAR(50),                  -- invalid_password | user_not_found | locked

    attempted_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç´¢å¼•ï¼ˆç”¨äºæŸ¥è¯¢è¿‘æœŸå¤±è´¥æ¬¡æ•°ï¼‰
CREATE INDEX idx_login_attempts_user_time
    ON login_attempts(user_id, attempted_at DESC)
    WHERE success = false;

CREATE INDEX idx_login_attempts_ip_time
    ON login_attempts(ip_address, attempted_at DESC);

-- ğŸ†• è‡ªåŠ¨æ¸…ç† 30 å¤©å‰çš„è®°å½•
-- é€šè¿‡å®šæ—¶ä»»åŠ¡æ‰§è¡Œ: DELETE FROM login_attempts WHERE attempted_at < NOW() - INTERVAL '30 days'
```

### 2.6 éªŒè¯ç è¡¨ (verification_codes) - ä¿®è®¢ç‰ˆ

```sql
CREATE TABLE verification_codes (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- ç›®æ ‡
    target          VARCHAR(255) NOT NULL,        -- æ‰‹æœºå·æˆ–é‚®ç®±
    target_type     VARCHAR(20) NOT NULL,         -- phone | email

    -- éªŒè¯ç 
    code            VARCHAR(10) NOT NULL,
    purpose         VARCHAR(20) NOT NULL,         -- register | login | reset_password | bind

    -- çŠ¶æ€
    verified_at     TIMESTAMP WITH TIME ZONE,
    attempts        INTEGER DEFAULT 0,
    max_attempts    INTEGER DEFAULT 5,            -- ğŸ†• æœ€å¤§å°è¯•æ¬¡æ•°

    -- ğŸ†• é˜²æš´åŠ›ç ´è§£
    ip_address      VARCHAR(45),
    user_agent      VARCHAR(500),

    -- æœ‰æ•ˆæœŸ
    expires_at      TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç´¢å¼•ï¼ˆä¼˜åŒ–æ´»è·ƒéªŒè¯ç æŸ¥è¯¢ï¼‰
CREATE INDEX idx_verification_codes_active
    ON verification_codes(target, target_type, purpose)
    WHERE verified_at IS NULL AND expires_at > NOW();

CREATE INDEX idx_verification_codes_expires
    ON verification_codes(expires_at);

-- ğŸ†• é˜²æ­¢åŒä¸€ IP é¢‘ç¹è¯·æ±‚
CREATE INDEX idx_verification_codes_ip
    ON verification_codes(ip_address, created_at DESC);
```

**ä¿®è®¢è¯´æ˜**ï¼š

- âœ… æ–°å¢ `max_attempts` æœ€å¤§å°è¯•æ¬¡æ•°
- âœ… æ–°å¢ `ip_address`ã€`user_agent` è¿½è¸ª
- âœ… ä¼˜åŒ–ç´¢å¼•ï¼Œæ”¯æŒæ´»è·ƒéªŒè¯ç å¿«é€ŸæŸ¥è¯¢

### 2.7 è®¢é˜…è®¡åˆ’è¡¨ (plans)

```sql
CREATE TABLE plans (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- åŸºæœ¬ä¿¡æ¯
    name            VARCHAR(100) NOT NULL,        -- è®¡åˆ’åç§°
    slug            VARCHAR(50) NOT NULL UNIQUE,  -- URL å‹å¥½æ ‡è¯†
    description     TEXT,                         -- æè¿°

    -- ä»·æ ¼
    price           DECIMAL(10, 2) NOT NULL,      -- ä»·æ ¼
    currency        VARCHAR(3) DEFAULT 'CNY',     -- è´§å¸
    period          VARCHAR(20) NOT NULL,         -- monthly | yearly | lifetime

    -- åŠŸèƒ½é…ç½®
    features        JSONB NOT NULL DEFAULT '{}',  -- åŠŸèƒ½ç‰¹æ€§
    limits          JSONB NOT NULL DEFAULT '{}',  -- ä½¿ç”¨é™åˆ¶

    -- çŠ¶æ€
    is_active       BOOLEAN DEFAULT TRUE,
    display_order   INTEGER DEFAULT 0,

    created_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- é¢„ç½®è®¡åˆ’
INSERT INTO plans (name, slug, price, period, features, limits) VALUES
('å…è´¹ç‰ˆ', 'free', 0, 'lifetime',
 '{"basic_skills": true}',
 '{"devices": 1, "skills": 5, "daily_requests": 100}'),
('ä¸“ä¸šç‰ˆ', 'pro', 29.00, 'monthly',
 '{"basic_skills": true, "advanced_skills": true, "priority_support": true}',
 '{"devices": 3, "skills": 50, "daily_requests": 1000}'),
('å›¢é˜Ÿç‰ˆ', 'team', 99.00, 'monthly',
 '{"basic_skills": true, "advanced_skills": true, "team_features": true}',
 '{"devices": 10, "skills": -1, "daily_requests": -1}');
```

### 2.8 æŠ€èƒ½è¡¨ (skills)

```sql
CREATE TABLE skills (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- åŸºæœ¬ä¿¡æ¯
    name            VARCHAR(100) NOT NULL,
    slug            VARCHAR(50) NOT NULL UNIQUE,
    description     TEXT,
    version         VARCHAR(20) NOT NULL,

    -- åˆ†ç±»
    type            VARCHAR(20) NOT NULL,         -- server | local
    category        VARCHAR(50),
    tags            TEXT[] DEFAULT '{}',

    -- ä»·æ ¼ï¼ˆNULL = å…è´¹ï¼‰
    price           DECIMAL(10, 2),
    subscription_only BOOLEAN DEFAULT FALSE,      -- æ˜¯å¦ä»…è®¢é˜…å¯ç”¨

    -- æŠ€èƒ½ä»£ç 
    code_url        VARCHAR(500),
    code_hash       VARCHAR(64),

    -- æƒé™è¦æ±‚
    required_permissions TEXT[] DEFAULT '{}',

    -- ç»Ÿè®¡
    install_count   INTEGER DEFAULT 0,
    rating          DECIMAL(2, 1),                -- 1.0-5.0

    -- çŠ¶æ€
    is_active       BOOLEAN DEFAULT TRUE,
    is_featured     BOOLEAN DEFAULT FALSE,

    created_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_skills_slug ON skills(slug);
CREATE INDEX idx_skills_type ON skills(type);
CREATE INDEX idx_skills_category ON skills(category);
CREATE INDEX idx_skills_tags ON skills USING GIN(tags);
```

### 2.9 ç”¨æˆ·æŠ€èƒ½å…³è”è¡¨ (user_skills) - æ–°å¢

```sql
-- ğŸ†• ç”¨æˆ·å®‰è£…çš„æŠ€èƒ½
CREATE TABLE user_skills (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    skill_id        UUID NOT NULL REFERENCES skills(id) ON DELETE CASCADE,

    -- å®‰è£…ä¿¡æ¯
    installed_at    TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    configuration   JSONB DEFAULT '{}',           -- ç”¨æˆ·è‡ªå®šä¹‰é…ç½®

    -- ç”¨æˆ·åå¥½
    is_favorite     BOOLEAN DEFAULT FALSE,
    usage_count     INTEGER DEFAULT 0,
    last_used_at    TIMESTAMP WITH TIME ZONE,

    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uq_user_skill UNIQUE(user_id, skill_id)
);

-- ç´¢å¼•
CREATE INDEX idx_user_skills_user_id ON user_skills(user_id);
CREATE INDEX idx_user_skills_skill_id ON user_skills(skill_id);
```

### 2.10 è®¢é˜…è¡¨ (subscriptions) - ä¿®è®¢ç‰ˆ

```sql
CREATE TABLE subscriptions (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- è®¢é˜…ç±»å‹ï¼ˆäºŒé€‰ä¸€ï¼‰
    plan_id         UUID REFERENCES plans(id),    -- è®¢é˜…è®¡åˆ’
    skill_id        UUID REFERENCES skills(id),   -- å•ç‹¬è®¢é˜…æŠ€èƒ½

    -- çŠ¶æ€
    status          VARCHAR(20) NOT NULL DEFAULT 'active',
    -- å¯é€‰å€¼: 'active' | 'expired' | 'cancelled' | 'suspended' | 'past_due'

    -- æ—¶é—´
    started_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at      TIMESTAMP WITH TIME ZONE,     -- NULL = æ°¸ä¸è¿‡æœŸ
    cancelled_at    TIMESTAMP WITH TIME ZONE,

    -- ğŸ†• è‡ªåŠ¨ç»­è´¹å¢å¼º
    auto_renew      BOOLEAN DEFAULT TRUE,
    current_period_end TIMESTAMP WITH TIME ZONE,  -- å½“å‰å‘¨æœŸç»“æŸæ—¶é—´
    next_billing_at TIMESTAMP WITH TIME ZONE,     -- ä¸‹æ¬¡æ‰£è´¹æ—¶é—´
    failed_renew_attempts INTEGER DEFAULT 0,      -- ç»­è´¹å¤±è´¥æ¬¡æ•°

    -- æ”¯ä»˜ä¿¡æ¯
    payment_provider VARCHAR(50),                 -- wechat | alipay | stripe
    payment_id      VARCHAR(100),
    amount_paid     DECIMAL(10, 2),

    created_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- çº¦æŸï¼šå¿…é¡»è®¢é˜…è®¡åˆ’æˆ–æŠ€èƒ½ä¹‹ä¸€
    CONSTRAINT chk_subscription_target CHECK (
        (plan_id IS NOT NULL AND skill_id IS NULL) OR
        (plan_id IS NULL AND skill_id IS NOT NULL)
    ),
    -- ğŸ†• æ—¥æœŸçº¦æŸ
    CONSTRAINT chk_dates CHECK (
        cancelled_at IS NULL OR cancelled_at >= started_at
    ),
    CONSTRAINT chk_expires_after_started CHECK (
        expires_at IS NULL OR expires_at > started_at
    )
);

-- ç´¢å¼•
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
CREATE INDEX idx_subscriptions_expires ON subscriptions(expires_at)
    WHERE status = 'active';
-- ğŸ†• è‡ªåŠ¨ç»­è´¹ç´¢å¼•
CREATE INDEX idx_subscriptions_next_billing
    ON subscriptions(next_billing_at)
    WHERE auto_renew = true AND status = 'active';
```

### 2.11 æ”¯ä»˜è®¢å•è¡¨ (payment_orders) - æ–°å¢

```sql
-- ğŸ†• æ”¯ä»˜è®¢å•è¡¨
CREATE TABLE payment_orders (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- è®¢å•ä¿¡æ¯
    order_no        VARCHAR(50) NOT NULL UNIQUE,  -- è®¢å•å·
    order_type      VARCHAR(20) NOT NULL,         -- subscription | skill | recharge

    -- å…³è”
    subscription_id UUID REFERENCES subscriptions(id),
    skill_id        UUID REFERENCES skills(id),
    plan_id         UUID REFERENCES plans(id),

    -- é‡‘é¢
    amount          DECIMAL(10, 2) NOT NULL,
    currency        VARCHAR(3) DEFAULT 'CNY',
    discount_amount DECIMAL(10, 2) DEFAULT 0,
    final_amount    DECIMAL(10, 2) NOT NULL,

    -- ä¼˜æƒ åˆ¸
    coupon_id       UUID,
    coupon_code     VARCHAR(50),

    -- æ”¯ä»˜
    payment_provider VARCHAR(50),                 -- wechat | alipay
    payment_id      VARCHAR(100),                 -- ç¬¬ä¸‰æ–¹æ”¯ä»˜è®¢å•å·
    payment_url     VARCHAR(500),                 -- æ”¯ä»˜é“¾æ¥
    qr_code         TEXT,                         -- æ”¯ä»˜äºŒç»´ç 

    -- çŠ¶æ€
    status          VARCHAR(20) NOT NULL DEFAULT 'pending',
    -- pending | paid | failed | cancelled | refunded
    paid_at         TIMESTAMP WITH TIME ZONE,
    failed_at       TIMESTAMP WITH TIME ZONE,
    failure_reason  TEXT,

    -- æ—¶é—´
    expires_at      TIMESTAMP WITH TIME ZONE,     -- è®¢å•è¿‡æœŸæ—¶é—´
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_payment_orders_user_id ON payment_orders(user_id);
CREATE INDEX idx_payment_orders_order_no ON payment_orders(order_no);
CREATE INDEX idx_payment_orders_status ON payment_orders(status);
```

### 2.12 ä¼˜æƒ åˆ¸è¡¨ (coupon_codes) - æ–°å¢

```sql
-- ğŸ†• ä¼˜æƒ åˆ¸è¡¨
CREATE TABLE coupon_codes (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code            VARCHAR(50) NOT NULL UNIQUE,

    -- ç±»å‹
    type            VARCHAR(20) NOT NULL,         -- percentage | fixed_amount | free_trial
    value           DECIMAL(10, 2) NOT NULL,      -- æŠ˜æ‰£å€¼æˆ–é‡‘é¢

    -- é€‚ç”¨èŒƒå›´
    applicable_to   VARCHAR(20) DEFAULT 'all',    -- all | plans | skills
    applicable_ids  UUID[],                       -- å¦‚æœæœ‰é™åˆ¶ï¼ŒæŒ‡å®šé€‚ç”¨çš„ ID

    -- ä½¿ç”¨é™åˆ¶
    usage_limit     INTEGER,                      -- æ€»ä½¿ç”¨æ¬¡æ•°é™åˆ¶ï¼ˆNULL = æ— é™åˆ¶ï¼‰
    usage_per_user  INTEGER DEFAULT 1,            -- æ¯ä¸ªç”¨æˆ·æœ€å¤šä½¿ç”¨æ¬¡æ•°
    minimum_amount  DECIMAL(10, 2),               -- æœ€å°æ¶ˆè´¹é‡‘é¢

    -- æœ‰æ•ˆæœŸ
    starts_at       TIMESTAMP WITH TIME ZONE NOT NULL,
    expires_at      TIMESTAMP WITH TIME ZONE NOT NULL,

    -- çŠ¶æ€
    is_active       BOOLEAN DEFAULT TRUE,
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    CONSTRAINT chk_valid_period CHECK (starts_at < expires_at),
    CONSTRAINT chk_positive_value CHECK (value > 0)
);

-- ğŸ†• ä¼˜æƒ åˆ¸ä½¿ç”¨è®°å½•
CREATE TABLE coupon_usage (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    coupon_id       UUID NOT NULL REFERENCES coupon_codes(id),
    user_id         UUID NOT NULL REFERENCES users(id),
    order_id        UUID REFERENCES payment_orders(id),
    discount_amount DECIMAL(10, 2),
    applied_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_coupon_usage_coupon_id ON coupon_usage(coupon_id);
CREATE INDEX idx_coupon_usage_user_id ON coupon_usage(user_id);
```

### 2.13 å®¡è®¡æ—¥å¿—è¡¨ (audit_logs)

```sql
-- å®¡è®¡æ—¥å¿—è¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
CREATE TABLE audit_logs (
    id              UUID DEFAULT gen_random_uuid(),

    -- ä¸»ä½“
    user_id         UUID REFERENCES users(id) ON DELETE SET NULL,
    device_id       VARCHAR(100),

    -- æ“ä½œä¿¡æ¯
    action          VARCHAR(50) NOT NULL,         -- æ“ä½œç±»å‹
    resource_type   VARCHAR(50) NOT NULL,         -- èµ„æºç±»å‹
    resource_id     VARCHAR(100),                 -- èµ„æº ID

    -- è¯¦æƒ…
    details         JSONB DEFAULT '{}',

    -- ç»“æœ
    status          VARCHAR(20) NOT NULL,         -- success | failure | denied
    error_message   TEXT,

    -- æ¥æº
    ip_address      VARCHAR(45),
    user_agent      VARCHAR(500),
    request_id      VARCHAR(50),

    -- ğŸ†• é£é™©è¯„ä¼°
    risk_level      VARCHAR(20) DEFAULT 'low',    -- low | medium | high | critical

    -- æ—¶é—´æˆ³
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºåˆ†åŒºï¼ˆæ¯æœˆä¸€ä¸ªåˆ†åŒºï¼‰
CREATE TABLE audit_logs_2026_02 PARTITION OF audit_logs
    FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');

CREATE TABLE audit_logs_2026_03 PARTITION OF audit_logs
    FOR VALUES FROM ('2026-03-01') TO ('2026-04-01');

-- ç´¢å¼•
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
CREATE INDEX idx_audit_logs_risk_level ON audit_logs(risk_level)
    WHERE risk_level IN ('high', 'critical');
```

### 2.14 å¯¼å‡ºè®°å½•è¡¨ (export_logs) - æ–°å¢

```sql
-- ğŸ†• å¯¼å‡ºè®°å½•è¡¨ï¼ˆç”¨äºé¢‘ç‡é™åˆ¶ï¼‰
CREATE TABLE export_logs (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES users(id),
    export_type     VARCHAR(50) NOT NULL,         -- audit_logs | subscription_history
    row_count       INTEGER,
    export_size_bytes INTEGER,
    ip_address      VARCHAR(45),
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_export_logs_user_time
    ON export_logs(user_id, created_at DESC);
```

---

## 3. è®¤è¯æµç¨‹è®¾è®¡

### 3.1 æ”¯æŒçš„è®¤è¯æ–¹å¼

| æ–¹å¼            | è¯´æ˜                   | ä¼˜å…ˆçº§    | Token ç±»å‹   |
| --------------- | ---------------------- | --------- | ------------ |
| æ‰‹æœºå· + éªŒè¯ç  | ä¸»è¦æ–¹å¼ï¼Œä¸­å›½ç”¨æˆ·é¦–é€‰ | P0        | User Token   |
| é‚®ç®± + å¯†ç      | å›½é™…ç”¨æˆ·ã€ä¼ä¸šç”¨æˆ·     | P0        | User Token   |
| å¾®ä¿¡æ‰«ç         | å¿«é€Ÿç™»å½•ï¼Œç¤¾äº¤ç»‘å®š     | P1        | User Token   |
| è®¾å¤‡é…å¯¹        | ç°æœ‰æœºåˆ¶ï¼Œç”¨äºæ“ä½œæˆæƒ | P0 (å¤ç”¨) | Device Token |

### 3.2 æ‰‹æœºå·æ³¨å†Œæµç¨‹ï¼ˆå«é˜²æš´åŠ›ç ´è§£ï¼‰

```
     å®¢æˆ·ç«¯                    Gateway                     æ•°æ®åº“
        â”‚                         â”‚                          â”‚
        â”‚â”€â”€ 1. è¯·æ±‚éªŒè¯ç  â”€â”€â”€â”€â”€â”€â”€â†’â”‚                          â”‚
        â”‚   { phone, purpose:     â”‚                          â”‚
        â”‚     'register' }        â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 2. æ£€æŸ¥ IP é¢‘ç‡é™åˆ¶ â”€â”€â†’â”‚
        â”‚                         â”‚   SELECT COUNT(*) FROM   â”‚
        â”‚                         â”‚   verification_codes     â”‚
        â”‚                         â”‚   WHERE ip = ? AND       â”‚
        â”‚                         â”‚   created_at > NOW()-1h  â”‚
        â”‚                         â”‚â†â”€â”€ count < 10 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 3. æ£€æŸ¥æ‰‹æœºå· â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   SELECT FROM users      â”‚
        â”‚                         â”‚   WHERE phone = ?        â”‚
        â”‚                         â”‚â†â”€â”€ æœªæ³¨å†Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 4. æ£€æŸ¥æ‰‹æœºå·é¢‘ç‡ â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   åŒä¸€æ‰‹æœºå· 60s å†…      â”‚
        â”‚                         â”‚   åªèƒ½è¯·æ±‚ä¸€æ¬¡           â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 5. ç”ŸæˆéªŒè¯ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   INSERT verification_   â”‚
        â”‚                         â”‚   codes (6ä½, 5åˆ†é’Ÿæœ‰æ•ˆ,  â”‚
        â”‚                         â”‚   max_attempts=5)        â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 6. å‘é€çŸ­ä¿¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ [SMSæœåŠ¡]
        â”‚                         â”‚                          â”‚
        â”‚â†â”€â”€ éªŒè¯ç å·²å‘é€ â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚   (éšè—çœŸå®éªŒè¯ç )       â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚â”€â”€ 7. æäº¤æ³¨å†Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                          â”‚
        â”‚   { phone, code,        â”‚                          â”‚
        â”‚     display_name? }     â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 8. éªŒè¯ç æ ¡éªŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   WHERE target=phone     â”‚
        â”‚                         â”‚   AND code=? AND         â”‚
        â”‚                         â”‚   expires_at > NOW() AND â”‚
        â”‚                         â”‚   attempts < max_attemptsâ”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚   [éªŒè¯å¤±è´¥]             â”‚
        â”‚                         â”‚â”€â”€ 8a. å¢åŠ å°è¯•æ¬¡æ•° â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   UPDATE attempts += 1   â”‚
        â”‚â†â”€â”€ éªŒè¯ç é”™è¯¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚   [éªŒè¯æˆåŠŸ]             â”‚
        â”‚                         â”‚â”€â”€ 9. åˆ›å»ºç”¨æˆ· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   INSERT users           â”‚
        â”‚                         â”‚   (is_phone_verified=true)â”‚
        â”‚                         â”‚â†â”€â”€ ç”¨æˆ·åˆ›å»ºæˆåŠŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 10. ç”Ÿæˆ Token â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚   User Access Token (15m)â”‚
        â”‚                         â”‚   Refresh Token (7d)     â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 11. å­˜å‚¨ä¼šè¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   INSERT user_sessions   â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 12. å®¡è®¡æ—¥å¿— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   action: 'user.register'â”‚
        â”‚                         â”‚                          â”‚
        â”‚â†â”€â”€ æ³¨å†ŒæˆåŠŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚   { accessToken,        â”‚                          â”‚
        â”‚     refreshToken,       â”‚                          â”‚
        â”‚     expiresIn,          â”‚                          â”‚
        â”‚     user }              â”‚                          â”‚
```

### 3.3 ç™»å½•æµç¨‹ï¼ˆå«è´¦æˆ·é”å®šï¼‰

```
     å®¢æˆ·ç«¯                    Gateway                     æ•°æ®åº“
        â”‚                         â”‚                          â”‚
        â”‚â”€â”€ 1. ç™»å½•è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                          â”‚
        â”‚   { phone/email,        â”‚                          â”‚
        â”‚     password/code }     â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 2. æŸ¥è¯¢ç”¨æˆ· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚   [ç”¨æˆ·ä¸å­˜åœ¨]           â”‚
        â”‚                         â”‚â”€â”€ 2a. è®°å½•å°è¯• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   INSERT login_attempts  â”‚
        â”‚                         â”‚   (user_id=NULL,         â”‚
        â”‚                         â”‚    success=false)        â”‚
        â”‚â†â”€â”€ ç™»å½•å¤±è´¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚   (ä¸æ³„éœ²ç”¨æˆ·å­˜åœ¨ä¿¡æ¯)   â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â†â”€â”€ ç”¨æˆ·ä¿¡æ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 3. æ£€æŸ¥è´¦æˆ·çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚   status = 'active'?     â”‚
        â”‚                         â”‚   locked_until < NOW()?  â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚   [è´¦æˆ·è¢«é”å®š]           â”‚
        â”‚â†â”€â”€ è´¦æˆ·å·²é”å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚   (æ˜¾ç¤ºå‰©ä½™é”å®šæ—¶é—´)     â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 4. éªŒè¯å‡­æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚   bcrypt.compare() æˆ–    â”‚
        â”‚                         â”‚   éªŒè¯ç æ ¡éªŒ             â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚   [éªŒè¯å¤±è´¥]             â”‚
        â”‚                         â”‚â”€â”€ 5a. è®°å½•å¤±è´¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   INSERT login_attempts  â”‚
        â”‚                         â”‚   (success=false)        â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 5b. æ£€æŸ¥å¤±è´¥æ¬¡æ•° â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   SELECT COUNT(*) FROM   â”‚
        â”‚                         â”‚   login_attempts WHERE   â”‚
        â”‚                         â”‚   user_id=? AND          â”‚
        â”‚                         â”‚   success=false AND      â”‚
        â”‚                         â”‚   attempted_at > -15min  â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚   [>=5æ¬¡å¤±è´¥]            â”‚
        â”‚                         â”‚â”€â”€ 5c. é”å®šè´¦æˆ· â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   UPDATE users SET       â”‚
        â”‚                         â”‚   locked_until = +15min  â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ å®¡è®¡æ—¥å¿— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   action: 'user.login'   â”‚
        â”‚                         â”‚   status: 'failure'      â”‚
        â”‚                         â”‚   risk_level: 'medium'   â”‚
        â”‚â†â”€â”€ ç™»å½•å¤±è´¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚   [éªŒè¯æˆåŠŸ]             â”‚
        â”‚                         â”‚â”€â”€ 6. é‡ç½®å¤±è´¥æ¬¡æ•° â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   UPDATE users SET       â”‚
        â”‚                         â”‚   login_attempts = 0,    â”‚
        â”‚                         â”‚   locked_until = NULL,   â”‚
        â”‚                         â”‚   last_login_at = NOW()  â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 7. æ£€æŸ¥ MFA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚   mfa_enabled = true?    â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚   [éœ€è¦ MFA]             â”‚
        â”‚â†â”€â”€ éœ€è¦äºŒæ¬¡éªŒè¯ â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚   { mfaRequired: true,  â”‚                          â”‚
        â”‚     mfaMethod: 'totp' } â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚â”€â”€ 8. æäº¤ MFA â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                          â”‚
        â”‚   { mfaCode }           â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 9. éªŒè¯ MFA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚   speakeasy.verify()     â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 10. ç”Ÿæˆ Token â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 11. å®¡è®¡æ—¥å¿— â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   action: 'user.login'   â”‚
        â”‚                         â”‚   status: 'success'      â”‚
        â”‚                         â”‚                          â”‚
        â”‚â†â”€â”€ ç™»å½•æˆåŠŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚   { accessToken,        â”‚                          â”‚
        â”‚     refreshToken,       â”‚                          â”‚
        â”‚     user }              â”‚                          â”‚
```

### 3.4 Token è®¾è®¡ï¼ˆä¿®è®¢ç‰ˆï¼‰

#### User Access Token ç»“æ„

```typescript
// User Access Token - ä»…ç”¨äºèº«ä»½éªŒè¯
interface UserAccessTokenPayload {
  sub: string; // ç”¨æˆ· ID
  type: "user"; // Token ç±»å‹
  aud: "openclaw-api"; // å—ä¼—
  iat: number; // ç­¾å‘æ—¶é—´
  exp: number; // è¿‡æœŸæ—¶é—´ (15åˆ†é’Ÿ)
  // âŒ ä¸åŒ…å« role å’Œ scopesï¼ˆè¿™äº›å±äºè®¾å¤‡ï¼‰
}
```

#### Refresh Token è®¾è®¡

```typescript
// Refresh Token - å­˜å‚¨åœ¨æ•°æ®åº“ï¼Œä»…å“ˆå¸Œå€¼
interface RefreshTokenRecord {
  id: string; // UUID
  userId: string; // ç”¨æˆ· ID
  tokenHash: string; // SHA256(token)
  expiresAt: Date; // 7 å¤©æœ‰æ•ˆæœŸ
  revokedAt?: Date; // æ’¤é”€æ—¶é—´
  lastUsedAt?: Date; // æœ€åä½¿ç”¨æ—¶é—´
  ipAddress?: string; // åˆ›å»ºæ—¶çš„ IP
  userAgent?: string; // åˆ›å»ºæ—¶çš„ UA
}

// åˆ·æ–°ç­–ç•¥
const REFRESH_CONFIG = {
  expiresIn: "7d", // 7å¤©æœ‰æ•ˆæœŸ
  rotateThreshold: 2, // å‰©ä½™2å¤©æ—¶è‡ªåŠ¨è½®è½¬
  maxSessionsPerUser: 5, // æ¯ä¸ªç”¨æˆ·æœ€å¤š 5 ä¸ªæ´»è·ƒä¼šè¯
};
```

#### Token ç”Ÿæˆå®ç°

```typescript
// src/assistant/auth/jwt.ts
import jwt from "jsonwebtoken";
import crypto from "crypto";

/**
 * ç”Ÿæˆ User Token å¯¹ï¼ˆAccess + Refreshï¼‰
 */
export async function generateUserTokenPair(
  user: User,
  ctx: GatewayContext,
): Promise<{ accessToken: string; refreshToken: string; expiresIn: number }> {
  // 1. ç”Ÿæˆ Access Token (JWT)
  const accessToken = jwt.sign(
    {
      sub: user.id,
      type: "user",
      aud: "openclaw-api",
    },
    ctx.config.jwtSecret,
    {
      expiresIn: "15m",
      issuer: "openclaw-gateway",
    },
  );

  // 2. ç”Ÿæˆ Refresh Tokenï¼ˆéšæœºå­—ç¬¦ä¸²ï¼‰
  const refreshToken = crypto.randomBytes(32).toString("base64url");
  const refreshTokenHash = crypto.createHash("sha256").update(refreshToken).digest("hex");

  // 3. æ¸…ç†è¿‡æœŸä¼šè¯ï¼Œä¿æŒæœ€å¤š 5 ä¸ªæ´»è·ƒä¼šè¯
  await cleanupUserSessions(user.id, ctx);

  // 4. å­˜å‚¨åˆ°æ•°æ®åº“
  await ctx.db.insert(userSessions).values({
    user_id: user.id,
    refresh_token_hash: refreshTokenHash,
    expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
    ip_address: ctx.req?.ip,
    user_agent: ctx.req?.headers?.["user-agent"],
  });

  return {
    accessToken,
    refreshToken,
    expiresIn: 15 * 60, // ç§’
  };
}

/**
 * æ¸…ç†ç”¨æˆ·è¿‡æœŸä¼šè¯ï¼Œä¿æŒæœ€å¤š N ä¸ªæ´»è·ƒä¼šè¯
 */
async function cleanupUserSessions(userId: string, ctx: GatewayContext) {
  // åˆ é™¤è¿‡æœŸä¼šè¯
  await ctx.db
    .delete(userSessions)
    .where(and(eq(userSessions.user_id, userId), lt(userSessions.expires_at, new Date())));

  // è·å–æ´»è·ƒä¼šè¯æ•°
  const activeSessions = await ctx.db.query.userSessions.findMany({
    where: and(
      eq(userSessions.user_id, userId),
      isNull(userSessions.revoked_at),
      gt(userSessions.expires_at, new Date()),
    ),
    orderBy: [desc(userSessions.created_at)],
  });

  // å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œæ’¤é”€æœ€æ—§çš„ä¼šè¯
  if (activeSessions.length >= REFRESH_CONFIG.maxSessionsPerUser) {
    const toRevoke = activeSessions.slice(REFRESH_CONFIG.maxSessionsPerUser - 1);
    for (const session of toRevoke) {
      await ctx.db
        .update(userSessions)
        .set({ revoked_at: new Date() })
        .where(eq(userSessions.id, session.id));
    }
  }
}
```

### 3.5 è®¾å¤‡ç»‘å®šæµç¨‹ï¼ˆä¸ç°æœ‰ç³»ç»Ÿæ•´åˆï¼‰

```
     Windows å®¢æˆ·ç«¯              Gateway                     æ•°æ®åº“/ç°æœ‰ç³»ç»Ÿ
        â”‚                         â”‚                          â”‚
        â”‚â”€â”€ 1. ç”¨æˆ·å·²ç™»å½• â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚   (æŒæœ‰ User Token)     â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚â”€â”€ 2. è®¾å¤‡é…å¯¹è¯·æ±‚ â”€â”€â”€â”€â”€â†’â”‚                          â”‚
        â”‚   Authorization: Bearer â”‚                          â”‚
        â”‚   X-Device-Id: xxx      â”‚                          â”‚
        â”‚   { publicKey,          â”‚                          â”‚
        â”‚     signature,          â”‚                          â”‚
        â”‚     platform }          â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 3. éªŒè¯ User Token â”€â”€â”€â”€â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 4. éªŒè¯è®¾å¤‡ç­¾å â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚   Ed25519.verify()       â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 5. æ£€æŸ¥è®¾å¤‡é…é¢ â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   SELECT COUNT(*) FROM   â”‚
        â”‚                         â”‚   user_devices WHERE     â”‚
        â”‚                         â”‚   user_id = ?            â”‚
        â”‚                         â”‚â†â”€â”€ è®¾å¤‡æ•°: N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚   [è¶…å‡ºé…é¢]             â”‚
        â”‚â†â”€â”€ é”™è¯¯: è®¾å¤‡å·²è¾¾ä¸Šé™ â”€â”€â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚   [é…é¢å†…]               â”‚
        â”‚                         â”‚â”€â”€ 6. è°ƒç”¨ç°æœ‰é…å¯¹ â”€â”€â”€â”€â”€â”€â”€â†’â”‚ device-pairing.ts
        â”‚                         â”‚   devicePairing.         â”‚
        â”‚                         â”‚     createPairedDevice() â”‚
        â”‚                         â”‚â†â”€â”€ Device Token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 7. åˆ›å»ºå…³è”è®°å½• â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   INSERT user_devices    â”‚
        â”‚                         â”‚   (user_id, device_id)   â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 8. å®¡è®¡æ—¥å¿— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   action: 'device.linked'â”‚
        â”‚                         â”‚                          â”‚
        â”‚â†â”€â”€ ç»‘å®šæˆåŠŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚   { deviceToken,        â”‚                          â”‚
        â”‚     role, scopes }      â”‚                          â”‚
```

**å…³é”®ç‚¹**ï¼š

- è®¾å¤‡é…å¯¹ä»ç„¶ä½¿ç”¨ç°æœ‰çš„ `device-pairing.ts` æœºåˆ¶
- æ–°å¢ `user_devices` è¡¨åªå­˜å‚¨ç”¨æˆ·ä¸è®¾å¤‡çš„å…³è”å…³ç³»
- è®¾å¤‡çš„ roleã€scopesã€token ä»ç”±ç°æœ‰ç³»ç»Ÿç®¡ç†

## 4. è®¢é˜…ä¸æ”¯ä»˜ç³»ç»Ÿ

### 4.1 è®¢é˜…æ¨¡å‹

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    ç”¨æˆ·     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼            â”‚            â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ è®¡åˆ’è®¢é˜…  â”‚        â”‚      â”‚ æŠ€èƒ½è®¢é˜…  â”‚
       â”‚ (Plan)   â”‚        â”‚      â”‚ (Skill)  â”‚
       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
            â”‚              â”‚            â”‚
            â–¼              â”‚            â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ å…è´¹ç‰ˆ   â”‚          â”‚      â”‚ å•ä¸ªæŠ€èƒ½  â”‚
     â”‚ ä¸“ä¸šç‰ˆ   â”‚          â”‚      â”‚ æŒ‰æœˆä»˜è´¹  â”‚
     â”‚ å›¢é˜Ÿç‰ˆ   â”‚          â”‚      â”‚          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚              â”‚            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æƒé™è®¡ç®—   â”‚
                    â”‚  - è®¾å¤‡æ•°é‡ â”‚
                    â”‚  - æŠ€èƒ½è®¿é—® â”‚
                    â”‚  - API é™é¢ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 è®¢é˜…è®¡åˆ’é…ç½®

| è®¡åˆ’   | ä»·æ ¼   | è®¾å¤‡æ•° | æŠ€èƒ½æ•° | æ¯æ—¥è¯·æ±‚ | åŠŸèƒ½               |
| ------ | ------ | ------ | ------ | -------- | ------------------ |
| å…è´¹ç‰ˆ | Â¥0     | 1      | 5      | 100      | åŸºç¡€æŠ€èƒ½           |
| ä¸“ä¸šç‰ˆ | Â¥29/æœˆ | 3      | 50     | 1000     | é«˜çº§æŠ€èƒ½ã€ä¼˜å…ˆæ”¯æŒ |
| å›¢é˜Ÿç‰ˆ | Â¥99/æœˆ | 10     | æ— é™   | æ— é™     | å›¢é˜Ÿåä½œã€API è®¿é—® |

### 4.3 è´­ä¹°è®¢é˜…æµç¨‹ï¼ˆä¿®è®¢ç‰ˆï¼‰

```
     å®¢æˆ·ç«¯                    Gateway                     æ•°æ®åº“/æ”¯ä»˜
        â”‚                         â”‚                          â”‚
        â”‚â”€â”€ 1. è·å–è®¡åˆ’åˆ—è¡¨ â”€â”€â”€â”€â”€â†’â”‚                          â”‚
        â”‚   GET /plans            â”‚                          â”‚
        â”‚                         â”‚â”€â”€ æŸ¥è¯¢è®¡åˆ’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚â†â”€â”€ è®¡åˆ’åˆ—è¡¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚â”€â”€ 2. é€‰æ‹©è®¡åˆ’å¹¶è´­ä¹° â”€â”€â”€â†’â”‚                          â”‚
        â”‚   POST /subscription    â”‚                          â”‚
        â”‚   { planSlug: 'pro',    â”‚                          â”‚
        â”‚     paymentMethod,      â”‚                          â”‚
        â”‚     couponCode? }       â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 3. éªŒè¯ç”¨æˆ· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 4. éªŒè¯ä¼˜æƒ åˆ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   (å¦‚æœæœ‰)               â”‚
        â”‚                         â”‚â†â”€â”€ æŠ˜æ‰£é‡‘é¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 5. åˆ›å»ºæ”¯ä»˜è®¢å• â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   INSERT payment_orders  â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 6. è°ƒç”¨æ”¯ä»˜ç½‘å…³ â”€â”€â”€â”€â”€â”€â”€â†’â”‚ [å¾®ä¿¡/æ”¯ä»˜å®]
        â”‚                         â”‚â†â”€â”€ æ”¯ä»˜é“¾æ¥/äºŒç»´ç  â”€â”€â”€â”€â”€â”€â”‚
        â”‚                         â”‚                          â”‚
        â”‚â†â”€â”€ è¿”å›æ”¯ä»˜ä¿¡æ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚   { orderId,            â”‚                          â”‚
        â”‚     paymentUrl,         â”‚                          â”‚
        â”‚     qrCode }            â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚   [ç”¨æˆ·å®Œæˆæ”¯ä»˜]         â”‚                          â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â†â”€â”€ 7. æ”¯ä»˜å›è°ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ [æ”¯ä»˜ç½‘å…³]
        â”‚                         â”‚   { orderId, status }    â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 8. æ›´æ–°è®¢å•çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   UPDATE payment_orders  â”‚
        â”‚                         â”‚   SET status = 'paid'    â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 9. åˆ›å»ºè®¢é˜…è®°å½• â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   INSERT subscriptions   â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 10. è®°å½•ä¼˜æƒ åˆ¸ä½¿ç”¨ â”€â”€â”€â†’â”‚
        â”‚                         â”‚   INSERT coupon_usage    â”‚
        â”‚                         â”‚                          â”‚
        â”‚                         â”‚â”€â”€ 11. å®¡è®¡æ—¥å¿— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
        â”‚                         â”‚   action: 'subscription. â”‚
        â”‚                         â”‚     created'             â”‚
        â”‚                         â”‚                          â”‚
        â”‚â†â”€â”€ 12. æ¨é€é€šçŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
        â”‚   { subscription }      â”‚                          â”‚
```

### 4.4 è‡ªåŠ¨ç»­è´¹æµç¨‹ï¼ˆæ–°å¢ï¼‰

```typescript
// src/assistant/subscription/auto-renew.ts

/**
 * è‡ªåŠ¨ç»­è´¹å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œï¼‰
 */
export async function processAutoRenewals(ctx: GatewayContext): Promise<void> {
  const log = ctx.logger.child({ task: "auto-renewal" });

  // 1. æŸ¥è¯¢éœ€è¦ç»­è´¹çš„è®¢é˜…
  const toRenew = await ctx.db.query.subscriptions.findMany({
    where: and(
      eq(subscriptions.auto_renew, true),
      eq(subscriptions.status, "active"),
      lte(subscriptions.next_billing_at, new Date()),
      lt(subscriptions.failed_renew_attempts, 3), // æœ€å¤šé‡è¯• 3 æ¬¡
    ),
    with: { user: true, plan: true },
  });

  log.info(`Found ${toRenew.length} subscriptions to renew`);

  for (const subscription of toRenew) {
    try {
      // 2. è·å–ç”¨æˆ·é»˜è®¤æ”¯ä»˜æ–¹å¼
      const paymentMethod = await getDefaultPaymentMethod(subscription.user_id, ctx);

      if (!paymentMethod) {
        log.warn(`User ${subscription.user_id} has no payment method`);
        await markRenewalFailed(subscription.id, "no_payment_method", ctx);
        continue;
      }

      // 3. åˆ›å»ºç»­è´¹è®¢å•
      const order = await createPaymentOrder(
        {
          userId: subscription.user_id,
          orderType: "subscription",
          subscriptionId: subscription.id,
          planId: subscription.plan_id,
          amount: subscription.plan.price,
          paymentProvider: paymentMethod.type,
        },
        ctx,
      );

      // 4. å‘èµ·è‡ªåŠ¨æ‰£æ¬¾
      const result = await initiateAutoCharge(order.id, paymentMethod, ctx);

      if (result.success) {
        // 5. æ›´æ–°è®¢é˜…å‘¨æœŸ
        const nextPeriodEnd = calculateNextPeriodEnd(
          subscription.current_period_end,
          subscription.plan.period,
        );

        await ctx.db
          .update(subscriptions)
          .set({
            current_period_end: nextPeriodEnd,
            next_billing_at: nextPeriodEnd,
            failed_renew_attempts: 0,
            updated_at: new Date(),
          })
          .where(eq(subscriptions.id, subscription.id));

        // 6. å®¡è®¡æ—¥å¿—
        await logAudit(ctx, {
          user_id: subscription.user_id,
          action: "subscription.renewed",
          resource_type: "subscription",
          resource_id: subscription.id,
          status: "success",
        });

        log.info(`Renewed subscription ${subscription.id}`);
      } else {
        await markRenewalFailed(subscription.id, result.reason, ctx);
      }
    } catch (error) {
      log.error(`Failed to renew subscription ${subscription.id}:`, error);
      await markRenewalFailed(subscription.id, "system_error", ctx);
    }
  }
}

/**
 * æ ‡è®°ç»­è´¹å¤±è´¥
 */
async function markRenewalFailed(
  subscriptionId: string,
  reason: string,
  ctx: GatewayContext,
): Promise<void> {
  const subscription = await ctx.db.query.subscriptions.findFirst({
    where: eq(subscriptions.id, subscriptionId),
  });

  const newAttempts = (subscription?.failed_renew_attempts ?? 0) + 1;

  // 3 æ¬¡å¤±è´¥åæš‚åœè®¢é˜…
  if (newAttempts >= 3) {
    await ctx.db
      .update(subscriptions)
      .set({
        status: "past_due",
        auto_renew: false,
        failed_renew_attempts: newAttempts,
        updated_at: new Date(),
      })
      .where(eq(subscriptions.id, subscriptionId));

    // é€šçŸ¥ç”¨æˆ·
    await sendSubscriptionExpiredNotification(subscription?.user_id, ctx);
  } else {
    await ctx.db
      .update(subscriptions)
      .set({
        failed_renew_attempts: newAttempts,
        updated_at: new Date(),
      })
      .where(eq(subscriptions.id, subscriptionId));
  }

  await logAudit(ctx, {
    user_id: subscription?.user_id,
    action: "subscription.renew_failed",
    resource_type: "subscription",
    resource_id: subscriptionId,
    status: "failure",
    details: { reason, attempts: newAttempts },
  });
}
```

### 4.5 ä¼˜æƒ åˆ¸éªŒè¯é€»è¾‘ï¼ˆæ–°å¢ï¼‰

```typescript
// src/assistant/subscription/coupon.ts

/**
 * éªŒè¯å¹¶åº”ç”¨ä¼˜æƒ åˆ¸
 */
export async function validateAndApplyCoupon(
  couponCode: string,
  userId: string,
  planId: string,
  amount: number,
  ctx: GatewayContext,
): Promise<{ valid: boolean; discountAmount: number; message?: string }> {
  // 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸
  const coupon = await ctx.db.query.couponCodes.findFirst({
    where: eq(couponCodes.code, couponCode),
  });

  if (!coupon || !coupon.is_active) {
    return { valid: false, discountAmount: 0, message: "ä¼˜æƒ åˆ¸ä¸å­˜åœ¨æˆ–å·²å¤±æ•ˆ" };
  }

  // 2. æ£€æŸ¥æœ‰æ•ˆæœŸ
  const now = new Date();
  if (coupon.starts_at > now || coupon.expires_at < now) {
    return { valid: false, discountAmount: 0, message: "ä¼˜æƒ åˆ¸å·²è¿‡æœŸ" };
  }

  // 3. æ£€æŸ¥æ€»ä½¿ç”¨æ¬¡æ•°
  if (coupon.usage_limit) {
    const totalUsage = await ctx.db
      .select({ count: count() })
      .from(couponUsage)
      .where(eq(couponUsage.coupon_id, coupon.id));

    if (totalUsage[0].count >= coupon.usage_limit) {
      return { valid: false, discountAmount: 0, message: "ä¼˜æƒ åˆ¸å·²ç”¨å®Œ" };
    }
  }

  // 4. æ£€æŸ¥ç”¨æˆ·ä½¿ç”¨æ¬¡æ•°
  const userUsage = await ctx.db
    .select({ count: count() })
    .from(couponUsage)
    .where(and(eq(couponUsage.coupon_id, coupon.id), eq(couponUsage.user_id, userId)));

  if (userUsage[0].count >= coupon.usage_per_user) {
    return { valid: false, discountAmount: 0, message: "æ‚¨å·²è¾¾åˆ°è¯¥ä¼˜æƒ åˆ¸çš„ä½¿ç”¨æ¬¡æ•°é™åˆ¶" };
  }

  // 5. æ£€æŸ¥é€‚ç”¨èŒƒå›´
  if (coupon.applicable_to === "plans" && coupon.applicable_ids) {
    if (!coupon.applicable_ids.includes(planId)) {
      return { valid: false, discountAmount: 0, message: "è¯¥ä¼˜æƒ åˆ¸ä¸é€‚ç”¨äºæ­¤è®¡åˆ’" };
    }
  }

  // 6. æ£€æŸ¥æœ€å°æ¶ˆè´¹
  if (coupon.minimum_amount && amount < Number(coupon.minimum_amount)) {
    return {
      valid: false,
      discountAmount: 0,
      message: `æœ€å°æ¶ˆè´¹ Â¥${coupon.minimum_amount} æ‰èƒ½ä½¿ç”¨æ­¤ä¼˜æƒ åˆ¸`,
    };
  }

  // 7. è®¡ç®—æŠ˜æ‰£
  let discountAmount = 0;
  if (coupon.type === "percentage") {
    discountAmount = amount * (Number(coupon.value) / 100);
  } else if (coupon.type === "fixed_amount") {
    discountAmount = Math.min(Number(coupon.value), amount);
  }

  return { valid: true, discountAmount: Math.round(discountAmount * 100) / 100 };
}
```

### 4.6 è®¢é˜… RPC æ–¹æ³•ï¼ˆä¿®è®¢ç‰ˆï¼‰

```typescript
// src/gateway/server-methods/assistant-subscription.ts
import { z } from "zod";

// å‚æ•°éªŒè¯ Schema
const CreateSubscriptionParams = z.object({
  planSlug: z.string().min(1).max(50),
  paymentMethod: z.enum(["wechat", "alipay"]),
  couponCode: z.string().max(50).optional(),
});

const CancelSubscriptionParams = z.object({
  subscriptionId: z.string().uuid(),
});

export const subscriptionMethods = {
  /**
   * è·å–å¯ç”¨è®¡åˆ’åˆ—è¡¨
   */
  "subscription.plans.list": async ({ respond }, ctx) => {
    const planList = await ctx.db.query.plans.findMany({
      where: eq(plans.is_active, true),
      orderBy: [asc(plans.display_order)],
    });
    respond(true, planList, undefined);
  },

  /**
   * è·å–ç”¨æˆ·è®¢é˜…çŠ¶æ€
   */
  "subscription.status": async ({ respond }, ctx) => {
    requireAuth(ctx);

    const [plan, userSubscriptions, usage] = await Promise.all([
      getUserActivePlan(ctx.user.id, ctx),
      getUserSubscriptions(ctx.user.id, ctx),
      getUserUsageStats(ctx.user.id, ctx),
    ]);

    respond(true, { plan, subscriptions: userSubscriptions, usage }, undefined);
  },

  /**
   * åˆ›å»ºè®¢é˜…
   */
  "subscription.create": async ({ params, respond }, ctx) => {
    requireAuth(ctx);

    // å‚æ•°éªŒè¯
    const validated = CreateSubscriptionParams.parse(params);

    // å…è´¹è®¡åˆ’ç›´æ¥æ¿€æ´»
    if (validated.planSlug === "free") {
      const result = await activateFreePlan(ctx.user.id, ctx);
      respond(true, result, undefined);
      return;
    }

    // è·å–è®¡åˆ’
    const plan = await ctx.db.query.plans.findFirst({
      where: eq(plans.slug, validated.planSlug),
    });

    if (!plan) {
      respond(false, undefined, errorShape(ErrorCodes.NOT_FOUND, "è®¡åˆ’ä¸å­˜åœ¨"));
      return;
    }

    // éªŒè¯ä¼˜æƒ åˆ¸
    let discountAmount = 0;
    if (validated.couponCode) {
      const couponResult = await validateAndApplyCoupon(
        validated.couponCode,
        ctx.user.id,
        plan.id,
        Number(plan.price),
        ctx,
      );
      if (!couponResult.valid) {
        respond(false, undefined, errorShape(ErrorCodes.INVALID_REQUEST, couponResult.message));
        return;
      }
      discountAmount = couponResult.discountAmount;
    }

    // åˆ›å»ºæ”¯ä»˜è®¢å•
    const order = await createPaymentOrder(
      {
        userId: ctx.user.id,
        orderType: "subscription",
        planId: plan.id,
        amount: Number(plan.price),
        discountAmount,
        finalAmount: Number(plan.price) - discountAmount,
        couponCode: validated.couponCode,
        paymentProvider: validated.paymentMethod,
      },
      ctx,
    );

    respond(
      true,
      {
        orderId: order.id,
        orderNo: order.order_no,
        amount: order.final_amount,
        paymentUrl: order.payment_url,
        qrCode: order.qr_code,
      },
      undefined,
    );
  },

  /**
   * å–æ¶ˆè®¢é˜…
   */
  "subscription.cancel": async ({ params, respond }, ctx) => {
    requireAuth(ctx);

    const validated = CancelSubscriptionParams.parse(params);

    // æŸ¥è¯¢è®¢é˜…
    const subscription = await ctx.db.query.subscriptions.findFirst({
      where: and(
        eq(subscriptions.id, validated.subscriptionId),
        eq(subscriptions.user_id, ctx.user.id),
      ),
    });

    if (!subscription) {
      respond(false, undefined, errorShape(ErrorCodes.NOT_FOUND, "è®¢é˜…ä¸å­˜åœ¨"));
      return;
    }

    if (subscription.status !== "active") {
      respond(false, undefined, errorShape(ErrorCodes.INVALID_REQUEST, "è®¢é˜…å·²å–æ¶ˆæˆ–å·²è¿‡æœŸ"));
      return;
    }

    // å–æ¶ˆè‡ªåŠ¨ç»­è´¹ï¼ˆä¿ç•™åˆ°æœŸå‰çš„ä½¿ç”¨æƒé™ï¼‰
    await ctx.db
      .update(subscriptions)
      .set({
        auto_renew: false,
        cancelled_at: new Date(),
        updated_at: new Date(),
      })
      .where(eq(subscriptions.id, validated.subscriptionId));

    await logAudit(ctx, {
      user_id: ctx.user.id,
      action: "subscription.cancelled",
      resource_type: "subscription",
      resource_id: validated.subscriptionId,
      status: "success",
    });

    respond(true, { success: true, expiresAt: subscription.expires_at }, undefined);
  },
};
```

---

## 5. å®¡è®¡æ—¥å¿—ç³»ç»Ÿ

### 5.1 å®¡è®¡äº‹ä»¶åˆ†ç±»

| ç±»åˆ«     | äº‹ä»¶                   | æè¿°         | é£é™©çº§åˆ« |
| -------- | ---------------------- | ------------ | -------- |
| **ç”¨æˆ·** | user.register          | ç”¨æˆ·æ³¨å†Œ     | low      |
|          | user.login             | ç”¨æˆ·ç™»å½•     | low      |
|          | user.login_failed      | ç™»å½•å¤±è´¥     | medium   |
|          | user.logout            | ç”¨æˆ·ç™»å‡º     | low      |
|          | user.password_change   | ä¿®æ”¹å¯†ç      | medium   |
|          | user.mfa_enabled       | å¯ç”¨ MFA     | low      |
|          | user.mfa_disabled      | ç¦ç”¨ MFA     | high     |
|          | user.profile_update    | æ›´æ–°èµ„æ–™     | low      |
| **è®¾å¤‡** | device.linked          | è®¾å¤‡ç»‘å®š     | low      |
|          | device.unlinked        | è®¾å¤‡è§£ç»‘     | medium   |
|          | device.token_refresh   | Token åˆ·æ–°   | low      |
| **æŠ€èƒ½** | skill.execute          | æŠ€èƒ½æ‰§è¡Œ     | low      |
|          | skill.access_denied    | æƒé™æ‹’ç»     | medium   |
|          | skill.error            | æ‰§è¡Œé”™è¯¯     | medium   |
| **æ–‡ä»¶** | file.read              | æ–‡ä»¶è¯»å–     | low      |
|          | file.write             | æ–‡ä»¶å†™å…¥     | medium   |
|          | file.delete            | æ–‡ä»¶åˆ é™¤     | high     |
| **ç³»ç»Ÿ** | system.command         | ç³»ç»Ÿå‘½ä»¤     | high     |
|          | process.kill           | ç»“æŸè¿›ç¨‹     | critical |
| **è®¢é˜…** | subscription.created   | åˆ›å»ºè®¢é˜…     | low      |
|          | subscription.cancelled | å–æ¶ˆè®¢é˜…     | low      |
|          | subscription.expired   | è®¢é˜…è¿‡æœŸ     | low      |
|          | subscription.renewed   | è®¢é˜…ç»­è´¹     | low      |
| **æ”¯ä»˜** | payment.created        | åˆ›å»ºè®¢å•     | low      |
|          | payment.completed      | æ”¯ä»˜æˆåŠŸ     | low      |
|          | payment.failed         | æ”¯ä»˜å¤±è´¥     | medium   |
|          | payment.refunded       | é€€æ¬¾         | high     |
| **å¯¼å‡º** | export.audit_logs      | å¯¼å‡ºå®¡è®¡æ—¥å¿— | medium   |

### 5.2 å®¡è®¡æœåŠ¡å®ç°

```typescript
// src/assistant/audit/service.ts

export interface AuditLogInput {
  user_id?: string;
  device_id?: string;
  action: string;
  resource_type: string;
  resource_id?: string;
  details?: Record<string, unknown>;
  status: "success" | "failure" | "denied";
  error_message?: string;
  risk_level?: "low" | "medium" | "high" | "critical";
}

// é£é™©çº§åˆ«æ˜ å°„
const ACTION_RISK_LEVELS: Record<string, AuditLogInput["risk_level"]> = {
  "user.login_failed": "medium",
  "user.mfa_disabled": "high",
  "device.unlinked": "medium",
  "file.delete": "high",
  "system.command": "high",
  "process.kill": "critical",
  "payment.refunded": "high",
};

/**
 * è®°å½•å®¡è®¡æ—¥å¿—
 */
export async function logAudit(ctx: GatewayContext, log: AuditLogInput): Promise<void> {
  // è‡ªåŠ¨æ¨æ–­é£é™©çº§åˆ«
  const riskLevel = log.risk_level ?? ACTION_RISK_LEVELS[log.action] ?? "low";

  try {
    await ctx.db.insert(auditLogs).values({
      ...log,
      risk_level: riskLevel,
      ip_address: ctx.req?.ip,
      user_agent: ctx.req?.headers?.["user-agent"],
      request_id: ctx.requestId,
      created_at: new Date(),
    });

    // é«˜é£é™©æ“ä½œå‘é€å‘Šè­¦
    if (riskLevel === "critical" || riskLevel === "high") {
      await sendSecurityAlert(log, ctx);
    }
  } catch (error) {
    // å®¡è®¡æ—¥å¿—å†™å…¥å¤±è´¥ä¸åº”å½±å“ä¸»æµç¨‹
    ctx.logger.error("[Audit] Failed to write:", error);
  }
}

/**
 * æŸ¥è¯¢å®¡è®¡æ—¥å¿—ï¼ˆå¸¦åˆ†é¡µï¼‰
 */
export async function queryAuditLogs(
  params: {
    userId?: string;
    deviceId?: string;
    action?: string;
    riskLevel?: string;
    startTime?: Date;
    endTime?: Date;
    limit?: number;
    offset?: number;
  },
  ctx: GatewayContext,
): Promise<{ logs: AuditLog[]; total: number; hasMore: boolean }> {
  const conditions: SQL[] = [];

  if (params.userId) {
    conditions.push(eq(auditLogs.user_id, params.userId));
  }
  if (params.deviceId) {
    conditions.push(eq(auditLogs.device_id, params.deviceId));
  }
  if (params.action) {
    conditions.push(eq(auditLogs.action, params.action));
  }
  if (params.riskLevel) {
    conditions.push(eq(auditLogs.risk_level, params.riskLevel));
  }
  if (params.startTime) {
    conditions.push(gte(auditLogs.created_at, params.startTime));
  }
  if (params.endTime) {
    conditions.push(lte(auditLogs.created_at, params.endTime));
  }

  const whereClause = conditions.length > 0 ? and(...conditions) : undefined;
  const limit = Math.min(params.limit ?? 50, 100);
  const offset = params.offset ?? 0;

  const [logs, countResult] = await Promise.all([
    ctx.db.query.auditLogs.findMany({
      where: whereClause,
      orderBy: [desc(auditLogs.created_at)],
      limit: limit + 1, // å¤šæŸ¥ä¸€æ¡åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤š
      offset,
    }),
    ctx.db.select({ count: count() }).from(auditLogs).where(whereClause),
  ]);

  const hasMore = logs.length > limit;
  if (hasMore) logs.pop();

  return {
    logs,
    total: countResult[0].count,
    hasMore,
  };
}

/**
 * å¯¼å‡ºå®¡è®¡æ—¥å¿—ï¼ˆå¸¦é¢‘ç‡é™åˆ¶ï¼‰
 */
export async function exportAuditLogs(
  userId: string,
  startTime: Date,
  endTime: Date,
  ctx: GatewayContext,
): Promise<{ data: string; format: "csv" }> {
  // 1. æ£€æŸ¥å¯¼å‡ºé¢‘ç‡é™åˆ¶
  const oneHourAgo = new Date(Date.now() - 3600000);
  const recentExports = await ctx.db
    .select({ count: count() })
    .from(exportLogs)
    .where(and(eq(exportLogs.user_id, userId), gte(exportLogs.created_at, oneHourAgo)));

  if (recentExports[0].count >= 3) {
    throw new Error("å¯¼å‡ºé¢‘ç‡è¶…é™ï¼Œæ¯å°æ—¶æœ€å¤šå¯¼å‡º 3 æ¬¡");
  }

  // 2. é™åˆ¶å¯¼å‡ºèŒƒå›´
  const days = (endTime.getTime() - startTime.getTime()) / (24 * 60 * 60 * 1000);
  if (days > 90) {
    throw new Error("å¯¼å‡ºèŒƒå›´ä¸èƒ½è¶…è¿‡ 90 å¤©");
  }

  // 3. æŸ¥è¯¢æ—¥å¿—
  const logs = await ctx.db.query.auditLogs.findMany({
    where: and(
      eq(auditLogs.user_id, userId),
      gte(auditLogs.created_at, startTime),
      lte(auditLogs.created_at, endTime),
    ),
    orderBy: [asc(auditLogs.created_at)],
    limit: 10000,
  });

  // 4. ç”Ÿæˆ CSV
  const headers = ["Time", "Action", "Resource", "Status", "Risk", "IP", "Details"];
  const rows = logs.map((log) => [
    log.created_at.toISOString(),
    log.action,
    `${log.resource_type}:${log.resource_id || ""}`,
    log.status,
    log.risk_level,
    log.ip_address || "",
    JSON.stringify(log.details || {}),
  ]);

  const csv = [
    headers.join(","),
    ...rows.map((row) => row.map((cell) => `"${String(cell).replace(/"/g, '""')}"`).join(",")),
  ].join("\n");

  // 5. è®°å½•å¯¼å‡º
  await ctx.db.insert(exportLogs).values({
    user_id: userId,
    export_type: "audit_logs",
    row_count: logs.length,
    export_size_bytes: Buffer.byteLength(csv, "utf8"),
    ip_address: ctx.req?.ip,
  });

  await logAudit(ctx, {
    user_id: userId,
    action: "export.audit_logs",
    resource_type: "audit_logs",
    details: { rowCount: logs.length, startTime, endTime },
    status: "success",
    risk_level: "medium",
  });

  return { data: csv, format: "csv" };
}
```

---

## 6. è®¤è¯æœºåˆ¶æ•´åˆ

### 6.1 ç»Ÿä¸€è®¤è¯æ¶æ„ï¼ˆä¿®è®¢ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          è®¤è¯å±‚çº§æ¶æ„ï¼ˆä¿®è®¢ç‰ˆï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  å®¢æˆ·ç«¯è¯·æ±‚  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                â–¼                â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ User JWT â”‚     â”‚ Device   â”‚     â”‚ Gateway  â”‚
             â”‚ (èº«ä»½)   â”‚     â”‚ Token    â”‚     â”‚ Token    â”‚
             â”‚          â”‚     â”‚ (æƒé™)   â”‚     â”‚ (ç®¡ç†)   â”‚
             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                  â”‚                â”‚                â”‚
                  â”‚    èŒè´£åˆ†ç¦»    â”‚                â”‚
                  â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                â”‚
                  â”‚    ç”¨æˆ·â‰ è®¾å¤‡   â”‚                â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  ç»Ÿä¸€è®¤è¯   â”‚
                            â”‚  ä¸­é—´ä»¶     â”‚
                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼              â–¼              â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ ç”¨æˆ·ä¸Šä¸‹æ–‡â”‚   â”‚ è®¾å¤‡ä¸Šä¸‹æ–‡â”‚   â”‚ æƒé™éªŒè¯ â”‚
             â”‚ (å¯é€‰)   â”‚   â”‚ (ä¸»è¦)   â”‚   â”‚ (è®¾å¤‡)  â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶ï¼ˆä¿®è®¢ç‰ˆï¼‰

```typescript
// src/gateway/middleware/auth.ts

export interface AuthContext {
  // ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œæ¥è‡ª User JWTï¼‰
  user?: {
    id: string;
    displayName: string;
    status: string;
  };

  // è®¾å¤‡ä¿¡æ¯ï¼ˆæ¥è‡ª Device Token æˆ–ç°æœ‰ç³»ç»Ÿï¼‰
  device?: {
    deviceId: string;
    platform: string;
    role: string;
    scopes: string[];
  };

  // è®¤è¯æ–¹å¼
  authMethod: "user_jwt" | "device" | "gateway" | "tailscale" | "none";

  // æœ‰æ•ˆæƒé™ï¼ˆæ¥è‡ªè®¾å¤‡ï¼Œè€Œéç”¨æˆ·ï¼‰
  role: string;
  scopes: string[];
}

/**
 * ç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶
 */
export async function authenticateRequest(
  req: GatewayRequest,
  ctx: GatewayContext,
): Promise<AuthContext> {
  const authHeader = req.headers?.authorization;
  const deviceId = req.headers?.["x-device-id"];
  const deviceToken = req.headers?.["x-device-token"];

  let authContext: AuthContext = {
    authMethod: "none",
    role: "anonymous",
    scopes: [],
  };

  // 1. å°è¯• Device Token è®¤è¯ï¼ˆä¸»è¦è®¤è¯æ–¹å¼ï¼‰
  if (deviceId && deviceToken) {
    const device = await verifyDeviceToken(deviceId, deviceToken, ctx);
    if (device) {
      authContext = {
        device,
        authMethod: "device",
        role: device.role,
        scopes: device.scopes,
      };
    }
  }

  // 2. å°è¯• User JWT è®¤è¯ï¼ˆå¯é€‰ï¼Œç”¨äºèº«ä»½è¯†åˆ«ï¼‰
  if (authHeader?.startsWith("Bearer ")) {
    const token = authHeader.slice(7);

    // å…ˆå°è¯•è§£æä¸º User JWT
    const jwtPayload = await verifyUserAccessToken(token, ctx);
    if (jwtPayload) {
      const user = await ctx.db.query.users.findFirst({
        where: and(eq(users.id, jwtPayload.sub), eq(users.status, "active")),
      });

      if (user) {
        authContext.user = {
          id: user.id,
          displayName: user.display_name,
          status: user.status,
        };

        // å¦‚æœæ²¡æœ‰è®¾å¤‡è®¤è¯ï¼Œåˆ™ä½¿ç”¨ User JWT ä½œä¸ºä¸»è¦è®¤è¯
        if (authContext.authMethod === "none") {
          authContext.authMethod = "user_jwt";
          // æ³¨æ„ï¼šUser JWT ä¸æä¾› role/scopesï¼Œéœ€è¦è®¾å¤‡è®¤è¯
        }
      }
    } else {
      // å°è¯• Gateway Tokenï¼ˆç°æœ‰æœºåˆ¶ï¼‰
      const gatewayAuth = await authorizeGatewayConnect({ auth: { token } });
      if (gatewayAuth.ok) {
        authContext = {
          authMethod: "gateway",
          role: "operator",
          scopes: ["operator.admin"],
        };
      }
    }
  }

  // 3. å°è¯• Tailscale è®¤è¯ï¼ˆç°æœ‰æœºåˆ¶ï¼‰
  if (authContext.authMethod === "none" && ctx.config.gateway.auth.allowTailscale) {
    const tailscaleResult = await authorizeTailscale(req);
    if (tailscaleResult.ok) {
      authContext = {
        authMethod: "tailscale",
        role: "operator",
        scopes: ["operator.read", "operator.write"],
      };
    }
  }

  return authContext;
}

/**
 * è¦æ±‚ç”¨æˆ·è®¤è¯
 */
export function requireUser(ctx: GatewayContext): void {
  if (!ctx.auth?.user) {
    throw new AuthError("User authentication required", "USER_AUTH_REQUIRED");
  }
}

/**
 * è¦æ±‚è®¾å¤‡è®¤è¯
 */
export function requireDevice(ctx: GatewayContext): void {
  if (!ctx.auth?.device) {
    throw new AuthError("Device authentication required", "DEVICE_AUTH_REQUIRED");
  }
}

/**
 * è¦æ±‚ç‰¹å®šæƒé™ï¼ˆæ¥è‡ªè®¾å¤‡ï¼‰
 */
export function requireScope(ctx: GatewayContext, scope: string): void {
  const hasScope =
    ctx.auth?.scopes?.includes(scope) || ctx.auth?.scopes?.includes("operator.admin");
  if (!hasScope) {
    throw new AuthError(`Missing required scope: ${scope}`, "SCOPE_REQUIRED");
  }
}

/**
 * è¦æ±‚ç”¨æˆ·å’Œè®¾å¤‡éƒ½è®¤è¯
 */
export function requireUserAndDevice(ctx: GatewayContext): void {
  requireUser(ctx);
  requireDevice(ctx);
}
```

### 6.3 RPC æ–¹æ³•æƒé™é…ç½®

```typescript
// src/gateway/server-methods.ts

// æ–¹æ³•æƒé™æ˜ å°„
export const METHOD_AUTH: Record<
  string,
  {
    requireUser?: boolean;
    requireDevice?: boolean;
    scopes?: string[];
    public?: boolean;
  }
> = {
  // ========== å…¬å¼€æ–¹æ³•ï¼ˆæ— éœ€è®¤è¯ï¼‰==========
  "auth.sendCode": { public: true },
  "auth.register.phone": { public: true },
  "auth.login.phone": { public: true },
  "auth.login.email": { public: true },
  "auth.refresh": { public: true },
  "subscription.plans.list": { public: true },

  // ========== éœ€è¦ç”¨æˆ·è®¤è¯ ==========
  "auth.me": { requireUser: true },
  "auth.logout": { requireUser: true },
  "auth.updateProfile": { requireUser: true },
  "auth.changePassword": { requireUser: true },
  "auth.setupMfa": { requireUser: true },
  "device.list": { requireUser: true },
  "device.link": { requireUser: true },
  "subscription.status": { requireUser: true },
  "subscription.create": { requireUser: true },
  "subscription.cancel": { requireUser: true },
  "audit.query": { requireUser: true },

  // ========== éœ€è¦è®¾å¤‡è®¤è¯ ==========
  "assistant.fileList": { requireDevice: true, scopes: ["operator.read"] },
  "assistant.fileRead": { requireDevice: true, scopes: ["operator.read"] },
  "assistant.fileWrite": { requireDevice: true, scopes: ["operator.write"] },
  "assistant.skillExecute": { requireDevice: true, scopes: ["operator.write"] },
  "assistant.systemInfo": { requireDevice: true, scopes: ["operator.read"] },

  // ========== éœ€è¦ç”¨æˆ· + è®¾å¤‡è®¤è¯ ==========
  "assistant.sensitiveOperation": {
    requireUser: true,
    requireDevice: true,
    scopes: ["operator.admin"],
  },

  // ========== ç®¡ç†å‘˜æƒé™ ==========
  "device.unlink": { requireUser: true, scopes: ["operator.admin"] },
  "audit.export": { requireUser: true, scopes: ["operator.admin"] },
  "admin.users.list": { requireUser: true, scopes: ["admin"] },
  "admin.subscriptions.list": { requireUser: true, scopes: ["admin"] },
};
```

---

## 7. Drizzle ORM Schemaï¼ˆä¿®è®¢ç‰ˆï¼‰

```typescript
// src/db/schema/index.ts

import {
  pgTable,
  uuid,
  varchar,
  text,
  boolean,
  timestamp,
  decimal,
  integer,
  jsonb,
  primaryKey,
} from "drizzle-orm/pg-core";
import { relations } from "drizzle-orm";

// ===== ç”¨æˆ·è¡¨ =====
export const users = pgTable("users", {
  id: uuid("id").primaryKey().defaultRandom(),

  // è®¤è¯ä¿¡æ¯
  phone: varchar("phone", { length: 20 }).unique(),
  email: varchar("email", { length: 255 }).unique(),
  password_hash: varchar("password_hash", { length: 255 }),
  wechat_openid: varchar("wechat_openid", { length: 100 }).unique(),
  wechat_unionid: varchar("wechat_unionid", { length: 100 }),

  // ç”¨æˆ·èµ„æ–™
  display_name: varchar("display_name", { length: 100 }).notNull(),
  avatar_url: varchar("avatar_url", { length: 500 }),

  // éªŒè¯çŠ¶æ€
  is_phone_verified: boolean("is_phone_verified").default(false),
  is_email_verified: boolean("is_email_verified").default(false),

  // å›½é™…åŒ–
  timezone: varchar("timezone", { length: 50 }).default("Asia/Shanghai"),
  locale: varchar("locale", { length: 10 }).default("zh-CN"),

  // è´¦æˆ·çŠ¶æ€
  status: varchar("status", { length: 20 }).notNull().default("active"),
  account_type: varchar("account_type", { length: 20 }).default("personal"),

  // MFA
  mfa_enabled: boolean("mfa_enabled").default(false),
  mfa_method: varchar("mfa_method", { length: 20 }),
  mfa_secret: varchar("mfa_secret", { length: 255 }),
  mfa_backup_codes: text("mfa_backup_codes").array(),

  // å®‰å…¨
  login_attempts: integer("login_attempts").default(0),
  locked_until: timestamp("locked_until", { withTimezone: true }),
  password_changed_at: timestamp("password_changed_at", { withTimezone: true }),

  // æ—¶é—´æˆ³
  created_at: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updated_at: timestamp("updated_at", { withTimezone: true }).defaultNow(),
  last_login_at: timestamp("last_login_at", { withTimezone: true }),
  deleted_at: timestamp("deleted_at", { withTimezone: true }),
});

// ===== ç”¨æˆ·è®¾å¤‡å…³è”è¡¨ =====
export const userDevices = pgTable("user_devices", {
  id: uuid("id").primaryKey().defaultRandom(),
  user_id: uuid("user_id")
    .notNull()
    .references(() => users.id, { onDelete: "cascade" }),
  device_id: varchar("device_id", { length: 100 }).notNull(),
  display_name: varchar("display_name", { length: 100 }),
  is_primary: boolean("is_primary").default(false),
  linked_at: timestamp("linked_at", { withTimezone: true }).defaultNow(),
  last_used_at: timestamp("last_used_at", { withTimezone: true }),
});

// ===== ç”¨æˆ·ä¼šè¯è¡¨ =====
export const userSessions = pgTable("user_sessions", {
  id: uuid("id").primaryKey().defaultRandom(),
  user_id: uuid("user_id")
    .notNull()
    .references(() => users.id, { onDelete: "cascade" }),
  refresh_token_hash: varchar("refresh_token_hash", { length: 64 }).notNull(),
  user_device_id: uuid("user_device_id").references(() => userDevices.id, { onDelete: "set null" }),
  ip_address: varchar("ip_address", { length: 45 }),
  user_agent: varchar("user_agent", { length: 500 }),
  expires_at: timestamp("expires_at", { withTimezone: true }).notNull(),
  revoked_at: timestamp("revoked_at", { withTimezone: true }),
  last_used_at: timestamp("last_used_at", { withTimezone: true }),
  created_at: timestamp("created_at", { withTimezone: true }).defaultNow(),
});

// ===== ç™»å½•å°è¯•è¡¨ =====
export const loginAttempts = pgTable("login_attempts", {
  id: uuid("id").primaryKey().defaultRandom(),
  user_id: uuid("user_id").references(() => users.id, { onDelete: "set null" }),
  identifier: varchar("identifier", { length: 255 }).notNull(),
  ip_address: varchar("ip_address", { length: 45 }).notNull(),
  user_agent: varchar("user_agent", { length: 500 }),
  success: boolean("success").notNull(),
  failure_reason: varchar("failure_reason", { length: 50 }),
  attempted_at: timestamp("attempted_at", { withTimezone: true }).defaultNow(),
});

// ===== éªŒè¯ç è¡¨ =====
export const verificationCodes = pgTable("verification_codes", {
  id: uuid("id").primaryKey().defaultRandom(),
  target: varchar("target", { length: 255 }).notNull(),
  target_type: varchar("target_type", { length: 20 }).notNull(),
  code: varchar("code", { length: 10 }).notNull(),
  purpose: varchar("purpose", { length: 20 }).notNull(),
  verified_at: timestamp("verified_at", { withTimezone: true }),
  attempts: integer("attempts").default(0),
  max_attempts: integer("max_attempts").default(5),
  ip_address: varchar("ip_address", { length: 45 }),
  user_agent: varchar("user_agent", { length: 500 }),
  expires_at: timestamp("expires_at", { withTimezone: true }).notNull(),
  created_at: timestamp("created_at", { withTimezone: true }).defaultNow(),
});

// ===== è®¡åˆ’è¡¨ =====
export const plans = pgTable("plans", {
  id: uuid("id").primaryKey().defaultRandom(),
  name: varchar("name", { length: 100 }).notNull(),
  slug: varchar("slug", { length: 50 }).notNull().unique(),
  description: text("description"),
  price: decimal("price", { precision: 10, scale: 2 }).notNull(),
  currency: varchar("currency", { length: 3 }).default("CNY"),
  period: varchar("period", { length: 20 }).notNull(),
  features: jsonb("features").notNull().default({}),
  limits: jsonb("limits").notNull().default({}),
  is_active: boolean("is_active").default(true),
  display_order: integer("display_order").default(0),
  created_at: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updated_at: timestamp("updated_at", { withTimezone: true }).defaultNow(),
});

// ===== æŠ€èƒ½è¡¨ =====
export const skills = pgTable("skills", {
  id: uuid("id").primaryKey().defaultRandom(),
  name: varchar("name", { length: 100 }).notNull(),
  slug: varchar("slug", { length: 50 }).notNull().unique(),
  description: text("description"),
  version: varchar("version", { length: 20 }).notNull(),
  type: varchar("type", { length: 20 }).notNull(),
  category: varchar("category", { length: 50 }),
  tags: text("tags").array().default([]),
  price: decimal("price", { precision: 10, scale: 2 }),
  subscription_only: boolean("subscription_only").default(false),
  code_url: varchar("code_url", { length: 500 }),
  code_hash: varchar("code_hash", { length: 64 }),
  required_permissions: text("required_permissions").array().default([]),
  install_count: integer("install_count").default(0),
  rating: decimal("rating", { precision: 2, scale: 1 }),
  is_active: boolean("is_active").default(true),
  is_featured: boolean("is_featured").default(false),
  created_at: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updated_at: timestamp("updated_at", { withTimezone: true }).defaultNow(),
});

// ===== ç”¨æˆ·æŠ€èƒ½å…³è”è¡¨ =====
export const userSkills = pgTable("user_skills", {
  id: uuid("id").primaryKey().defaultRandom(),
  user_id: uuid("user_id")
    .notNull()
    .references(() => users.id, { onDelete: "cascade" }),
  skill_id: uuid("skill_id")
    .notNull()
    .references(() => skills.id, { onDelete: "cascade" }),
  installed_at: timestamp("installed_at", { withTimezone: true }).defaultNow(),
  configuration: jsonb("configuration").default({}),
  is_favorite: boolean("is_favorite").default(false),
  usage_count: integer("usage_count").default(0),
  last_used_at: timestamp("last_used_at", { withTimezone: true }),
});

// ===== è®¢é˜…è¡¨ =====
export const subscriptions = pgTable("subscriptions", {
  id: uuid("id").primaryKey().defaultRandom(),
  user_id: uuid("user_id")
    .notNull()
    .references(() => users.id, { onDelete: "cascade" }),
  plan_id: uuid("plan_id").references(() => plans.id),
  skill_id: uuid("skill_id").references(() => skills.id),
  status: varchar("status", { length: 20 }).notNull().default("active"),
  started_at: timestamp("started_at", { withTimezone: true }).defaultNow(),
  expires_at: timestamp("expires_at", { withTimezone: true }),
  cancelled_at: timestamp("cancelled_at", { withTimezone: true }),
  auto_renew: boolean("auto_renew").default(true),
  current_period_end: timestamp("current_period_end", { withTimezone: true }),
  next_billing_at: timestamp("next_billing_at", { withTimezone: true }),
  failed_renew_attempts: integer("failed_renew_attempts").default(0),
  payment_provider: varchar("payment_provider", { length: 50 }),
  payment_id: varchar("payment_id", { length: 100 }),
  amount_paid: decimal("amount_paid", { precision: 10, scale: 2 }),
  created_at: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updated_at: timestamp("updated_at", { withTimezone: true }).defaultNow(),
});

// ===== æ”¯ä»˜è®¢å•è¡¨ =====
export const paymentOrders = pgTable("payment_orders", {
  id: uuid("id").primaryKey().defaultRandom(),
  user_id: uuid("user_id")
    .notNull()
    .references(() => users.id, { onDelete: "cascade" }),
  order_no: varchar("order_no", { length: 50 }).notNull().unique(),
  order_type: varchar("order_type", { length: 20 }).notNull(),
  subscription_id: uuid("subscription_id").references(() => subscriptions.id),
  skill_id: uuid("skill_id").references(() => skills.id),
  plan_id: uuid("plan_id").references(() => plans.id),
  amount: decimal("amount", { precision: 10, scale: 2 }).notNull(),
  currency: varchar("currency", { length: 3 }).default("CNY"),
  discount_amount: decimal("discount_amount", { precision: 10, scale: 2 }).default("0"),
  final_amount: decimal("final_amount", { precision: 10, scale: 2 }).notNull(),
  coupon_id: uuid("coupon_id"),
  coupon_code: varchar("coupon_code", { length: 50 }),
  payment_provider: varchar("payment_provider", { length: 50 }),
  payment_id: varchar("payment_id", { length: 100 }),
  payment_url: varchar("payment_url", { length: 500 }),
  qr_code: text("qr_code"),
  status: varchar("status", { length: 20 }).notNull().default("pending"),
  paid_at: timestamp("paid_at", { withTimezone: true }),
  failed_at: timestamp("failed_at", { withTimezone: true }),
  failure_reason: text("failure_reason"),
  expires_at: timestamp("expires_at", { withTimezone: true }),
  created_at: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updated_at: timestamp("updated_at", { withTimezone: true }).defaultNow(),
});

// ===== ä¼˜æƒ åˆ¸è¡¨ =====
export const couponCodes = pgTable("coupon_codes", {
  id: uuid("id").primaryKey().defaultRandom(),
  code: varchar("code", { length: 50 }).notNull().unique(),
  type: varchar("type", { length: 20 }).notNull(),
  value: decimal("value", { precision: 10, scale: 2 }).notNull(),
  applicable_to: varchar("applicable_to", { length: 20 }).default("all"),
  applicable_ids: uuid("applicable_ids").array(),
  usage_limit: integer("usage_limit"),
  usage_per_user: integer("usage_per_user").default(1),
  minimum_amount: decimal("minimum_amount", { precision: 10, scale: 2 }),
  starts_at: timestamp("starts_at", { withTimezone: true }).notNull(),
  expires_at: timestamp("expires_at", { withTimezone: true }).notNull(),
  is_active: boolean("is_active").default(true),
  created_at: timestamp("created_at", { withTimezone: true }).defaultNow(),
});

// ===== ä¼˜æƒ åˆ¸ä½¿ç”¨è®°å½•è¡¨ =====
export const couponUsage = pgTable("coupon_usage", {
  id: uuid("id").primaryKey().defaultRandom(),
  coupon_id: uuid("coupon_id")
    .notNull()
    .references(() => couponCodes.id),
  user_id: uuid("user_id")
    .notNull()
    .references(() => users.id),
  order_id: uuid("order_id").references(() => paymentOrders.id),
  discount_amount: decimal("discount_amount", { precision: 10, scale: 2 }),
  applied_at: timestamp("applied_at", { withTimezone: true }).defaultNow(),
});

// ===== å®¡è®¡æ—¥å¿—è¡¨ =====
export const auditLogs = pgTable(
  "audit_logs",
  {
    id: uuid("id").defaultRandom(),
    user_id: uuid("user_id").references(() => users.id, { onDelete: "set null" }),
    device_id: varchar("device_id", { length: 100 }),
    action: varchar("action", { length: 50 }).notNull(),
    resource_type: varchar("resource_type", { length: 50 }).notNull(),
    resource_id: varchar("resource_id", { length: 100 }),
    details: jsonb("details").default({}),
    status: varchar("status", { length: 20 }).notNull(),
    error_message: text("error_message"),
    ip_address: varchar("ip_address", { length: 45 }),
    user_agent: varchar("user_agent", { length: 500 }),
    request_id: varchar("request_id", { length: 50 }),
    risk_level: varchar("risk_level", { length: 20 }).default("low"),
    created_at: timestamp("created_at", { withTimezone: true }).defaultNow(),
  },
  (table) => ({
    pk: primaryKey({ columns: [table.id, table.created_at] }),
  }),
);

// ===== å¯¼å‡ºè®°å½•è¡¨ =====
export const exportLogs = pgTable("export_logs", {
  id: uuid("id").primaryKey().defaultRandom(),
  user_id: uuid("user_id")
    .notNull()
    .references(() => users.id),
  export_type: varchar("export_type", { length: 50 }).notNull(),
  row_count: integer("row_count"),
  export_size_bytes: integer("export_size_bytes"),
  ip_address: varchar("ip_address", { length: 45 }),
  created_at: timestamp("created_at", { withTimezone: true }).defaultNow(),
});

// ===== å…³è”å…³ç³» =====
export const usersRelations = relations(users, ({ many }) => ({
  devices: many(userDevices),
  sessions: many(userSessions),
  subscriptions: many(subscriptions),
  skills: many(userSkills),
}));

export const userDevicesRelations = relations(userDevices, ({ one }) => ({
  user: one(users, {
    fields: [userDevices.user_id],
    references: [users.id],
  }),
}));

export const subscriptionsRelations = relations(subscriptions, ({ one }) => ({
  user: one(users, {
    fields: [subscriptions.user_id],
    references: [users.id],
  }),
  plan: one(plans, {
    fields: [subscriptions.plan_id],
    references: [plans.id],
  }),
  skill: one(skills, {
    fields: [subscriptions.skill_id],
    references: [skills.id],
  }),
}));

export const userSkillsRelations = relations(userSkills, ({ one }) => ({
  user: one(users, {
    fields: [userSkills.user_id],
    references: [users.id],
  }),
  skill: one(skills, {
    fields: [userSkills.skill_id],
    references: [skills.id],
  }),
}));
```

---

## 8. æ•°æ®è¿ç§»ç­–ç•¥ï¼ˆæ–°å¢ï¼‰

### 8.1 è¿ç§»æ¦‚è¿°

ç”±äºç°æœ‰ç³»ç»Ÿä½¿ç”¨ JSON æ–‡ä»¶å­˜å‚¨è®¾å¤‡é…å¯¹ä¿¡æ¯ï¼Œéœ€è¦è®¾è®¡å¹³æ»‘çš„è¿ç§»ç­–ç•¥ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          è¿ç§»é˜¶æ®µè§„åˆ’                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Phase 1: å‡†å¤‡é˜¶æ®µï¼ˆæ— åœæœºï¼‰                                            â”‚
â”‚   â”œâ”€â”€ éƒ¨ç½² PostgreSQL                                                  â”‚
â”‚   â”œâ”€â”€ åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„                                                  â”‚
â”‚   â””â”€â”€ ä¿ç•™ç°æœ‰ JSON å­˜å‚¨                                               â”‚
â”‚                                                                         â”‚
â”‚   Phase 2: åŒå†™é˜¶æ®µï¼ˆæ— åœæœºï¼‰                                            â”‚
â”‚   â”œâ”€â”€ æ–°è®¾å¤‡åŒæ—¶å†™å…¥ JSON å’Œ PostgreSQL                                 â”‚
â”‚   â”œâ”€â”€ ç”¨æˆ·æ³¨å†Œ/ç™»å½•å†™å…¥ PostgreSQL                                      â”‚
â”‚   â””â”€â”€ è¯»å–ä»ä½¿ç”¨ JSON                                                  â”‚
â”‚                                                                         â”‚
â”‚   Phase 3: æ•°æ®åŒæ­¥ï¼ˆåå°ä»»åŠ¡ï¼‰                                          â”‚
â”‚   â”œâ”€â”€ ä¸ºç°æœ‰è®¾å¤‡åˆ›å»ºè™šæ‹Ÿç”¨æˆ·                                            â”‚
â”‚   â”œâ”€â”€ å»ºç«‹ user_devices å…³è”                                           â”‚
â”‚   â””â”€â”€ éªŒè¯æ•°æ®ä¸€è‡´æ€§                                                   â”‚
â”‚                                                                         â”‚
â”‚   Phase 4: åˆ‡æ¢é˜¶æ®µï¼ˆè®¡åˆ’åœæœº 5 åˆ†é’Ÿï¼‰                                   â”‚
â”‚   â”œâ”€â”€ åœæ­¢ Gateway                                                     â”‚
â”‚   â”œâ”€â”€ æ‰§è¡Œæœ€ç»ˆæ•°æ®åŒæ­¥                                                  â”‚
â”‚   â”œâ”€â”€ åˆ‡æ¢è¯»å–æºä¸º PostgreSQL                                          â”‚
â”‚   â””â”€â”€ å¯åŠ¨ Gateway                                                     â”‚
â”‚                                                                         â”‚
â”‚   Phase 5: æ¸…ç†é˜¶æ®µï¼ˆè¿ç§»å 30 å¤©ï¼‰                                      â”‚
â”‚   â”œâ”€â”€ ç§»é™¤ JSON å†™å…¥é€»è¾‘                                               â”‚
â”‚   â”œâ”€â”€ å½’æ¡£ JSON å¤‡ä»½                                                   â”‚
â”‚   â””â”€â”€ ç§»é™¤å…¼å®¹æ€§ä»£ç                                                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 è™šæ‹Ÿç”¨æˆ·åˆ›å»ºç­–ç•¥

å¯¹äºæ²¡æœ‰å…³è”ç”¨æˆ·çš„ç°æœ‰è®¾å¤‡ï¼Œåˆ›å»ºè™šæ‹Ÿç”¨æˆ·ï¼š

```typescript
// scripts/migrate-devices.ts

/**
 * ä¸ºç°æœ‰é…å¯¹è®¾å¤‡åˆ›å»ºè™šæ‹Ÿç”¨æˆ·
 */
async function migrateExistingDevices(ctx: GatewayContext): Promise<void> {
  const log = ctx.logger.child({ task: "device-migration" });

  // 1. è¯»å–æ‰€æœ‰ç°æœ‰é…å¯¹è®¾å¤‡
  const pairedDevices = await devicePairing.getAllDevices();
  log.info(`Found ${pairedDevices.length} paired devices`);

  for (const device of pairedDevices) {
    try {
      // 2. æ£€æŸ¥æ˜¯å¦å·²æœ‰å…³è”ç”¨æˆ·
      const existing = await ctx.db.query.userDevices.findFirst({
        where: eq(userDevices.device_id, device.deviceId),
      });

      if (existing) {
        log.debug(`Device ${device.deviceId} already linked`);
        continue;
      }

      // 3. åˆ›å»ºè™šæ‹Ÿç”¨æˆ·
      const virtualEmail = `device-${device.deviceId.slice(0, 8)}@internal.openclaw.local`;

      const [user] = await ctx.db
        .insert(users)
        .values({
          email: virtualEmail,
          display_name: `è®¾å¤‡ç”¨æˆ· (${device.platform || "unknown"})`,
          is_email_verified: false,
          status: "active",
          account_type: "personal",
        })
        .returning();

      // 4. åˆ›å»ºè®¾å¤‡å…³è”
      await ctx.db.insert(userDevices).values({
        user_id: user.id,
        device_id: device.deviceId,
        display_name: device.displayName || `${device.platform} è®¾å¤‡`,
        is_primary: true,
        linked_at: new Date(device.createdAtMs),
      });

      log.info(`Migrated device ${device.deviceId} to user ${user.id}`);
    } catch (error) {
      log.error(`Failed to migrate device ${device.deviceId}:`, error);
    }
  }
}
```

### 8.3 å›æ»šæ–¹æ¡ˆ

```typescript
// scripts/rollback-migration.ts

/**
 * å›æ»šè¿ç§»ï¼ˆå¦‚æœå‡ºç°é—®é¢˜ï¼‰
 */
async function rollbackMigration(ctx: GatewayContext): Promise<void> {
  const log = ctx.logger.child({ task: "migration-rollback" });

  // 1. åˆ‡æ¢è¯»å–æºå› JSON
  ctx.config.deviceStorage = "json";

  // 2. ç¦ç”¨ PostgreSQL å†™å…¥
  ctx.config.enablePostgresWrite = false;

  // 3. è®°å½•å›æ»šäº‹ä»¶
  log.warn("Migration rolled back to JSON storage");

  // 4. å‘é€å‘Šè­¦
  await sendAlert({
    level: "critical",
    message: "User management migration rolled back",
    details: { reason: "Manual rollback triggered" },
  });
}
```

---

## 9. å®‰å…¨åŠ å›ºæ–¹æ¡ˆï¼ˆæ–°å¢ï¼‰

### 9.1 å¯†ç å®‰å…¨

```typescript
// src/assistant/auth/password.ts

import bcrypt from "bcrypt";
import zxcvbn from "zxcvbn";

const BCRYPT_COST = 12;

/**
 * å¯†ç å¼ºåº¦è¦æ±‚
 */
interface PasswordRequirements {
  minLength: number;
  requireUppercase: boolean;
  requireLowercase: boolean;
  requireNumber: boolean;
  requireSpecial: boolean;
  minStrength: number; // zxcvbn score (0-4)
}

const PASSWORD_REQUIREMENTS: PasswordRequirements = {
  minLength: 8,
  requireUppercase: true,
  requireLowercase: true,
  requireNumber: true,
  requireSpecial: true,
  minStrength: 2, // è‡³å°‘ "fair" å¼ºåº¦
};

/**
 * éªŒè¯å¯†ç å¼ºåº¦
 */
export function validatePasswordStrength(password: string): {
  valid: boolean;
  errors: string[];
  score: number;
} {
  const errors: string[] = [];

  if (password.length < PASSWORD_REQUIREMENTS.minLength) {
    errors.push(`å¯†ç è‡³å°‘ ${PASSWORD_REQUIREMENTS.minLength} ä¸ªå­—ç¬¦`);
  }
  if (PASSWORD_REQUIREMENTS.requireUppercase && !/[A-Z]/.test(password)) {
    errors.push("å¯†ç éœ€è¦åŒ…å«å¤§å†™å­—æ¯");
  }
  if (PASSWORD_REQUIREMENTS.requireLowercase && !/[a-z]/.test(password)) {
    errors.push("å¯†ç éœ€è¦åŒ…å«å°å†™å­—æ¯");
  }
  if (PASSWORD_REQUIREMENTS.requireNumber && !/[0-9]/.test(password)) {
    errors.push("å¯†ç éœ€è¦åŒ…å«æ•°å­—");
  }
  if (PASSWORD_REQUIREMENTS.requireSpecial && !/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
    errors.push("å¯†ç éœ€è¦åŒ…å«ç‰¹æ®Šå­—ç¬¦");
  }

  // zxcvbn å¼ºåº¦æ£€æŸ¥
  const strength = zxcvbn(password);
  if (strength.score < PASSWORD_REQUIREMENTS.minStrength) {
    errors.push("å¯†ç å¼ºåº¦ä¸è¶³ï¼Œè¯·ä½¿ç”¨æ›´å¤æ‚çš„å¯†ç ");
  }

  return {
    valid: errors.length === 0,
    errors,
    score: strength.score,
  };
}

/**
 * å“ˆå¸Œå¯†ç 
 */
export async function hashPassword(password: string): Promise<string> {
  return bcrypt.hash(password, BCRYPT_COST);
}

/**
 * éªŒè¯å¯†ç 
 */
export async function verifyPassword(password: string, hash: string): Promise<boolean> {
  return bcrypt.compare(password, hash);
}
```

### 9.2 MFA å®ç°

```typescript
// src/assistant/auth/mfa.ts

import speakeasy from "speakeasy";
import qrcode from "qrcode";
import crypto from "crypto";

/**
 * è®¾ç½® TOTP
 */
export async function setupTOTP(
  userId: string,
  displayName: string,
): Promise<{
  secret: string;
  qrCodeUrl: string;
  backupCodes: string[];
}> {
  // 1. ç”Ÿæˆå¯†é’¥
  const secret = speakeasy.generateSecret({
    name: `OpenClaw (${displayName})`,
    issuer: "OpenClaw",
    length: 32,
  });

  // 2. ç”Ÿæˆ QR ç 
  const qrCodeUrl = await qrcode.toDataURL(secret.otpauth_url!);

  // 3. ç”Ÿæˆå¤‡ç”¨ç 
  const backupCodes = generateBackupCodes(8);

  return {
    secret: secret.base32,
    qrCodeUrl,
    backupCodes,
  };
}

/**
 * éªŒè¯ TOTP
 */
export function verifyTOTP(secret: string, token: string): boolean {
  return speakeasy.totp.verify({
    secret,
    encoding: "base32",
    token,
    window: 2, // å…è®¸ Â±1 ä¸ªæ—¶é—´çª—å£ï¼ˆ30ç§’ï¼‰
  });
}

/**
 * ç”Ÿæˆå¤‡ç”¨ç 
 */
function generateBackupCodes(count: number): string[] {
  const codes: string[] = [];
  for (let i = 0; i < count; i++) {
    const code = crypto.randomBytes(4).toString("hex").toUpperCase();
    codes.push(`${code.slice(0, 4)}-${code.slice(4)}`);
  }
  return codes;
}

/**
 * éªŒè¯å¤‡ç”¨ç 
 */
export async function verifyBackupCode(
  userId: string,
  code: string,
  ctx: GatewayContext,
): Promise<boolean> {
  const user = await ctx.db.query.users.findFirst({
    where: eq(users.id, userId),
  });

  if (!user?.mfa_backup_codes) return false;

  const normalizedCode = code.replace("-", "").toUpperCase();
  const codeIndex = user.mfa_backup_codes.findIndex(
    (c) => c.replace("-", "").toUpperCase() === normalizedCode,
  );

  if (codeIndex === -1) return false;

  // ä½¿ç”¨åç§»é™¤å¤‡ç”¨ç 
  const updatedCodes = [...user.mfa_backup_codes];
  updatedCodes.splice(codeIndex, 1);

  await ctx.db.update(users).set({ mfa_backup_codes: updatedCodes }).where(eq(users.id, userId));

  return true;
}
```

### 9.3 é€Ÿç‡é™åˆ¶

```typescript
// src/gateway/middleware/rate-limit.ts

interface RateLimitConfig {
  windowMs: number; // æ—¶é—´çª—å£ï¼ˆæ¯«ç§’ï¼‰
  maxRequests: number; // æœ€å¤§è¯·æ±‚æ•°
  keyGenerator: (ctx: GatewayContext) => string;
}

const RATE_LIMITS: Record<string, RateLimitConfig> = {
  // éªŒè¯ç è¯·æ±‚ï¼šæ¯ä¸ª IP æ¯å°æ—¶ 10 æ¬¡
  "auth.sendCode": {
    windowMs: 3600000,
    maxRequests: 10,
    keyGenerator: (ctx) => `rate:sendCode:ip:${ctx.req?.ip}`,
  },

  // ç™»å½•å°è¯•ï¼šæ¯ä¸ª IP æ¯ 15 åˆ†é’Ÿ 20 æ¬¡
  "auth.login": {
    windowMs: 900000,
    maxRequests: 20,
    keyGenerator: (ctx) => `rate:login:ip:${ctx.req?.ip}`,
  },

  // å®¡è®¡æ—¥å¿—å¯¼å‡ºï¼šæ¯ä¸ªç”¨æˆ·æ¯å°æ—¶ 3 æ¬¡
  "audit.export": {
    windowMs: 3600000,
    maxRequests: 3,
    keyGenerator: (ctx) => `rate:export:user:${ctx.auth?.user?.id}`,
  },

  // æŠ€èƒ½æ‰§è¡Œï¼šæ¯ä¸ªè®¾å¤‡æ¯åˆ†é’Ÿ 60 æ¬¡
  "assistant.skillExecute": {
    windowMs: 60000,
    maxRequests: 60,
    keyGenerator: (ctx) => `rate:skill:device:${ctx.auth?.device?.deviceId}`,
  },
};

/**
 * æ£€æŸ¥é€Ÿç‡é™åˆ¶
 */
export async function checkRateLimit(
  method: string,
  ctx: GatewayContext,
): Promise<{ allowed: boolean; remaining: number; resetAt: Date }> {
  const config = RATE_LIMITS[method];
  if (!config) {
    return { allowed: true, remaining: -1, resetAt: new Date() };
  }

  const key = config.keyGenerator(ctx);
  const now = Date.now();
  const windowStart = now - config.windowMs;

  // ä½¿ç”¨ Redis æˆ–å†…å­˜ç¼“å­˜å®ç°
  // è¿™é‡Œç®€åŒ–ä½¿ç”¨å†…å­˜å®ç°
  const count = await incrementRateCounter(key, windowStart);

  const allowed = count <= config.maxRequests;
  const remaining = Math.max(0, config.maxRequests - count);
  const resetAt = new Date(now + config.windowMs);

  if (!allowed) {
    await logAudit(ctx, {
      user_id: ctx.auth?.user?.id,
      device_id: ctx.auth?.device?.deviceId,
      action: "rate_limit.exceeded",
      resource_type: "api",
      resource_id: method,
      status: "denied",
      details: { count, limit: config.maxRequests },
      risk_level: "medium",
    });
  }

  return { allowed, remaining, resetAt };
}
```

---

## 10. é…ç½®ä¸ç¯å¢ƒå˜é‡

### 10.1 ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env.example

# ========== æ•°æ®åº“ ==========
DATABASE_URL=postgresql://user:password@localhost:5432/openclaw
DATABASE_POOL_MIN=2
DATABASE_POOL_MAX=10
DATABASE_SSL=false

# ========== JWT ==========
JWT_SECRET=your-256-bit-secret-key-here
JWT_ACCESS_TOKEN_EXPIRY=15m
JWT_REFRESH_TOKEN_EXPIRY=7d

# ========== çŸ­ä¿¡æœåŠ¡ ==========
SMS_PROVIDER=aliyun
SMS_ACCESS_KEY_ID=your-access-key
SMS_ACCESS_KEY_SECRET=your-access-secret
SMS_SIGN_NAME=OpenClaw
SMS_TEMPLATE_CODE=SMS_123456789

# ========== é‚®ä»¶æœåŠ¡ ==========
EMAIL_PROVIDER=smtp
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=noreply@openclaw.ai
SMTP_PASSWORD=your-smtp-password
EMAIL_FROM=noreply@openclaw.ai

# ========== å¾®ä¿¡ç™»å½• ==========
WECHAT_APP_ID=wx123456789
WECHAT_APP_SECRET=your-wechat-secret
WECHAT_CALLBACK_URL=https://api.openclaw.ai/auth/wechat/callback

# ========== æ”¯ä»˜ç½‘å…³ ==========
# å¾®ä¿¡æ”¯ä»˜
WECHAT_PAY_MCH_ID=your-mch-id
WECHAT_PAY_KEY=your-api-key
WECHAT_PAY_NOTIFY_URL=https://api.openclaw.ai/payment/wechat/notify

# æ”¯ä»˜å®
ALIPAY_APP_ID=your-app-id
ALIPAY_MERCHANT_PRIVATE_KEY=your-private-key
ALIPAY_ALIPAY_PUBLIC_KEY=alipay-public-key
ALIPAY_NOTIFY_URL=https://api.openclaw.ai/payment/alipay/notify

# ========== åŠŸèƒ½å¼€å…³ ==========
FEATURE_SMS_REGISTRATION=true
FEATURE_EMAIL_REGISTRATION=true
FEATURE_WECHAT_LOGIN=true
FEATURE_MFA=true
FEATURE_SUBSCRIPTIONS=true
FEATURE_PAYMENTS=true

# ========== å®‰å…¨ ==========
BCRYPT_COST=12
MAX_LOGIN_ATTEMPTS=5
ACCOUNT_LOCK_DURATION_MINUTES=15
```

### 10.2 é…ç½®æ–‡ä»¶ç»“æ„

```yaml
# ~/.openclaw/config.yaml

# æ•°æ®åº“é…ç½®
database:
  url: "${DATABASE_URL}"
  pool:
    min: 2
    max: 10
  ssl: false

# JWT é…ç½®
jwt:
  secret: "${JWT_SECRET}"
  accessToken:
    expiry: "15m"
  refreshToken:
    expiry: "7d"
    maxSessionsPerUser: 5

# è®¤è¯é…ç½®
auth:
  sms:
    provider: "${SMS_PROVIDER}"
    codeExpiry: 300 # 5 åˆ†é’Ÿ
    codeLength: 6
    rateLimit:
      perIpPerHour: 10
      perPhonePerMinute: 1
  email:
    provider: "${EMAIL_PROVIDER}"
    from: "${EMAIL_FROM}"
  password:
    minLength: 8
    requireUppercase: true
    requireLowercase: true
    requireNumber: true
    requireSpecial: true
    bcryptCost: 12
  mfa:
    enabled: true
    backupCodesCount: 8
  lockout:
    maxAttempts: 5
    durationMinutes: 15

# å®¡è®¡é…ç½®
audit:
  enabled: true
  retentionDays: 90
  partitionByMonth: true
  alertOnHighRisk: true

# è®¢é˜…é…ç½®
subscription:
  autoRenewal:
    enabled: true
    cronSchedule: "0 2 * * *" # æ¯å¤©å‡Œæ™¨ 2 ç‚¹
    maxRetries: 3
  gracePeriodDays: 3
```

---

## 11. å®æ–½è®¡åˆ’ï¼ˆä¿®è®¢ç‰ˆï¼‰

| é˜¶æ®µ        | æ—¶é—´   | ä»»åŠ¡       | äº§å‡º                          | ä¾èµ–    |
| ----------- | ------ | ---------- | ----------------------------- | ------- |
| **Phase 1** | Week 1 | æ•°æ®åº“åŸºç¡€ | PostgreSQL é…ç½®ã€Schemaã€è¿ç§» | -       |
| **Phase 2** | Week 2 | ç”¨æˆ·è®¤è¯   | æ³¨å†Œ/ç™»å½•ã€JWTã€MFA           | Phase 1 |
| **Phase 3** | Week 3 | è®¾å¤‡æ•´åˆ   | ç”¨æˆ·è®¾å¤‡å…³è”ã€ç°æœ‰ç³»ç»Ÿå…¼å®¹    | Phase 2 |
| **Phase 4** | Week 4 | è®¢é˜…ç³»ç»Ÿ   | è®¡åˆ’ç®¡ç†ã€æ”¯ä»˜é›†æˆã€è‡ªåŠ¨ç»­è´¹  | Phase 2 |
| **Phase 5** | Week 5 | å®¡è®¡æ—¥å¿—   | æ—¥å¿—è®°å½•ã€æŸ¥è¯¢ã€å¯¼å‡ºã€å‘Šè­¦    | Phase 2 |
| **Phase 6** | Week 6 | æ•°æ®è¿ç§»   | ç°æœ‰è®¾å¤‡è¿ç§»ã€è™šæ‹Ÿç”¨æˆ·åˆ›å»º    | Phase 3 |
| **Phase 7** | Week 7 | å®‰å…¨åŠ å›º   | é€Ÿç‡é™åˆ¶ã€å®‰å…¨å®¡è®¡ã€ç›‘æ§      | All     |
| **Phase 8** | Week 8 | æ•´åˆæµ‹è¯•   | E2E æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€æ–‡æ¡£      | All     |

### 11.1 Phase 1 è¯¦ç»†ä»»åŠ¡

- [x] è®¾è®¡æ•°æ®åº“ Schema
- [ ] å®‰è£…å’Œé…ç½® PostgreSQL 16
- [ ] é…ç½® Drizzle ORM
- [ ] åˆ›å»ºæ‰€æœ‰æ•°æ®åº“è¡¨
- [ ] ç¼–å†™è¿ç§»è„šæœ¬
- [ ] é…ç½®è¿æ¥æ± 
- [ ] ç¼–å†™æ•°æ®åº“å·¥å…·å‡½æ•°

### 11.2 Phase 2 è¯¦ç»†ä»»åŠ¡

- [ ] å®ç°å¯†ç å¼ºåº¦éªŒè¯
- [ ] å®ç°éªŒè¯ç å‘é€æœåŠ¡ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
- [ ] å®ç°æ‰‹æœºå·æ³¨å†Œ/ç™»å½•
- [ ] å®ç°é‚®ç®±å¯†ç æ³¨å†Œ/ç™»å½•
- [ ] å®ç° JWT Token ç”Ÿæˆ/éªŒè¯
- [ ] å®ç° Token åˆ·æ–°æœºåˆ¶
- [ ] å®ç° MFA (TOTP + å¤‡ç”¨ç )
- [ ] å®ç°è´¦æˆ·é”å®šæœºåˆ¶

### 11.3 Phase 3 è¯¦ç»†ä»»åŠ¡

- [ ] å®ç° user_devices å…³è”è¡¨é€»è¾‘
- [ ] ä¸ç°æœ‰ device-pairing.ts æ•´åˆ
- [ ] å®ç°è®¾å¤‡ç»‘å®š API
- [ ] å®ç°è®¾å¤‡è§£ç»‘ API
- [ ] å®ç°è®¾å¤‡é…é¢æ£€æŸ¥

### 11.4 Phase 4 è¯¦ç»†ä»»åŠ¡

- [ ] å®ç°è®¡åˆ’ç®¡ç† API
- [ ] å®ç°æ”¯ä»˜è®¢å•åˆ›å»º
- [ ] é›†æˆå¾®ä¿¡æ”¯ä»˜
- [ ] é›†æˆæ”¯ä»˜å®æ”¯ä»˜
- [ ] å®ç°æ”¯ä»˜å›è°ƒå¤„ç†
- [ ] å®ç°ä¼˜æƒ åˆ¸ç³»ç»Ÿ
- [ ] å®ç°è‡ªåŠ¨ç»­è´¹å®šæ—¶ä»»åŠ¡
- [ ] å®ç°ä½¿ç”¨é™é¢æ£€æŸ¥

### 11.5 Phase 5 è¯¦ç»†ä»»åŠ¡

- [ ] å®ç°å®¡è®¡æ—¥å¿—è®°å½•æœåŠ¡
- [ ] å®ç°é£é™©çº§åˆ«è‡ªåŠ¨åˆ¤å®š
- [ ] å®ç°å®¡è®¡æ—¥å¿—æŸ¥è¯¢ APIï¼ˆåˆ†é¡µï¼‰
- [ ] å®ç°æ—¥å¿—å¯¼å‡ºåŠŸèƒ½ï¼ˆé¢‘ç‡é™åˆ¶ï¼‰
- [ ] å®ç°é«˜é£é™©æ“ä½œå‘Šè­¦
- [ ] é…ç½®æ—¥å¿—åˆ†åŒº
- [ ] å®ç°æ—¥å¿—æ¸…ç†å®šæ—¶ä»»åŠ¡

### 11.6 Phase 6 è¯¦ç»†ä»»åŠ¡

- [ ] ç¼–å†™è®¾å¤‡è¿ç§»è„šæœ¬
- [ ] å®ç°è™šæ‹Ÿç”¨æˆ·åˆ›å»ºé€»è¾‘
- [ ] å®ç°åŒå†™æ¨¡å¼
- [ ] æ‰§è¡Œæ•°æ®åŒæ­¥
- [ ] éªŒè¯æ•°æ®ä¸€è‡´æ€§
- [ ] ç¼–å†™å›æ»šè„šæœ¬

### 11.7 Phase 7 è¯¦ç»†ä»»åŠ¡

- [ ] å®ç° API é€Ÿç‡é™åˆ¶
- [ ] å®ç°å®‰å…¨å‘Šè­¦ç³»ç»Ÿ
- [ ] é…ç½®ç›‘æ§å’ŒæŠ¥è­¦
- [ ] å®‰å…¨å®¡è®¡æ£€æŸ¥
- [ ] æ¸—é€æµ‹è¯•ï¼ˆå¯é€‰ï¼‰

### 11.8 Phase 8 è¯¦ç»†ä»»åŠ¡

- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•
- [ ] ç¼–å†™ E2E æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] ç¼–å†™ API æ–‡æ¡£
- [ ] ç¼–å†™è¿ç»´æ–‡æ¡£

---

## 12. é¡¹ç›®ç»“æ„ï¼ˆä¿®è®¢ç‰ˆï¼‰

```
src/
â”œâ”€â”€ db/                            # ğŸ†• æ•°æ®åº“å±‚
â”‚   â”œâ”€â”€ index.ts                   # æ•°æ®åº“è¿æ¥å’Œåˆå§‹åŒ–
â”‚   â”œâ”€â”€ schema/                    # Drizzle Schema
â”‚   â”‚   â”œâ”€â”€ index.ts               # å¯¼å‡ºæ‰€æœ‰ schema
â”‚   â”‚   â”œâ”€â”€ users.ts               # ç”¨æˆ·ç›¸å…³è¡¨
â”‚   â”‚   â”œâ”€â”€ subscriptions.ts       # è®¢é˜…ç›¸å…³è¡¨
â”‚   â”‚   â””â”€â”€ audit.ts               # å®¡è®¡ç›¸å…³è¡¨
â”‚   â””â”€â”€ migrations/                # è¿ç§»æ–‡ä»¶
â”‚       â”œâ”€â”€ 0001_create_users.sql
â”‚       â”œâ”€â”€ 0002_create_subscriptions.sql
â”‚       â””â”€â”€ 0003_create_audit_logs.sql
â”‚
â”œâ”€â”€ assistant/                     # ğŸ†• åŠ©ç†ç³»ç»Ÿ
â”‚   â”œâ”€â”€ auth/                      # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ jwt.ts                 # JWT å¤„ç†
â”‚   â”‚   â”œâ”€â”€ password.ts            # å¯†ç å“ˆå¸Œå’ŒéªŒè¯
â”‚   â”‚   â”œâ”€â”€ mfa.ts                 # MFA å®ç°
â”‚   â”‚   â””â”€â”€ verification.ts        # éªŒè¯ç æœåŠ¡
â”‚   â”œâ”€â”€ subscription/              # è®¢é˜…æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ service.ts             # è®¢é˜…æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ coupon.ts              # ä¼˜æƒ åˆ¸é€»è¾‘
â”‚   â”‚   â””â”€â”€ auto-renew.ts          # è‡ªåŠ¨ç»­è´¹
â”‚   â”œâ”€â”€ audit/                     # å®¡è®¡æ¨¡å—
â”‚   â”‚   â””â”€â”€ service.ts             # å®¡è®¡æ—¥å¿—æœåŠ¡
â”‚   â””â”€â”€ payment/                   # æ”¯ä»˜æ¨¡å—
â”‚       â”œâ”€â”€ wechat.ts              # å¾®ä¿¡æ”¯ä»˜
â”‚       â””â”€â”€ alipay.ts              # æ”¯ä»˜å®æ”¯ä»˜
â”‚
â”œâ”€â”€ gateway/
â”‚   â”œâ”€â”€ middleware/                # ğŸ†• ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.ts                # ç»Ÿä¸€è®¤è¯
â”‚   â”‚   â””â”€â”€ rate-limit.ts          # é€Ÿç‡é™åˆ¶
â”‚   â””â”€â”€ server-methods/
â”‚       â”œâ”€â”€ auth.ts                # ğŸ†• è®¤è¯æ–¹æ³•
â”‚       â”œâ”€â”€ assistant-subscription.ts
â”‚       â”œâ”€â”€ assistant-audit.ts
â”‚       â”œâ”€â”€ assistant-payment.ts
â”‚       â””â”€â”€ assistant.ts
â”‚
â”œâ”€â”€ infra/
â”‚   â””â”€â”€ device-pairing.ts          # ç°æœ‰ï¼ˆä¿æŒå…¼å®¹ï¼‰
â”‚
â””â”€â”€ scripts/
    â”œâ”€â”€ migrate-devices.ts         # ğŸ†• è®¾å¤‡è¿ç§»è„šæœ¬
    â””â”€â”€ rollback-migration.ts      # ğŸ†• å›æ»šè„šæœ¬
```

---

_â€” æ–‡æ¡£ä¿®è®¢å®Œæˆ â€”_
