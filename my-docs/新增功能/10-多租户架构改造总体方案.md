# OpenClaw 多租户架构改造总体方案

> 版本: 1.0 | 创建日期: 2026-02-12 | 状态: 规划中
>
> 本文档是多租户架构改造的顶层方案，子模块详细设计见独立文档

---

## 修订记录

| 版本 | 日期       | 修订内容           |
| ---- | ---------- | ------------------ |
| 1.0  | 2026-02-12 | 初稿，整体方案设计 |

---

## 1. 改造背景

### 1.1 现状

OpenClaw 最初是**单用户架构**——一个 Gateway 实例服务一个 owner。现有系统已完成：

| 模块           | 状态      | 参考文档                      |
| -------------- | --------- | ----------------------------- |
| Gateway 核心   | ✅ 已完成 | 01-产品与架构设计.md          |
| 用户认证体系   | ✅ 已完成 | 02-用户与认证系统设计.md      |
| 数据库 Schema  | ✅ 已完成 | src/db/schema/                |
| 管理后台       | ✅ 已完成 | 04-管理后台系统设计.md        |
| Windows 客户端 | ✅ 已完成 | 05-开发实施计划.md            |
| web-admin 前端 | ✅ 已完成 | 04a-用户端管理面板设计.md     |
| admin-console  | ✅ 已完成 | 04b-admin-console-开发计划.md |

### 1.2 目标

将 OpenClaw 从"单用户 + 管理员后台"改造为"多租户个人 AI 助手平台"：

- 多用户注册、登录、独立使用
- 每个用户绑定自己的设备节点
- 用户通过 AI 对话控制已绑定设备
- 对话记忆、文档附件存储在服务端（按用户隔离）
- 用户可自定义 AI 助手性格偏好
- 用户可创建、测试、上传、同步技能
- 用户私有数据严格隔离

### 1.3 核心矛盾

| #   | 矛盾                            | 影响                                      |
| --- | ------------------------------- | ----------------------------------------- |
| 1   | Gateway 职责过重                | 同时承担实时控制 + CRUD 业务，难以扩展    |
| 2   | 运行时缺乏多租户意识            | Agent、Session、Tool 调用没有 userId 隔离 |
| 3   | 缺少对话/记忆/文档/自建技能存储 | 产品核心数据无处存放                      |

---

## 2. 架构改造方案

### 2.1 目标架构：Gateway + App Server 双服务

```
┌──────────────────────────────────────────────────────────────────┐
│                          用户层                                    │
│   Windows客户端 │ Web端 │ 移动App │ admin-console                  │
└───────┬─────────────┬──────────┬──────────┬──────────────────────┘
        │ ws://        │ https://  │ ws+http   │ https://
        │              │           │           │
┌───────▼──────┐ ┌────▼───────────▼───────────▼────────────────────┐
│   Gateway    │ │              App Server (新增)                    │
│   (实时控制)  │ │              (业务逻辑)                          │
│              │ │                                                  │
│ • WS 连接管理│ │ • 用户注册/登录 (HTTP REST)                      │
│ • 消息路由   │ │ • 技能商店 CRUD                                  │
│ • Agent 运行 │ │ • 订阅/支付                                      │
│ • 技能下发   │ │ • 文档/附件上传 (对象存储)                       │
│ • 设备状态   │ │ • 记忆管理                                       │
│ • 鉴权校验   │ │ • 管理后台 API                                   │
│              │ │ • 审计/分析                                      │
└──────┬───────┘ └────────────┬────────────────────────────────────┘
       │                      │
       │   共享数据库 + 事件总线  │
       │                      │
┌──────▼──────────────────────▼────────────────────────────────────┐
│                       基础设施层                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │PostgreSQL│  │  Redis   │  │MinIO     │  │Milvus    │         │
│  │结构化数据│  │缓存/事件 │  │对象存储  │  │向量检索  │         │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘         │
└──────────────────────────────────────────────────────────────────┘
```

### 2.2 职责划分

#### Gateway 保留（实时性要求高）

| 职责           | 说明                                  |
| -------------- | ------------------------------------- |
| WebSocket 管理 | 设备节点长连接、心跳、状态感知        |
| 消息路由       | 用户消息 → AI Agent → 设备指令 → 结果 |
| Agent 运行时   | 流式 AI 对话、工具调用、上下文管理    |
| 连接级鉴权     | Token 校验、设备身份确认              |
| 技能执行调度   | 实时下发技能到设备端执行              |
| 操作确认交互   | 敏感操作的用户确认流程                |

#### App Server 承接（标准 CRUD）

| 职责         | 说明                                    |
| ------------ | --------------------------------------- |
| 用户管理     | 注册、登录、资料、密码                  |
| 技能商店     | 浏览、搜索、上架、审核                  |
| 订阅/支付    | 套餐管理、订单、优惠券                  |
| 文档/附件    | 上传、下载、管理（MinIO）               |
| 记忆管理     | 查询、修改、删除（PostgreSQL + Milvus） |
| 管理后台 API | 仪表盘、用户管理、审计日志              |
| 配置管理     | 系统配置 CRUD                           |
| 分析统计     | 数据聚合、报表                          |

#### 两者通信方式

| 场景               | 方向                 | 方式                   |
| ------------------ | -------------------- | ---------------------- |
| Token 校验         | Gateway → DB/Redis   | 直接读取（Redis 缓存） |
| 用户配额检查       | Gateway → Redis      | 读取缓存值             |
| 技能上传后通知设备 | App Server → Gateway | Redis Pub/Sub          |
| AI 对话产生记忆    | Gateway → DB         | 直接写入               |
| 用户修改助手配置   | App Server → Gateway | Redis Pub/Sub 配置变更 |
| 管理员操作         | App Server → DB      | 直接写入               |

### 2.3 技术选型

#### App Server

| 层级     | 技术            | 说明                          |
| -------- | --------------- | ----------------------------- |
| 框架     | Fastify 5.x     | 与 Gateway HTTP 层一致        |
| ORM      | Drizzle ORM     | 复用现有 schema 和 repository |
| 鉴权     | JWT             | 复用现有 JWT 体系             |
| API 风格 | RESTful         | 前端友好，标准化              |
| 文档     | Swagger/OpenAPI | 自动生成 API 文档             |

#### 基础设施（参考 03-记忆与存储系统设计.md）

| 服务       | 用途        | 初期方案              | 演进方案         |
| ---------- | ----------- | --------------------- | ---------------- |
| PostgreSQL | 结构化数据  | ✅ 已有               | 按需分库         |
| Redis      | 缓存 + 事件 | 单实例                | Sentinel/Cluster |
| MinIO      | 对象存储    | 单实例                | 分布式           |
| Milvus     | 向量检索    | 可选（pgvector 替代） | 独立实例         |
| Neo4j      | 知识图谱    | Phase 3 引入          | 独立实例         |

### 2.4 部署架构（初期单机）

```
单台服务器
├── Gateway       (ws://0.0.0.0:18789)
├── App Server    (http://0.0.0.0:3000)    ← 新增
├── PostgreSQL    (localhost:5432)
├── Redis         (localhost:6379)          ← 新增
├── MinIO         (localhost:9000)          ← 新增
└── Nginx         (反向代理 80/443)        ← 新增
```

---

## 3. 改造阶段规划

### 概览

```
Phase 1: 数据库多租户隔离 ← 当前阶段
    ↓
Phase 2: 新增核心表（对话、记忆、文档、自建技能、助手配置）
    ↓
Phase 3: 创建 App Server + 迁移 CRUD API
    ↓
Phase 4: Agent 运行时多租户改造
    ↓
Phase 5: 基础设施引入（Redis、MinIO、向量检索）
    ↓
Phase 6: 前端对接新 API
```

### Phase 1: 数据库多租户隔离

> 详细设计见 → [10a-数据库多租户隔离方案.md](./10a-数据库多租户隔离方案.md)

**目标**: 在现有代码中建立多租户意识，不改变部署架构

**范围**:

- Repository 层增加 `TenantScope` 机制
- Gateway RPC 方法提取 userId 上下文
- 数据库查询增加 userId 过滤
- 系统级表（plans, skill_categories, system_configs）保持全局

**验收标准**:

- 所有用户数据查询都包含 userId 过滤
- 用户 A 无法访问用户 B 的数据
- 系统级数据所有用户可见
- 现有功能不受影响

### Phase 2: 新增核心表

> 详细设计见 → [10b-核心数据表设计.md](./10b-核心数据表设计.md)

**目标**: 补充产品所需但尚未建表的数据结构

**新增表**:

| 表名                     | 用途                | 参考                     |
| ------------------------ | ------------------- | ------------------------ |
| `conversations`          | 对话会话            | 03-记忆与存储系统设计.md |
| `messages`               | 对话消息            | 同上                     |
| `user_memories`          | AI 提取的结构化记忆 | 同上 §2 情景记忆         |
| `user_files`             | 用户上传文件元数据  | 同上 §6 多媒体存储       |
| `user_custom_skills`     | 用户自建技能代码    | 01-产品与架构设计.md §5  |
| `user_assistant_configs` | AI 助手个性化配置   | 新增                     |
| `usage_quotas`           | 用量配额追踪        | 02-用户与认证系统设计.md |

**验收标准**:

- 所有新表都有 userId 外键
- Drizzle migration 生成并可执行
- Repository 实现并通过单元测试

### Phase 3: 创建 App Server

> 详细设计见 → [10c-AppServer设计方案.md](./10c-AppServer设计方案.md)

**目标**: 新建 `apps/api-server/` 独立 HTTP 服务，承接 CRUD 业务

**范围**:

- Fastify HTTP 服务框架搭建
- 复用现有 Drizzle DB 连接和 Repository
- 迁移 Gateway 中的 CRUD RPC 方法为 REST API
- 前端 web-admin / admin-console 改为调用 App Server

**迁移清单（从 Gateway → App Server）**:

| Gateway RPC 方法前缀    | 迁移为 REST API                         |
| ----------------------- | --------------------------------------- |
| `admin.users.*`         | `GET/POST/PUT /api/admin/users`         |
| `admin.subscriptions.*` | `GET/POST/PUT /api/admin/subscriptions` |
| `admin.skills.*`        | `GET/POST/PUT /api/admin/skills`        |
| `admin.audit.*`         | `GET /api/admin/audit`                  |
| `admin.config.*`        | `GET/PUT /api/admin/config`             |
| `admin.analytics.*`     | `GET /api/admin/analytics`              |
| `admin.monitor.*`       | `GET /api/admin/monitor`                |
| `admin.dashboard.*`     | `GET /api/admin/dashboard`              |
| `auth.register`         | `POST /api/auth/register`               |
| `auth.login`            | `POST /api/auth/login`                  |
| `auth.changePassword`   | `POST /api/auth/password`               |

**保留在 Gateway 的方法**:

| 方法前缀         | 保留原因                     |
| ---------------- | ---------------------------- |
| `chat.*`         | 流式 AI 对话，依赖 WebSocket |
| `agent.*`        | Agent 运行时                 |
| `sessions.*`     | Agent 会话管理               |
| `nodes.*`        | 设备节点实时管理             |
| `skills.execute` | 技能实时下发执行             |
| `send.*`         | 消息推送                     |
| `browser.*`      | 浏览器自动化                 |

### Phase 4: Agent 运行时多租户改造

> 详细设计见 → [10d-Agent多租户改造方案.md](./10d-Agent多租户改造方案.md)

**目标**: Agent 运行时绑定 userId，实现用户级隔离

**范围**:

- Agent Session 绑定 userId
- 工具调用限定在用户自己的设备范围
- 系统提示注入用户个性化配置
- AI 对话记忆按用户隔离

### Phase 5: 基础设施引入

> 详细设计见 → [10e-基础设施部署方案.md](./10e-基础设施部署方案.md)

**目标**: 引入 Redis、MinIO，支撑缓存、事件和对象存储

**范围**:

- Redis: 用户 session 缓存、配额缓存、Pub/Sub 事件总线
- MinIO: 文档/附件/技能包对象存储（参考 03-记忆与存储系统设计.md §6）
- 向量检索: pgvector 扩展（初期替代 Milvus）
- Docker Compose 编排

### Phase 6: 前端对接

> 详细设计见 → [10f-前端API迁移方案.md](./10f-前端API迁移方案.md)

**目标**: web-admin / admin-console / Windows 客户端对接新的 App Server API

**范围**:

- Gateway WebSocket 调用 → App Server HTTP REST 调用
- API Client 封装
- 认证 Token 统一管理

---

## 4. 与现有文档的关系

```
01-产品与架构设计.md          → 本文档更新架构部分（双服务）
02-用户与认证系统设计.md      → Phase 1 复用其用户/设备模型
03-记忆与存储系统设计.md      → Phase 2 复用其四层记忆模型 + Phase 5 复用存储技术栈
04-管理后台系统设计.md        → Phase 3 迁移管理后台 API 到 App Server
05-开发实施计划.md            → 本文档替代其"待开发任务"部分
```

---

## 5. 风险与缓解

| 风险                            | 影响 | 概率 | 缓解措施                          |
| ------------------------------- | ---- | ---- | --------------------------------- |
| 改造期间破坏现有功能            | 高   | 中   | 渐进式改造，每个 Phase 独立可验收 |
| Repository 改造遗漏 userId 过滤 | 高   | 中   | 编写集成测试验证数据隔离          |
| Gateway → App Server 迁移中断   | 高   | 低   | 双写期：两个服务同时提供接口      |
| 基础设施增加运维复杂度          | 中   | 高   | Docker Compose 一键部署           |
| Agent 多租户改造影响面广        | 高   | 中   | Phase 4 单独验证，充分测试        |

---

## 6. 子文档索引

| 文档                        | 内容                             | 状态   |
| --------------------------- | -------------------------------- | ------ |
| 10a-数据库多租户隔离方案.md | Repository scope + userId 传递   | 已完成 |
| 10b-核心数据表设计.md       | 对话/记忆/文档/技能/配置表       | 已完成 |
| 10c-AppServer设计方案.md    | Fastify 服务 + REST API          | 已完成 |
| 10d-Agent多租户改造方案.md  | Agent 运行时 userId 隔离         | 已完成 |
| 10e-基础设施部署方案.md     | Redis/MinIO/向量/Docker          | 已完成 |
| 10f-前端API迁移方案.md      | 前端从 Gateway 迁移到 App Server | 已完成 |
| 10g-详细实施计划.md         | 12 Sprint 分步实施计划           | 已完成 |

---

_— 文档结束 —_
