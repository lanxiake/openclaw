# AI 个人助理平台 - 实施计划文档 v2.0

> 版本: 2.0 | 创建日期: 2026-02-06 | 状态: 基于现有架构重构

---

## 1. 架构复用分析

### 1.1 现有 OpenClaw 核心能力

经过深入分析，OpenClaw 项目已具备以下生产级能力：

| 能力 | 现有实现 | 复用价值 |
|------|----------|----------|
| Gateway 服务 | `src/gateway/` - WebSocket RPC 服务器 | ⭐⭐⭐⭐⭐ 直接复用 |
| 通信协议 | TypeBox schema + JSON-RPC | ⭐⭐⭐⭐⭐ 直接复用 |
| 插件系统 | `src/plugins/` - 热加载插件框架 | ⭐⭐⭐⭐⭐ 技能系统基础 |
| 多通道支持 | 30+ 消息通道适配器 | ⭐⭐⭐⭐ 选择性复用 |
| AI 代理 | Pi Agent Core 集成 | ⭐⭐⭐⭐⭐ 直接复用 |
| 配置系统 | YAML + Zod 验证 | ⭐⭐⭐⭐⭐ 直接复用 |
| 认证机制 | 设备配对 + JWT Token | ⭐⭐⭐⭐⭐ 直接复用 |
| 消息路由 | `src/routing/` - Session Key 路由 | ⭐⭐⭐⭐ 扩展复用 |
| 工具系统 | `src/agents/tools/` | ⭐⭐⭐⭐⭐ 扩展复用 |
| 日志系统 | 子系统日志 + 结构化日志 | ⭐⭐⭐⭐⭐ 直接复用 |

### 1.2 需求与现有能力映射

| 新需求 | 现有能力 | 实现策略 |
|--------|----------|----------|
| 自然语言控制 | Pi Agent Core + Claude API | 直接复用，定制 Prompt |
| 技能系统 | `src/plugins/` + `src/agents/skills/` | 扩展为服务端/本地双模式 |
| 文件管理 | 无专门实现 | 新建工具，复用工具注册模式 |
| 系统监控 | 部分工具存在 | 新建工具集 |
| 设备配对 | `src/infra/device-pairing.ts` | 直接复用 |
| 敏感操作确认 | `src/infra/exec-approvals.ts` | 直接复用 |
| WebSocket 通信 | `src/gateway/server-ws-runtime.ts` | 直接复用 |
| 用户认证 | `src/gateway/auth.ts` | 扩展支持多认证方式 |

### 1.3 新增开发内容

| 模块 | 说明 | 优先级 |
|------|------|--------|
| Windows 客户端 | Electron 桌面应用 | P0 |
| 技能商店服务 | 技能分发、订阅管理 | P1 |
| 计费系统 | 订阅、按次计费 | P2 |
| Web 管理后台 | 设备管理、技能管理 | P1 |

---

## 2. 重构后的系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ Win 客户端│  │ Web 后台 │  │ 移动 App │  │ 微信/其他 │        │
│  │(Electron)│  │ (React)  │  │(复用iOS) │  │ (复用)   │        │
│  └─────┬────┘  └─────┬────┘  └─────┬────┘  └─────┬────┘        │
└────────┼─────────────┼─────────────┼─────────────┼──────────────┘
         │             │             │             │
         └─────────────┴──────┬──────┴─────────────┘
                              │ WebSocket (复用现有协议)
┌─────────────────────────────┼───────────────────────────────────┐
│                      Gateway 层 (复用 src/gateway/)              │
│  ┌────────────────────────────────────────────────────────────┐│
│  │                    OpenClaw Gateway                        ││
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      ││
│  │  │连接管理   │ │消息路由   │ │ AI 代理  │ │技能加载器│      ││
│  │  │(复用)    │ │(复用)    │ │(复用)    │ │(新增)    │      ││
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘      ││
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      ││
│  │  │认证服务   │ │配置管理   │ │审计日志   │ │技能商店   │      ││
│  │  │(复用)    │ │(复用)    │ │(复用)    │ │(新增)    │      ││
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘      ││
│  └────────────────────────────────────────────────────────────┘│
└─────────────────────────────┬───────────────────────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────┐
│                      客户端层                                    │
│  ┌────────────────────────────────────────────────────────────┐│
│  │              Windows 客户端 (新增 Electron)                 ││
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      ││
│  │  │Gateway   │ │技能执行器 │ │系统服务   │ │ 托盘管理 │      ││
│  │  │Client    │ │(沙箱)    │ │(文件/进程)│ │         │      ││
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘      ││
│  └────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 代码组织结构

```
openclaw/
├── src/                              # 现有核心 (保持不变)
│   ├── gateway/                      # Gateway 服务 ✅ 复用
│   ├── agents/                       # AI 代理 ✅ 复用
│   ├── plugins/                      # 插件系统 ✅ 复用
│   ├── config/                       # 配置管理 ✅ 复用
│   ├── routing/                      # 消息路由 ✅ 复用
│   └── ...
│
├── packages/                         # 新增：AI 助理专用包
│   ├── assistant-skills/             # 技能系统扩展
│   │   ├── loader/                   # 服务端技能加载器
│   │   ├── sandbox/                  # 技能沙箱执行
│   │   ├── store/                    # 技能商店服务
│   │   └── builtin/                  # 内置技能
│   │       ├── file-organizer/
│   │       ├── system-cleaner/
│   │       └── ...
│   │
│   ├── assistant-tools/              # Windows 专用工具
│   │   ├── file-manager/             # 文件管理工具
│   │   ├── system-monitor/           # 系统监控工具
│   │   ├── process-manager/          # 进程管理工具
│   │   └── automation/               # 自动化工具
│   │
│   └── assistant-shared/             # 共享类型和工具
│       ├── types/
│       └── utils/
│
├── apps/
│   ├── macos/                        # 现有 macOS 应用 ✅
│   ├── ios/                          # 现有 iOS 应用 ✅
│   ├── android/                      # 现有 Android 应用 ✅
│   │
│   └── windows/                      # 新增：Windows 客户端
│       ├── src/
│       │   ├── main/                 # Electron 主进程
│       │   │   ├── gateway-client.ts # WebSocket 客户端
│       │   │   ├── skill-executor.ts # 技能执行器
│       │   │   ├── system-service.ts # 系统服务
│       │   │   └── tray-manager.ts   # 托盘管理
│       │   ├── renderer/             # 渲染进程 (React)
│       │   └── preload/              # 预加载脚本
│       ├── electron-builder.json
│       └── package.json
│
└── skills/                           # 官方技能库 (新增目录结构)
    ├── server/                       # 服务端技能
    │   ├── file-organizer/
    │   ├── system-cleaner/
    │   └── ...
    └── templates/                    # 技能模板
        └── skill-template/
```

---

## 3. 分阶段实施计划

### Phase 1: 基础架构适配 (复用为主)

**目标**: 在现有架构上搭建 AI 助理的基础能力

#### 1.1 Gateway 扩展

| 任务 | 复用/新增 | 文件位置 | 说明 |
|------|----------|----------|------|
| 添加 Windows 客户端 RPC 方法 | 扩展 | `src/gateway/server-methods/` | 新增 `assistant.*` 方法 |
| 技能加载协议 | 新增 | `src/gateway/protocol/schema/skills.ts` | TypeBox schema |
| 敏感操作确认流程 | 复用 | `src/infra/exec-approvals.ts` | 适配 Windows 场景 |

**复用代码示例**:
```typescript
// 复用现有的 RPC 方法注册模式 (src/gateway/server-methods.ts)
export const assistantMethods = {
  'assistant.fileList': fileListHandler,
  'assistant.fileMove': fileMoveHandler,
  'assistant.skillExecute': skillExecuteHandler,
  // ...
}
```

#### 1.2 Windows 客户端框架

| 任务 | 说明 | 依赖 |
|------|------|------|
| Electron 项目初始化 | 基于 `apps/macos` 结构参考 | - |
| WebSocket 客户端 | 复用协议，新建客户端 | `src/gateway/protocol/` |
| 系统托盘 | 类似 macOS 菜单栏应用 | - |
| 自动更新 | electron-updater | - |

#### 1.3 任务清单

| # | 任务 | 复用率 | 优先级 | 状态 |
|---|------|--------|--------|------|
| 1.1 | 创建 `apps/windows/` 目录结构 | 参考 | P0 | 待开始 |
| 1.2 | 实现 GatewayClient (WebSocket) | 80% | P0 | 待开始 |
| 1.3 | 复用设备配对流程 | 100% | P0 | 待开始 |
| 1.4 | 复用认证机制 | 100% | P0 | 待开始 |
| 1.5 | 实现系统托盘 | 参考 | P0 | 待开始 |
| 1.6 | 添加 assistant.* RPC 方法 | 扩展 | P0 | 待开始 |
| 1.7 | 配置 Electron 打包 | 新增 | P1 | 待开始 |

---

### Phase 2: 核心功能开发

**目标**: 实现 AI 对话和基础系统控制

#### 2.1 AI 代理适配

| 任务 | 复用/新增 | 说明 |
|------|----------|------|
| 复用 Pi Agent Core | 100% 复用 | `src/agents/` |
| 定制 Windows 助理 Prompt | 新增 | 系统控制场景 |
| 工具注册 | 复用模式 | 注册 Windows 工具 |

**复用代码示例**:
```typescript
// 复用工具注册模式 (src/agents/tools/common.ts)
import { readStringParam, readNumberParam } from '@/agents/tools/common'

export const fileListTool: AnyAgentTool = {
  name: 'file_list',
  description: '列出指定目录下的文件',
  parameters: FileListParamsSchema,
  async execute(params) {
    const path = readStringParam(params, 'path', { required: true })
    // 实现...
  }
}
```

#### 2.2 系统工具集

| 工具 | 位置 | 功能 |
|------|------|------|
| file_list | `packages/assistant-tools/file-manager/` | 列出文件 |
| file_read | 同上 | 读取文件 |
| file_write | 同上 | 写入文件 |
| file_move | 同上 | 移动/重命名 |
| file_delete | 同上 | 删除文件 |
| system_info | `packages/assistant-tools/system-monitor/` | 系统信息 |
| process_list | `packages/assistant-tools/process-manager/` | 进程列表 |
| process_kill | 同上 | 结束进程 |
| app_launch | `packages/assistant-tools/automation/` | 启动程序 |

#### 2.3 任务清单

| # | 任务 | 复用率 | 优先级 | 状态 |
|---|------|--------|--------|------|
| 2.1 | 创建 Windows 助理代理配置 | 扩展 | P0 | 待开始 |
| 2.2 | 实现文件管理工具集 | 模式复用 | P0 | 待开始 |
| 2.3 | 实现系统监控工具集 | 模式复用 | P1 | 待开始 |
| 2.4 | 实现进程管理工具集 | 模式复用 | P1 | 待开始 |
| 2.5 | 实现敏感操作确认 UI | 新增 | P0 | 待开始 |
| 2.6 | 客户端对话界面 | 新增 | P0 | 待开始 |
| 2.7 | 复用审计日志系统 | 100% | P1 | 待开始 |

---

### Phase 3: 技能系统开发

**目标**: 实现服务端技能 + 本地技能双模式

#### 3.1 技能架构

```
技能系统架构 (基于 src/plugins/ 扩展)

┌─────────────────────────────────────────────┐
│                  技能管理器                  │
│  ┌─────────────────┐ ┌─────────────────┐   │
│  │  服务端技能加载器 │ │  本地技能加载器  │   │
│  │  (新增)         │ │  (复用 plugins) │   │
│  └────────┬────────┘ └────────┬────────┘   │
│           │                    │            │
│  ┌────────┴────────────────────┴────────┐  │
│  │            技能沙箱执行器              │  │
│  │   (基于 src/agents/skills/ 扩展)     │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

#### 3.2 复用现有技能系统

```typescript
// 复用 src/agents/skills/types.ts 的模式
interface AssistantSkill {
  id: string
  name: string
  version: string
  type: 'server' | 'local'

  // 复用现有元数据结构
  metadata: {
    requires?: {
      bins?: string[]
      env?: string[]
    }
    install?: SkillInstallSpec[]
  }

  // 新增：订阅信息
  subscription?: {
    required: boolean
    price?: number
    period?: 'monthly' | 'yearly' | 'once'
  }
}
```

#### 3.3 任务清单

| # | 任务 | 复用率 | 优先级 | 状态 |
|---|------|--------|--------|------|
| 3.1 | 设计技能 schema (扩展 TypeBox) | 扩展 | P0 | 待开始 |
| 3.2 | 实现服务端技能加载器 | 30% | P0 | 待开始 |
| 3.3 | 复用/扩展技能沙箱 | 70% | P0 | 待开始 |
| 3.4 | 本地技能管理 (复用 plugins) | 90% | P1 | 待开始 |
| 3.5 | 开发内置技能：文件整理 | 新增 | P1 | 待开始 |
| 3.6 | 开发内置技能：系统清理 | 新增 | P2 | 待开始 |
| 3.7 | 技能商店后端 API | 新增 | P1 | 待开始 |
| 3.8 | 技能商店前端 | 新增 | P2 | 待开始 |

---

### Phase 4: 商业化与优化

**目标**: 完成计费系统、安全加固、正式发布

#### 4.1 任务清单

| # | 任务 | 复用率 | 优先级 | 状态 |
|---|------|--------|--------|------|
| 4.1 | 用户订阅系统 | 新增 | P0 | 待开始 |
| 4.2 | 支付对接 | 新增 | P0 | 待开始 |
| 4.3 | 安全审计 | 复用模式 | P0 | 待开始 |
| 4.4 | 性能优化 | - | P1 | 待开始 |
| 4.5 | Windows 安装包 (NSIS) | 新增 | P0 | 待开始 |
| 4.6 | 自动更新机制 | 复用模式 | P1 | 待开始 |
| 4.7 | 用户文档 | 新增 | P1 | 待开始 |

---

## 4. 关键复用清单

### 4.1 直接复用 (100%)

| 模块 | 文件 | 用途 |
|------|------|------|
| WebSocket 协议 | `src/gateway/protocol/` | 通信协议定义 |
| TypeBox Schema | `src/gateway/protocol/schema/` | 类型验证 |
| 配置系统 | `src/config/` | 配置加载和验证 |
| 设备配对 | `src/infra/device-pairing.ts` | 二维码配对 |
| 认证机制 | `src/gateway/auth.ts` | JWT Token |
| 审计日志 | `src/logging/` | 结构化日志 |
| 重试逻辑 | `src/infra/retry.ts` | 网络重试 |
| 执行审批 | `src/infra/exec-approvals.ts` | 敏感操作确认 |

### 4.2 模式复用 (70-90%)

| 模块 | 文件 | 复用方式 |
|------|------|----------|
| 工具注册 | `src/agents/tools/common.ts` | 参数读取、结果处理 |
| 技能系统 | `src/agents/skills/` | 技能定义、元数据结构 |
| 插件加载 | `src/plugins/loader.ts` | 动态加载模式 |
| 消息路由 | `src/routing/` | Session Key 模式 |
| 依赖注入 | `src/cli/deps.ts` | DI 模式 |

### 4.3 参考实现 (30-50%)

| 模块 | 参考来源 | 说明 |
|------|----------|------|
| Windows 客户端 | `apps/macos/` | 应用结构参考 |
| 系统托盘 | macOS 菜单栏 | UI 交互参考 |
| 客户端 UI | - | 需要全新设计 |

---

## 5. 技术决策

### 5.1 确定复用

| 决策 | 理由 |
|------|------|
| 复用 Gateway 架构 | 生产级稳定，功能完善 |
| 复用 TypeBox Schema | 类型安全，运行时验证 |
| 复用 Pi Agent Core | AI 能力成熟，工具调用完善 |
| 复用插件系统 | 技能系统天然基础 |
| 复用配置系统 | YAML + 热重载，用户友好 |

### 5.2 需要新增

| 模块 | 理由 |
|------|------|
| Windows Electron 客户端 | 目标平台 |
| 服务端技能加载 | 核心业务需求 |
| 技能商店 | 商业模式需求 |
| 计费系统 | 商业模式需求 |

### 5.3 架构约束

1. **保持向后兼容**: 不破坏现有 OpenClaw 功能
2. **模块化扩展**: 新功能作为独立 package
3. **类型安全**: 继续使用 TypeScript + TypeBox
4. **配置驱动**: 新功能通过配置启用

---

## 6. 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Windows API 兼容性 | 中 | 充分测试 Win10/11 |
| 技能沙箱安全 | 高 | 复用现有沙箱 + 增强 |
| 与现有代码冲突 | 中 | 独立 package，最小侵入 |
| Electron 包体积 | 低 | 优化依赖，延迟加载 |

---

## 7. 里程碑总结

| 里程碑 | 目标 | 复用率 | 新增代码估算 |
|--------|------|--------|--------------|
| M1 Phase 1 | 基础架构 | ~80% | ~3000 行 |
| M2 Phase 2 | 核心功能 | ~60% | ~5000 行 |
| M3 Phase 3 | 技能系统 | ~50% | ~6000 行 |
| M4 Phase 4 | 商业化 | ~30% | ~4000 行 |
| **总计** | | **~55%** | **~18000 行** |

**相比从零开始预估 (40000+ 行)，复用现有架构可节省约 55% 的开发工作量。**

---

*— 文档结束 —*
