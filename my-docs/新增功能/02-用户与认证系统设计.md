# OpenClaw AI 个人助理平台 - 用户与认证系统设计

> 版本: 1.0 | 创建日期: 2026-02-08 | 状态: 整合版
>
> 本文档整合用户管理、认证授权、订阅计费系统设计

---

## 修订记录

| 版本 | 日期       | 修订内容                    |
| ---- | ---------- | --------------------------- |
| 1.0  | 2026-02-08 | 整合 05-用户管理系统设计.md |

---

## 1. 概述

### 1.1 背景

现有 OpenClaw 代码采用**设备配对 + 会话隔离**模式，缺少完整的用户账号体系。本文档设计用户管理系统，补充以下能力：

| 设计文档描述             | 现有实现                 | 本文档补充        |
| ------------------------ | ------------------------ | ----------------- |
| PostgreSQL 存储用户数据  | JSON 文件存储            | ✅ 完整数据库设计 |
| User 实体 (phone, email) | 基于设备配对，无用户实体 | ✅ 用户账号体系   |
| JWT Token                | 简单 Token，非标准 JWT   | ✅ 标准 JWT 认证  |
| Subscription 订阅系统    | 未实现                   | ✅ 订阅与计费系统 |
| AuditLog 审计日志        | 操作日志但非数据库存储   | ✅ 结构化审计系统 |

### 1.2 设计原则

1. **渐进式集成** - 与现有 Gateway 认证、设备配对机制兼容
2. **最小侵入** - 新增模块，不修改现有核心代码
3. **职责分离** - 用户管身份，设备管权限
4. **可扩展性** - 支持未来多租户、企业版扩展
5. **安全优先** - 遵循 OWASP 安全最佳实践

### 1.3 核心设计决策

#### 用户与设备的职责分离

```
┌─────────────────────────────────────────────────────────────────┐
│                      核心设计原则                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   用户 (User)              设备 (Device)                        │
│   ├── 身份标识             ├── 操作权限 (role, scopes)          │
│   ├── 登录凭据             ├── 设备 Token                       │
│   ├── 订阅状态             ├── 平台信息                         │
│   └── 个人资料             └── 最后活跃时间                      │
│                                                                 │
│   用户登录 → 获取 User Token (用于身份验证)                      │
│   设备配对 → 获取 Device Token (用于操作授权)                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 数据库设计

### 2.1 用户表 (users)

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 登录凭据 (至少一个)
  phone VARCHAR(20) UNIQUE,
  email VARCHAR(255) UNIQUE,
  password_hash VARCHAR(255),

  -- 用户资料
  display_name VARCHAR(100),
  avatar_url VARCHAR(500),
  timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
  locale VARCHAR(10) DEFAULT 'zh-CN',

  -- 账户状态
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  is_phone_verified BOOLEAN DEFAULT FALSE,
  is_email_verified BOOLEAN DEFAULT FALSE,
  mfa_enabled BOOLEAN DEFAULT FALSE,
  mfa_secret VARCHAR(100),

  -- 时间戳
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  last_login_at TIMESTAMPTZ,

  -- 约束
  CONSTRAINT users_has_identifier CHECK (phone IS NOT NULL OR email IS NOT NULL)
);

-- 索引
CREATE INDEX idx_users_phone ON users(phone) WHERE phone IS NOT NULL;
CREATE INDEX idx_users_email ON users(email) WHERE email IS NOT NULL;
CREATE INDEX idx_users_status ON users(status);
```

### 2.2 设备表 (devices)

```sql
CREATE TABLE devices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- 设备信息
  display_name VARCHAR(100) NOT NULL,
  platform VARCHAR(20) NOT NULL,
  os_version VARCHAR(50),
  app_version VARCHAR(20),
  device_fingerprint VARCHAR(255) NOT NULL,

  -- 权限控制
  role VARCHAR(20) NOT NULL DEFAULT 'member',
  scopes TEXT[] DEFAULT '{}',

  -- 状态
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  last_active_at TIMESTAMPTZ,

  -- 时间戳
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- 唯一约束
  UNIQUE(user_id, device_fingerprint)
);

-- 索引
CREATE INDEX idx_devices_user_id ON devices(user_id);
CREATE INDEX idx_devices_fingerprint ON devices(device_fingerprint);
CREATE INDEX idx_devices_status ON devices(status);
```

### 2.3 订阅计划表 (subscription_plans)

```sql
CREATE TABLE subscription_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  code VARCHAR(50) NOT NULL UNIQUE,
  description TEXT,
  price INTEGER NOT NULL DEFAULT 0,
  period VARCHAR(20) NOT NULL,
  features JSONB DEFAULT '[]',
  limits JSONB DEFAULT '{}',
  is_active BOOLEAN DEFAULT TRUE,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- limits 结构示例
-- {
--   "devices": 3,
--   "skills": 10,
--   "dailyCalls": 1000,
--   "storage": 1073741824
-- }
```

### 2.4 用户订阅表 (subscriptions)

```sql
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  plan_id UUID NOT NULL REFERENCES subscription_plans(id),

  -- 订阅状态
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  start_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  end_at TIMESTAMPTZ,
  auto_renew BOOLEAN DEFAULT TRUE,

  -- 支付信息
  payment_method VARCHAR(50),
  last_payment_at TIMESTAMPTZ,
  next_payment_at TIMESTAMPTZ,

  -- 时间戳
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  cancelled_at TIMESTAMPTZ,

  -- 唯一约束
  UNIQUE(user_id, status) WHERE status = 'active'
);

-- 索引
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
CREATE INDEX idx_subscriptions_end_at ON subscriptions(end_at);
```

### 2.5 审计日志表 (audit_logs)

```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  device_id UUID REFERENCES devices(id),

  -- 操作信息
  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50) NOT NULL,
  resource_id VARCHAR(100),

  -- 详情
  before_data JSONB,
  after_data JSONB,
  metadata JSONB,

  -- 来源
  ip_address VARCHAR(50),
  user_agent TEXT,

  -- 时间戳
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
```

### 2.6 ER 图

```
┌─────────────────┐         ┌─────────────────┐
│     users       │         │    devices      │
├─────────────────┤         ├─────────────────┤
│ id (PK)         │────────<│ user_id (FK)    │
│ phone           │         │ display_name    │
│ email           │         │ platform        │
│ password_hash   │         │ role            │
│ display_name    │         │ scopes          │
│ status          │         │ status          │
└────────┬────────┘         └─────────────────┘
         │
         │         ┌─────────────────┐
         │         │  subscriptions  │
         └────────>├─────────────────┤
                   │ user_id (FK)    │
                   │ plan_id (FK)    │
                   │ status          │
                   │ start_at        │
                   │ end_at          │
                   └────────┬────────┘
                            │
         ┌──────────────────┘
         │
         ▼
┌─────────────────┐         ┌─────────────────┐
│subscription_plans│        │   audit_logs    │
├─────────────────┤         ├─────────────────┤
│ id (PK)         │         │ user_id (FK)    │
│ name            │         │ device_id (FK)  │
│ code            │         │ action          │
│ price           │         │ resource_type   │
│ limits          │         │ created_at      │
└─────────────────┘         └─────────────────┘
```

---

## 3. 认证系统设计

### 3.1 认证流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      认证流程                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 用户注册/登录                                                │
│     ┌──────────┐    验证码/密码    ┌──────────┐                 │
│     │  客户端   │ ───────────────> │  Gateway │                 │
│     └──────────┘                   └────┬─────┘                 │
│                                         │                       │
│  2. 返回 User Token                     │                       │
│     ┌──────────┐    JWT Token     ┌────┴─────┐                 │
│     │  客户端   │ <─────────────── │  Gateway │                 │
│     └──────────┘                   └──────────┘                 │
│                                                                 │
│  3. 设备配对 (首次)                                              │
│     ┌──────────┐    配对码+Token   ┌──────────┐                 │
│     │  客户端   │ ───────────────> │  Gateway │                 │
│     └──────────┘                   └────┬─────┘                 │
│                                         │                       │
│  4. 返回 Device Token                   │                       │
│     ┌──────────┐   Device Token   ┌────┴─────┘                 │
│     │  客户端   │ <─────────────── │  Gateway │                 │
│     └──────────┘                   └──────────┘                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Token 设计

#### User Token (用于身份验证)

```typescript
interface UserTokenPayload {
  sub: string; // 用户 ID
  type: "user";
  iat: number; // 签发时间
  exp: number; // 过期时间 (24小时)
}
```

#### Device Token (用于操作授权)

```typescript
interface DeviceTokenPayload {
  sub: string; // 设备 ID
  type: "device";
  userId: string; // 所属用户 ID
  role: string; // 设备角色
  scopes: string[]; // 权限范围
  iat: number;
  exp: number; // 过期时间 (7天)
}
```

### 3.3 权限范围 (Scopes)

| Scope            | 描述         | 默认授予 |
| ---------------- | ------------ | -------- |
| `file.read`      | 读取文件     | ✓        |
| `file.write`     | 写入文件     | ✓        |
| `file.delete`    | 删除文件     | -        |
| `system.read`    | 读取系统信息 | ✓        |
| `system.control` | 控制系统     | -        |
| `process.read`   | 读取进程列表 | ✓        |
| `process.kill`   | 结束进程     | -        |
| `skill.execute`  | 执行技能     | ✓        |
| `skill.install`  | 安装技能     | -        |

---

## 4. 认证 API 设计

### 4.1 用户注册

```
POST /api/v1/auth/register

请求体:
{
  "phone": "+8613800138000",  // 或 email
  "code": "123456",           // 验证码
  "password": "optional",     // 可选密码
  "displayName": "用户名"
}

响应:
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid",
      "phone": "+8613800138000",
      "displayName": "用户名"
    },
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
    "expiresIn": 86400
  }
}
```

### 4.2 用户登录

```
POST /api/v1/auth/login

请求体:
{
  "identifier": "+8613800138000",  // 手机号或邮箱
  "password": "password123",       // 或 code: "123456"
}

响应:
{
  "success": true,
  "data": {
    "user": { ... },
    "accessToken": "...",
    "refreshToken": "...",
    "expiresIn": 86400
  }
}
```

### 4.3 设备配对

```
POST /api/v1/devices/pair

请求头:
Authorization: Bearer <userToken>

请求体:
{
  "pairingCode": "ABC123",
  "deviceInfo": {
    "displayName": "我的电脑",
    "platform": "windows",
    "osVersion": "Windows 11",
    "appVersion": "1.0.0",
    "fingerprint": "device-fingerprint-hash"
  }
}

响应:
{
  "success": true,
  "data": {
    "device": {
      "id": "uuid",
      "displayName": "我的电脑",
      "role": "member",
      "scopes": ["file.read", "file.write", ...]
    },
    "deviceToken": "eyJhbGciOiJIUzI1NiIs...",
    "expiresIn": 604800
  }
}
```

### 4.4 刷新令牌

```
POST /api/v1/auth/refresh

请求体:
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIs..."
}

响应:
{
  "success": true,
  "data": {
    "accessToken": "...",
    "expiresIn": 86400
  }
}
```

---

## 5. 订阅系统设计

### 5.1 订阅计划

| 计划   | 代码       | 价格     | 设备数 | 技能数 | 日调用量 |
| ------ | ---------- | -------- | ------ | ------ | -------- |
| 免费版 | free       | ¥0       | 1      | 3      | 100      |
| 专业版 | pro        | ¥29.9/月 | 5      | 无限   | 无限     |
| 团队版 | team       | ¥99/月   | 20     | 无限   | 无限     |
| 企业版 | enterprise | 按需     | 无限   | 无限   | 无限     |

### 5.2 订阅 API

#### 获取当前订阅

```
GET /api/v1/subscription

请求头:
Authorization: Bearer <userToken>

响应:
{
  "success": true,
  "data": {
    "subscription": {
      "id": "uuid",
      "plan": {
        "id": "uuid",
        "name": "专业版",
        "code": "pro"
      },
      "status": "active",
      "startAt": "2026-02-01T00:00:00Z",
      "endAt": "2026-03-01T00:00:00Z",
      "autoRenew": true
    },
    "usage": {
      "devices": { "used": 2, "limit": 5 },
      "skills": { "used": 8, "limit": -1 },
      "dailyCalls": { "used": 156, "limit": -1 }
    }
  }
}
```

#### 订阅/升级计划

```
POST /api/v1/subscription/subscribe

请求头:
Authorization: Bearer <userToken>

请求体:
{
  "planCode": "pro",
  "period": "month",
  "paymentMethod": "wechat"
}

响应:
{
  "success": true,
  "data": {
    "orderId": "uuid",
    "paymentUrl": "https://...",
    "amount": 2990
  }
}
```

---

## 6. 安全机制

### 6.1 密码安全

- 使用 bcrypt 加密存储，cost factor = 12
- 密码强度要求：最少 8 位，包含字母和数字
- 登录失败 5 次后锁定 30 分钟

### 6.2 Token 安全

- Access Token 有效期 24 小时
- Refresh Token 有效期 30 天
- Device Token 有效期 7 天
- 支持 Token 撤销（黑名单机制）

### 6.3 验证码安全

- 验证码有效期 5 分钟
- 同一手机号/邮箱 60 秒内只能发送一次
- 验证码错误 5 次后锁定 30 分钟

### 6.4 设备安全

- 设备指纹绑定，防止 Token 盗用
- 异常登录检测（IP、地理位置）
- 支持远程登出设备

---

## 7. TypeScript 类型定义

### 7.1 用户类型

```typescript
interface User {
  id: string;
  phone?: string;
  email?: string;
  displayName?: string;
  avatarUrl?: string;
  timezone: string;
  locale: string;
  status: "active" | "suspended" | "deleted";
  isPhoneVerified: boolean;
  isEmailVerified: boolean;
  mfaEnabled: boolean;
  createdAt: string;
  updatedAt: string;
  lastLoginAt?: string;
}
```

### 7.2 设备类型

```typescript
interface Device {
  id: string;
  userId: string;
  displayName: string;
  platform: "windows" | "macos" | "linux" | "ios" | "android" | "web";
  osVersion?: string;
  appVersion?: string;
  role: "owner" | "admin" | "member";
  scopes: string[];
  status: "active" | "inactive" | "revoked";
  lastActiveAt?: string;
  createdAt: string;
}
```

### 7.3 订阅类型

```typescript
interface Subscription {
  id: string;
  userId: string;
  plan: SubscriptionPlan;
  status: "active" | "expired" | "cancelled" | "past_due";
  startAt: string;
  endAt?: string;
  autoRenew: boolean;
  paymentMethod?: string;
  createdAt: string;
}

interface SubscriptionPlan {
  id: string;
  name: string;
  code: string;
  description?: string;
  price: number;
  period: "month" | "year";
  features: string[];
  limits: {
    devices: number;
    skills: number;
    dailyCalls: number;
    storage?: number;
  };
}
```

---

## 8. 数据迁移策略

### 8.1 从现有系统迁移

1. **设备数据迁移**
   - 读取现有 JSON 配置中的设备信息
   - 为每个设备创建临时用户账号
   - 保持设备 Token 兼容

2. **会话数据迁移**
   - 保留现有会话机制
   - 逐步引导用户绑定账号

3. **配置数据迁移**
   - 用户配置迁移到数据库
   - 保留本地配置作为缓存

### 8.2 迁移脚本

```typescript
// scripts/migrate-users.ts
async function migrateUsers() {
  // 1. 读取现有设备配置
  const devices = await readExistingDevices();

  // 2. 为每个设备创建用户
  for (const device of devices) {
    const user = await createTemporaryUser(device);
    await linkDeviceToUser(device, user);
  }

  // 3. 生成迁移报告
  await generateMigrationReport();
}
```

---

_— 文档结束 —_
