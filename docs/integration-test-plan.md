# 前后端联调测试计划

## 测试概述

**测试目标**: 验证用户认证和管理员认证功能的前后端集成

**测试范围**:

- 用户注册、登录、Token 刷新、登出
- 管理员登录、Token 刷新、登出
- 安全特性（限流、账户锁定、MFA）

**测试环境**:

- 后端: Gateway 服务 (端口 18789)
- 前端: Web Admin 应用 (端口 5173)
- 数据库: PostgreSQL (10.157.152.40:22001)

---

## 测试前准备

### ✅ 准备工作检查清单

- [ ] 数据库连接配置正确 (.env 文件)
- [ ] 数据库 Schema 迁移已应用
- [ ] 测试账号已创建
- [ ] 后端 Gateway 服务可以启动
- [ ] 前端 Web Admin 应用可以启动
- [ ] 单元测试已通过（44 个测试用例）

### 📋 测试凭据

#### 用户账号

- **邮箱**: `test@example.com`
- **密码**: `TestP@ssw0rd123`
- **用途**: 测试普通用户登录流程

#### 管理员账号

- **用户名**: `testadmin`
- **密码**: `AdminP@ssw0rd123`
- **角色**: `admin`
- **用途**: 测试管理员登录流程

---

## 测试阶段

## 阶段 1: 环境准备 (预计 10 分钟)

### 1.1 数据库迁移

**目标**: 应用 Schema 差异修复迁移

**步骤**:

```bash
psql "postgresql://openclaw_admin:Oc%402026!Pg%23Secure@10.157.152.40:22001/openclaw_prod" \
  -f src/db/migrations/0006_fix_all_schema_differences.sql
```

**验证标准**:

- [ ] 迁移脚本执行成功，无错误
- [ ] 验证脚本输出 "✓ Schema 差异修复迁移成功完成"
- [ ] 数据库表结构已更新

**预期结果**: 所有 Schema 差异已修复

**实际结果**: _待填写_

**问题记录**: _待填写_

---

### 1.2 创建测试账号

**目标**: 创建用于测试的用户和管理员账号

**步骤**:

```bash
bun run scripts/integration-test.ts
```

**验证标准**:

- [ ] 脚本执行成功
- [ ] 测试用户创建成功
- [ ] 测试管理员创建成功
- [ ] 登录验证通过

**预期结果**:

- 输出测试凭据信息
- 所有步骤显示 ✅ 成功标记

**实际结果**: _待填写_

**问题记录**: _待填写_

---

### 1.3 启动后端服务

**目标**: 启动 Gateway 服务

**步骤**:

```bash
pnpm dev:gateway
```

**验证标准**:

- [ ] 服务启动成功，无错误
- [ ] 监听端口 18789
- [ ] 健康检查接口可访问

**健康检查**:

```bash
curl http://localhost:18789/health
```

**预期结果**: 返回健康状态 JSON

**实际结果**: _待填写_

**问题记录**: _待填写_

---

### 1.4 启动前端应用

**目标**: 启动 Web Admin 前端应用

**步骤**:

```bash
cd apps/web-admin
pnpm dev
```

**验证标准**:

- [ ] 应用启动成功
- [ ] 监听端口 5173
- [ ] 浏览器可以访问

**访问地址**: http://localhost:5173

**预期结果**: 显示登录页面

**实际结果**: _待填写_

**问题记录**: _待填写_

---

## 阶段 2: 用户认证功能测试 (预计 20 分钟)

### 2.1 用户登录 - 成功场景

**测试用例 ID**: TC-USER-001

**测试目标**: 验证用户可以使用正确的邮箱和密码登录

**前置条件**:

- 前后端服务已启动
- 测试用户账号已创建

**测试步骤**:

1. 打开浏览器访问 http://localhost:5173
2. 在登录表单中输入邮箱: `test@example.com`
3. 输入密码: `TestP@ssw0rd123`
4. 点击"登录"按钮

**验证点**:

- [ ] 登录请求发送成功（查看浏览器 Network 面板）
- [ ] 返回状态码 200
- [ ] 响应包含 `accessToken`
- [ ] 响应包含 `refreshToken`
- [ ] 响应包含用户信息 (`user` 对象)
- [ ] 页面跳转到用户主页/仪表板
- [ ] 用户信息正确显示（邮箱、显示名称）
- [ ] Token 存储到 localStorage/sessionStorage

**预期结果**:

- 登录成功
- 获得有效的 Access Token 和 Refresh Token
- 用户信息正确显示

**实际结果**: _待填写_

**截图**: _待上传_

**问题记录**: _待填写_

---

### 2.2 用户登录 - 失败场景（错误密码）

**测试用例 ID**: TC-USER-002

**测试目标**: 验证使用错误密码无法登录

**测试步骤**:

1. 访问登录页面
2. 输入邮箱: `test@example.com`
3. 输入错误密码: `WrongPassword123`
4. 点击"登录"按钮

**验证点**:

- [ ] 返回错误响应
- [ ] 错误码为 `INVALID_CREDENTIALS`
- [ ] 显示错误提示: "账号或密码错误"
- [ ] 不跳转页面
- [ ] 不存储 Token

**预期结果**: 登录失败，显示错误提示

**实际结果**: _待填写_

**问题记录**: _待填写_

---

### 2.3 用户登录 - 失败场景（账户锁定）

**测试用例 ID**: TC-USER-003

**测试目标**: 验证多次登录失败后账户被锁定

**测试步骤**:

1. 使用错误密码连续登录 5 次
2. 第 6 次使用正确密码登录

**验证点**:

- [ ] 前 5 次返回 `INVALID_CREDENTIALS` 错误
- [ ] 第 6 次返回 `ACCOUNT_LOCKED` 错误
- [ ] 错误提示包含锁定时间信息
- [ ] 等待锁定时间后可以正常登录

**预期结果**:

- 账户被临时锁定 15 分钟
- 显示锁定提示信息

**实际结果**: _待填写_

**问题记录**: _待填写_

---

### 2.4 Token 自动刷新

**测试用例 ID**: TC-USER-004

**测试目标**: 验证 Access Token 过期前自动刷新

**前置条件**: 用户已登录

**测试步骤**:

1. 登录成功后，记录 Access Token
2. 等待接近 Token 过期时间（默认 15 分钟）
3. 发起需要认证的 API 请求

**验证点**:

- [ ] 前端自动检测 Token 即将过期
- [ ] 自动调用 Token 刷新接口
- [ ] 使用 Refresh Token 获取新的 Access Token
- [ ] 新 Token 存储成功
- [ ] 原 API 请求使用新 Token 重试成功

**预期结果**: Token 自动刷新，用户无感知

**实际结果**: _待填写_

**问题记录**: _待填写_

---

### 2.5 用户登出

**测试用例 ID**: TC-USER-005

**测试目标**: 验证用户可以正常登出

**前置条件**: 用户已登录

**测试步骤**:

1. 点击"登出"按钮
2. 观察页面变化

**验证点**:

- [ ] 调用登出 API 成功
- [ ] 服务器端会话被撤销
- [ ] 本地 Token 被清除
- [ ] 页面跳转到登录页
- [ ] 使用旧 Token 无法访问受保护资源

**预期结果**:

- 登出成功
- Token 失效
- 跳转到登录页

**实际结果**: _待填写_

**问题记录**: _待填写_

---

## 阶段 3: 管理员认证功能测试 (预计 20 分钟)

### 3.1 管理员登录 - 成功场景

**测试用例 ID**: TC-ADMIN-001

**测试目标**: 验证管理员可以使用正确的用户名和密码登录

**测试步骤**:

1. 访问管理员登录页面: http://localhost:5173/admin/login
2. 输入用户名: `testadmin`
3. 输入密码: `AdminP@ssw0rd123`
4. 点击"登录"按钮

**验证点**:

- [ ] 登录请求发送成功
- [ ] 返回状态码 200
- [ ] 响应包含 `accessToken`
- [ ] 响应包含 `refreshToken`
- [ ] 响应包含管理员信息（包含 `role` 字段）
- [ ] 页面跳转到管理员控制台
- [ ] 管理员菜单正确显示
- [ ] 权限控制正常工作

**预期结果**:

- 管理员登录成功
- 显示管理员专属界面

**实际结果**: _待填写_

**截图**: _待上传_

**问题记录**: _待填写_

---

### 3.2 管理员登录 - 失败场景（错误密码）

**测试用例 ID**: TC-ADMIN-002

**测试目标**: 验证使用错误密码无法登录

**测试步骤**:

1. 访问管理员登录页面
2. 输入用户名: `testadmin`
3. 输入错误密码: `WrongPassword123`
4. 点击"登录"按钮

**验证点**:

- [ ] 返回错误响应
- [ ] 错误码为 `INVALID_CREDENTIALS`
- [ ] 显示错误提示
- [ ] 失败次数计数增加

**预期结果**: 登录失败，显示错误提示

**实际结果**: _待填写_

**问题记录**: _待填写_

---

### 3.3 管理员账户锁定

**测试用例 ID**: TC-ADMIN-003

**测试目标**: 验证多次登录失败后管理员账户被锁定

**测试步骤**:

1. 使用错误密码连续登录 5 次
2. 第 6 次使用正确密码登录

**验证点**:

- [ ] 前 5 次返回 `INVALID_CREDENTIALS` 错误
- [ ] 第 6 次返回 `ACCOUNT_LOCKED` 错误
- [ ] 错误提示包含锁定时间（30 分钟）
- [ ] 审计日志记录账户锁定事件

**预期结果**:

- 账户被锁定 30 分钟
- 审计日志记录完整

**实际结果**: _待填写_

**问题记录**: _待填写_

---

### 3.4 管理员 Token 刷新

**测试用例 ID**: TC-ADMIN-004

**测试目标**: 验证管理员 Token 自动刷新

**前置条件**: 管理员已登录

**测试步骤**:

1. 登录成功后，记录 Access Token
2. 等待接近 Token 过期时间
3. 发起管理员 API 请求

**验证点**:

- [ ] Token 自动刷新成功
- [ ] 新 Token 包含管理员角色信息
- [ ] 权限验证正常

**预期结果**: Token 自动刷新，权限保持

**实际结果**: _待填写_

**问题记录**: _待填写_

---

### 3.5 管理员登出所有设备

**测试用例 ID**: TC-ADMIN-005

**测试目标**: 验证管理员可以登出所有设备

**前置条件**:

- 管理员在多个设备/浏览器登录

**测试步骤**:

1. 在设备 A 登录
2. 在设备 B 登录
3. 在设备 A 点击"登出所有设备"

**验证点**:

- [ ] 调用 `logoutAll` API 成功
- [ ] 所有设备的会话被撤销
- [ ] 设备 B 的 Token 失效
- [ ] 设备 B 被强制跳转到登录页

**预期结果**:

- 所有设备登出成功
- 审计日志记录完整

**实际结果**: _待填写_

**问题记录**: _待填写_

---

## 阶段 4: 安全特性测试 (预计 15 分钟)

### 4.1 IP 级别限流

**测试用例 ID**: TC-SEC-001

**测试目标**: 验证 IP 级别的登录限流

**测试步骤**:

1. 从同一 IP 使用不同账号连续失败登录 20 次
2. 第 21 次尝试登录

**验证点**:

- [ ] 前 20 次返回 `INVALID_CREDENTIALS`
- [ ] 第 21 次返回 `IP_RATE_LIMITED`
- [ ] 错误提示: "请求过于频繁，请稍后重试"
- [ ] 限制持续 1 小时

**预期结果**: IP 被限制，无法继续登录

**实际结果**: _待填写_

**问题记录**: _待填写_

---

### 4.2 MFA 验证（如果启用）

**测试用例 ID**: TC-SEC-002

**测试目标**: 验证 MFA 双因素认证

**前置条件**:

- 创建启用了 MFA 的测试账号

**测试步骤**:

1. 使用启用 MFA 的账号登录
2. 输入正确的用户名和密码
3. 观察是否要求输入 MFA 验证码

**验证点**:

- [ ] 返回 `mfaRequired: true`
- [ ] 显示 MFA 验证码输入框
- [ ] 输入正确的 TOTP 码后登录成功
- [ ] 输入错误的 TOTP 码登录失败

**预期结果**: MFA 验证流程正常

**实际结果**: _待填写_

**问题记录**: _待填写_

---

### 4.3 会话管理

**测试用例 ID**: TC-SEC-003

**测试目标**: 验证会话管理功能

**测试步骤**:

1. 登录后查看活跃会话列表
2. 手动撤销某个会话
3. 验证该会话的 Token 失效

**验证点**:

- [ ] 可以查看所有活跃会话
- [ ] 显示会话信息（设备、IP、最后活跃时间）
- [ ] 可以撤销指定会话
- [ ] 被撤销的会话 Token 立即失效

**预期结果**: 会话管理功能正常

**实际结果**: _待填写_

**问题记录**: _待填写_

---

## 阶段 5: 性能和压力测试 (预计 15 分钟)

### 5.1 并发登录测试

**测试用例 ID**: TC-PERF-001

**测试目标**: 验证系统可以处理并发登录请求

**测试工具**: Apache Bench (ab) 或 wrk

**测试步骤**:

```bash
# 100 个并发用户，总共 1000 个请求
ab -n 1000 -c 100 -p login.json -T application/json \
  http://localhost:18789/api/auth/login
```

**验证点**:

- [ ] 所有请求都得到响应
- [ ] 成功率 > 99%
- [ ] 平均响应时间 < 500ms
- [ ] 无服务器错误

**预期结果**:

- 系统稳定处理并发请求
- 响应时间在可接受范围内

**实际结果**: _待填写_

**性能指标**:

- 总请求数: _待填写_
- 成功请求数: _待填写_
- 失败请求数: _待填写_
- 平均响应时间: _待填写_
- 最大响应时间: _待填写_

**问题记录**: _待填写_

---

### 5.2 Token 刷新性能

**测试用例 ID**: TC-PERF-002

**测试目标**: 验证 Token 刷新接口的性能

**测试步骤**:

```bash
# 测试 Token 刷新接口
ab -n 500 -c 50 -p refresh.json -T application/json \
  http://localhost:18789/api/auth/refresh
```

**验证点**:

- [ ] 响应时间 < 200ms
- [ ] 成功率 100%
- [ ] 无数据库连接池耗尽

**预期结果**: Token 刷新快速稳定

**实际结果**: _待填写_

**问题记录**: _待填写_

---

## 阶段 6: 兼容性测试 (预计 10 分钟)

### 6.1 浏览器兼容性

**测试用例 ID**: TC-COMPAT-001

**测试目标**: 验证不同浏览器的兼容性

**测试浏览器**:

- [ ] Chrome (最新版本)
- [ ] Firefox (最新版本)
- [ ] Edge (最新版本)
- [ ] Safari (如果可用)

**验证点**:

- [ ] 登录功能正常
- [ ] Token 存储正常
- [ ] 页面显示正常
- [ ] 无 JavaScript 错误

**测试结果**:

- Chrome: _待填写_
- Firefox: _待填写_
- Edge: _待填写_
- Safari: _待填写_

---

### 6.2 移动端兼容性

**测试用例 ID**: TC-COMPAT-002

**测试目标**: 验证移动端浏览器的兼容性

**测试设备**:

- [ ] iOS Safari
- [ ] Android Chrome

**验证点**:

- [ ] 响应式布局正常
- [ ] 登录功能正常
- [ ] 触摸操作流畅

**测试结果**: _待填写_

---

## 测试总结

### 测试统计

| 测试阶段   | 计划用例数 | 执行用例数   | 通过数       | 失败数       | 阻塞数       |
| ---------- | ---------- | ------------ | ------------ | ------------ | ------------ |
| 环境准备   | 4          | _待填写_     | _待填写_     | _待填写_     | _待填写_     |
| 用户认证   | 5          | _待填写_     | _待填写_     | _待填写_     | _待填写_     |
| 管理员认证 | 5          | _待填写_     | _待填写_     | _待填写_     | _待填写_     |
| 安全特性   | 3          | _待填写_     | _待填写_     | _待填写_     | _待填写_     |
| 性能测试   | 2          | _待填写_     | _待填写_     | _待填写_     | _待填写_     |
| 兼容性测试 | 2          | _待填写_     | _待填写_     | _待填写_     | _待填写_     |
| **总计**   | **21**     | **_待填写_** | **_待填写_** | **_待填写_** | **_待填写_** |

### 缺陷统计

| 严重程度 | 数量     | 缺陷 ID  | 状态     |
| -------- | -------- | -------- | -------- |
| 致命     | _待填写_ | _待填写_ | _待填写_ |
| 严重     | _待填写_ | _待填写_ | _待填写_ |
| 一般     | _待填写_ | _待填写_ | _待填写_ |
| 轻微     | _待填写_ | _待填写_ | _待填写_ |

### 主要问题

1. _待填写_
2. _待填写_
3. _待填写_

### 改进建议

1. _待填写_
2. _待填写_
3. _待填写_

### 测试结论

- [ ] 所有测试用例已执行
- [ ] 所有致命和严重缺陷已修复
- [ ] 系统满足上线标准
- [ ] 建议进入下一阶段

**测试负责人**: _待填写_

**测试日期**: _待填写_

**签字**: _待填写_

---

## 附录

### A. 测试数据

#### 测试用户列表

| 账号类型 | 用户名/邮箱        | 密码              | 用途           |
| -------- | ------------------ | ----------------- | -------------- |
| 普通用户 | test@example.com   | TestP@ssw0rd123   | 基本功能测试   |
| 管理员   | testadmin          | AdminP@ssw0rd123  | 管理员功能测试 |
| MFA 用户 | mfa@example.com    | MfaP@ssw0rd123    | MFA 测试       |
| 锁定用户 | locked@example.com | LockedP@ssw0rd123 | 账户锁定测试   |

### B. API 端点列表

| 端点               | 方法 | 用途              |
| ------------------ | ---- | ----------------- |
| /api/auth/register | POST | 用户注册          |
| /api/auth/login    | POST | 用户登录          |
| /api/auth/refresh  | POST | Token 刷新        |
| /api/auth/logout   | POST | 用户登出          |
| /api/admin/login   | POST | 管理员登录        |
| /api/admin/refresh | POST | 管理员 Token 刷新 |
| /api/admin/logout  | POST | 管理员登出        |

### C. 环境配置

```bash
# 数据库
DATABASE_URL=postgresql://openclaw_admin:Oc%402026!Pg%23Secure@10.157.152.40:22001/openclaw_prod

# JWT
JWT_SECRET=Oc@2026!JwtSecret#32CharMinimumRequired
JWT_ACCESS_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d

# 服务端口
GATEWAY_PORT=18789
WEB_ADMIN_PORT=5173
```

### D. 相关文档

- [集成测试指南](./integration-testing-guide.md)
- [数据库 Schema 文档](../src/db/schema/README.md)
- [认证服务 API 文档](../src/assistant/auth/README.md)
- [管理员认证 API 文档](../src/assistant/admin-auth/README.md)
