# OpenClaw AI ä¸ªäººåŠ©ç†å¹³å° - æµ‹è¯•è®¡åˆ’

> ç‰ˆæœ¬: 1.0 | åˆ›å»ºæ—¥æœŸ: 2026-02-08 | çŠ¶æ€: æ‰§è¡Œä¸­
>
> æœ¬æ–‡æ¡£å®šä¹‰å®Œæ•´çš„æµ‹è¯•ç­–ç•¥ã€æ‰§è¡Œé¡ºåºå’ŒéªŒæ”¶æ ‡å‡†

---

## ä¿®è®¢è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ       | ä¿®è®¢å†…å®¹                                |
| ---- | ---------- | --------------------------------------- |
| 1.0  | 2026-02-08 | åˆå§‹ç‰ˆæœ¬                                |
| 1.1  | 2026-02-08 | å®Œæˆå¯†ç å·¥å…·å’ŒJWTå·¥å…·æµ‹è¯•               |
| 1.2  | 2026-02-08 | åˆ›å»ºç”¨æˆ·ä»“åº“æµ‹è¯•ï¼Œå‘ç°Mockæ•°æ®åº“é—®é¢˜    |
| 1.3  | 2026-02-08 | ä¿®å¤Mockæ•°æ®åº“Promiseæ¥å£ï¼Œéƒ¨åˆ†æµ‹è¯•é€šè¿‡ |

---

## æµ‹è¯•è¿›åº¦ç»Ÿè®¡

**æœ€åæ›´æ–°**: 2026-02-08

| æŒ‡æ ‡            | æ•°å€¼                    |
| --------------- | ----------------------- |
| å·²å®Œæˆæµ‹è¯•æ–‡ä»¶  | 2 / 10                  |
| å·²é€šè¿‡æµ‹è¯•ç”¨ä¾‹  | 34 / é¢„è®¡100+           |
| å½“å‰ä»£ç è¦†ç›–ç‡  | < 1% (ä»…æµ‹è¯•äº†å·¥å…·æ¨¡å—) |
| P0 ä¼˜å…ˆçº§å®Œæˆåº¦ | 28.6% (2/7)             |

**å·²å®Œæˆæ¨¡å—**:

- âœ… å¯†ç å·¥å…· (password.test.ts) - 12ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- âœ… JWTå·¥å…· (jwt.test.ts) - 18ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡

**éƒ¨åˆ†å®Œæˆ**:

- ğŸŸ¡ ç”¨æˆ·ä»“åº“æµ‹è¯• (users.test.ts) - 22ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œ4ä¸ªé€šè¿‡ï¼Œ18ä¸ªå¤±è´¥
  - âœ… USER-CREATE-001~003: ç”¨æˆ·åˆ›å»ºæµ‹è¯•é€šè¿‡
  - âœ… CODE-CREATE-001: éªŒè¯ç åˆ›å»ºæµ‹è¯•é€šè¿‡
  - âŒ å…¶ä»–æµ‹è¯•å¤±è´¥ï¼šMockæ•°æ®åº“whereæ¡ä»¶å¤„ç†é—®é¢˜

**æŠ€æœ¯é—®é¢˜**:

1. âœ… **å·²ä¿®å¤**: Mockæ•°æ®åº“æ„å»ºå™¨æœªå®ç°Promiseæ¥å£
   - å·²ä¸ºæ‰€æœ‰æ„å»ºå™¨æ·»åŠ `then()`æ–¹æ³•
   - ç°åœ¨å¯ä»¥ç›´æ¥awaitæ„å»ºå™¨å¯¹è±¡

2. âš ï¸ **å¾…è§£å†³**: Mockæ•°æ®åº“whereæ¡ä»¶å¤„ç†
   - Drizzle ORMä½¿ç”¨`eq()`, `and()`, `or()`ç­‰å‡½æ•°ç”Ÿæˆæ¡ä»¶å¯¹è±¡
   - Mockæ•°æ®åº“å½“å‰åªæ”¯æŒå‡½æ•°å½¢å¼çš„whereæ¡ä»¶
   - éœ€è¦å®ç°æ¡ä»¶å¯¹è±¡è§£æå™¨æˆ–ä½¿ç”¨çœŸå®æ•°æ®åº“

**ä¸‹ä¸€æ­¥å»ºè®®**:

- é€‰é¡¹A: å®ç°Mockæ•°æ®åº“çš„Drizzle ORMæ¡ä»¶è§£æå™¨
- é€‰é¡¹B: ä½¿ç”¨çœŸå®PostgreSQLæ•°æ®åº“è¿›è¡Œé›†æˆæµ‹è¯•
- é€‰é¡¹C: è·³è¿‡ä»“åº“å±‚ï¼Œç›´æ¥æµ‹è¯•æœåŠ¡å±‚ï¼ˆMockä»“åº“ï¼‰

---

## 1. æµ‹è¯•æ¦‚è¿°

### 1.1 æµ‹è¯•ç›®æ ‡

| ç›®æ ‡       | æè¿°                           |
| ---------- | ------------------------------ |
| åŠŸèƒ½æ­£ç¡®æ€§ | éªŒè¯æ‰€æœ‰ä¸šåŠ¡é€»è¾‘æŒ‰è®¾è®¡æ–‡æ¡£å®ç° |
| ä»£ç è¦†ç›–ç‡ | è¾¾åˆ° 70% ä»¥ä¸Šçš„è¡Œè¦†ç›–ç‡        |
| å›å½’ä¿æŠ¤   | é˜²æ­¢åç»­ä¿®æ”¹å¼•å…¥æ–° Bug         |
| è°ƒè¯•å‹å¥½   | é€šè¿‡è¯¦ç»†æ—¥å¿—å¿«é€Ÿå®šä½é—®é¢˜       |

### 1.2 æµ‹è¯•èŒƒå›´

| æ¨¡å—                                | æµ‹è¯•ç±»å‹ | ä¼˜å…ˆçº§ | çŠ¶æ€                   |
| ----------------------------------- | -------- | ------ | ---------------------- |
| å¯†ç å·¥å…· (utils/password)           | å•å…ƒæµ‹è¯• | P0     | âœ… å·²å®Œæˆ (12/12 é€šè¿‡) |
| JWT å·¥å…· (auth/jwt)                 | å•å…ƒæµ‹è¯• | P0     | âœ… å·²å®Œæˆ (18/18 é€šè¿‡) |
| ç”¨æˆ·ä»“åº“ (repositories/users)       | å•å…ƒæµ‹è¯• | P0     | â³ å¾…æµ‹è¯•              |
| ç”¨æˆ·è®¤è¯æœåŠ¡ (auth-service)         | å•å…ƒæµ‹è¯• | P0     | â³ å¾…æµ‹è¯•              |
| ç®¡ç†å‘˜è®¤è¯æœåŠ¡ (admin-auth-service) | å•å…ƒæµ‹è¯• | P0     | â³ å¾…æµ‹è¯•              |
| è®¢é˜…æœåŠ¡ (subscription/service)     | å•å…ƒæµ‹è¯• | P0     | â³ å¾…æµ‹è¯•              |
| æŠ€èƒ½æœåŠ¡ (skill-service)            | å•å…ƒæµ‹è¯• | P0     | â³ å¾…æµ‹è¯•              |
| ID ç”Ÿæˆå·¥å…· (utils/id)              | å•å…ƒæµ‹è¯• | P1     | â³ å¾…æµ‹è¯•              |
| Gateway RPC æ–¹æ³•                    | é›†æˆæµ‹è¯• | P1     | â³ å¾…æµ‹è¯•              |
| å‰åç«¯ E2E                          | E2E æµ‹è¯• | P2     | â³ å¾…æµ‹è¯•              |

### 1.3 æµ‹è¯•æ¡†æ¶

| å·¥å…·                 | ç”¨é€”           |
| -------------------- | -------------- |
| Vitest               | æµ‹è¯•è¿è¡Œå™¨     |
| V8 Coverage          | ä»£ç è¦†ç›–ç‡     |
| Mock Database        | å†…å­˜æ•°æ®åº“æ¨¡æ‹Ÿ |
| vi.fn() / vi.spyOn() | å‡½æ•° Mock      |

---

## 2. æµ‹è¯•ç¯å¢ƒé…ç½®

### 2.1 ç¯å¢ƒå˜é‡

```bash
# æµ‹è¯•ç¯å¢ƒå˜é‡ (.env.test)
NODE_ENV=test
JWT_SECRET=test-jwt-secret-at-least-32-characters-long
DATABASE_URL=mock://localhost/test
LOG_LEVEL=debug
```

### 2.2 Mock æ•°æ®åº“ä½¿ç”¨

é¡¹ç›®å·²æä¾› `src/db/mock-connection.ts`ï¼Œæ”¯æŒå†…å­˜æ•°æ®åº“æ¨¡æ‹Ÿï¼š

```typescript
import {
  enableMockDatabase,
  disableMockDatabase,
  clearMockDatabase,
  seedMockTable,
  getMockDatabase,
} from "../../db/mock-connection.js";

// æµ‹è¯•å¥—ä»¶è®¾ç½®
beforeAll(() => {
  enableMockDatabase();
});

afterAll(() => {
  disableMockDatabase();
});

beforeEach(() => {
  clearMockDatabase();
});
```

### 2.3 æ—¥å¿—é…ç½®

æµ‹è¯•æ—¶å¯ç”¨è¯¦ç»†æ—¥å¿—ä»¥ä¾¿è°ƒè¯•ï¼š

```typescript
// åœ¨æµ‹è¯•æ–‡ä»¶é¡¶éƒ¨
import { getLogger } from "../../logging/logger.js";

const logger = getLogger();
logger.level = "debug";
```

---

## 3. æµ‹è¯•æ‰§è¡Œé¡ºåº

### 3.1 é˜¶æ®µåˆ’åˆ†

```
é˜¶æ®µ 1: åŸºç¡€å·¥å…·æµ‹è¯• (æ— ä¾èµ–)
â”œâ”€â”€ utils/password.test.ts     - å¯†ç å“ˆå¸Œ/éªŒè¯
â”œâ”€â”€ utils/id.test.ts           - ID ç”Ÿæˆ
â””â”€â”€ auth/jwt.test.ts           - JWT ç”Ÿæˆ/éªŒè¯

é˜¶æ®µ 2: æ•°æ®è®¿é—®å±‚æµ‹è¯• (ä¾èµ– Mock DB)
â”œâ”€â”€ repositories/users.test.ts         - ç”¨æˆ·ä»“åº“
â”œâ”€â”€ repositories/admins.test.ts        - ç®¡ç†å‘˜ä»“åº“
â””â”€â”€ repositories/subscriptions.test.ts - è®¢é˜…ä»“åº“

é˜¶æ®µ 3: ä¸šåŠ¡æœåŠ¡å±‚æµ‹è¯• (ä¾èµ–ä»“åº“å±‚)
â”œâ”€â”€ auth/auth-service.test.ts              - ç”¨æˆ·è®¤è¯
â”œâ”€â”€ admin-auth/admin-auth-service.test.ts  - ç®¡ç†å‘˜è®¤è¯
â”œâ”€â”€ subscription/service.test.ts           - è®¢é˜…ç®¡ç†
â””â”€â”€ skills/skill-service.test.ts           - æŠ€èƒ½ç®¡ç†

é˜¶æ®µ 4: Gateway RPC æ–¹æ³•æµ‹è¯• (é›†æˆæµ‹è¯•)
â”œâ”€â”€ server-methods/admin-auth.test.ts
â”œâ”€â”€ server-methods/admin-users.test.ts
â””â”€â”€ server-methods/assistant-auth.test.ts

é˜¶æ®µ 5: E2E æµ‹è¯•
â”œâ”€â”€ e2e/user-registration.e2e.test.ts
â”œâ”€â”€ e2e/admin-login.e2e.test.ts
â””â”€â”€ e2e/skill-store.e2e.test.ts
```

### 3.2 æ‰§è¡Œå‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
pnpm test

# è¿è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•
pnpm test src/assistant/auth/

# è¿è¡Œå¸¦è¦†ç›–ç‡
pnpm test:coverage

# ç›‘è§†æ¨¡å¼
pnpm test:watch
```

---

## 4. æ—¥å¿—æ£€æŸ¥ç‚¹è®¾è®¡

### 4.1 æ—¥å¿—çº§åˆ«è§„èŒƒ

| çº§åˆ«  | ç”¨é€”         | ç¤ºä¾‹                           |
| ----- | ------------ | ------------------------------ |
| DEBUG | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ | å‡½æ•°å…¥å‚ã€ä¸­é—´çŠ¶æ€             |
| INFO  | å…³é”®ä¸šåŠ¡äº‹ä»¶ | ç”¨æˆ·ç™»å½•æˆåŠŸã€è®¢é˜…åˆ›å»º         |
| WARN  | æ½œåœ¨é—®é¢˜     | ç™»å½•å¤±è´¥ã€é…é¢æ¥è¿‘ä¸Šé™         |
| ERROR | é”™è¯¯å’Œå¼‚å¸¸   | æ•°æ®åº“è¿æ¥å¤±è´¥ã€Token éªŒè¯å¤±è´¥ |

### 4.2 æ—¥å¿—æ ¼å¼

```typescript
// æ ‡å‡†æ—¥å¿—æ ¼å¼
logger.info("[æ¨¡å—å] æ“ä½œæè¿°", {
  // å…³é”®å‚æ•°
  userId: "xxx",
  action: "login",
  // ç»“æœ
  success: true,
  // è€—æ—¶ (å¯é€‰)
  durationMs: 123,
});
```

### 4.3 æµ‹è¯•ä¸­çš„æ—¥å¿—éªŒè¯

```typescript
import { vi } from "vitest";

// Mock logger
const mockLogger = {
  debug: vi.fn(),
  info: vi.fn(),
  warn: vi.fn(),
  error: vi.fn(),
};

// éªŒè¯æ—¥å¿—è°ƒç”¨
expect(mockLogger.info).toHaveBeenCalledWith(
  expect.stringContaining("[auth]"),
  expect.objectContaining({ userId: expect.any(String) }),
);
```

---

## 5. Mock ç­–ç•¥

### 5.1 æ•°æ®åº“ Mock

ä½¿ç”¨é¡¹ç›®å†…ç½®çš„ `mock-connection.ts`ï¼š

```typescript
import { getMockDatabase, seedMockTable } from "../../db/mock-connection.js";

// é¢„ç½®æµ‹è¯•æ•°æ®
seedMockTable("users", [
  {
    id: "test-user-1",
    phone: "+8613800138000",
    email: "test@example.com",
    passwordHash: "$scrypt$...",
    isActive: true,
  },
]);
```

### 5.2 å¤–éƒ¨æœåŠ¡ Mock

```typescript
// Mock éªŒè¯ç æœåŠ¡
vi.mock("../../services/sms-service.js", () => ({
  sendVerificationCode: vi.fn().mockResolvedValue({ success: true }),
}));

// Mock æ”¯ä»˜æœåŠ¡
vi.mock("../../assistant/payment/service.js", () => ({
  createPayment: vi.fn().mockResolvedValue({ orderId: "mock-order-1" }),
}));
```

### 5.3 æ—¶é—´ Mock

```typescript
import { vi, beforeEach, afterEach } from "vitest";

beforeEach(() => {
  vi.useFakeTimers();
  vi.setSystemTime(new Date("2026-02-08T10:00:00Z"));
});

afterEach(() => {
  vi.useRealTimers();
});
```

---

## 6. è¦†ç›–ç‡ç›®æ ‡

### 6.1 æ•´ä½“ç›®æ ‡

| æŒ‡æ ‡                    | ç›®æ ‡  | å½“å‰ |
| ----------------------- | ----- | ---- |
| è¡Œè¦†ç›–ç‡ (Lines)        | â‰¥ 70% | -    |
| å‡½æ•°è¦†ç›–ç‡ (Functions)  | â‰¥ 70% | -    |
| åˆ†æ”¯è¦†ç›–ç‡ (Branches)   | â‰¥ 55% | -    |
| è¯­å¥è¦†ç›–ç‡ (Statements) | â‰¥ 70% | -    |

### 6.2 æ¨¡å—çº§ç›®æ ‡

| æ¨¡å—                        | è¡Œè¦†ç›–ç‡ç›®æ ‡ |
| --------------------------- | ------------ |
| src/assistant/auth/         | â‰¥ 80%        |
| src/assistant/admin-auth/   | â‰¥ 80%        |
| src/assistant/subscription/ | â‰¥ 75%        |
| src/assistant/skills/       | â‰¥ 75%        |
| src/db/repositories/        | â‰¥ 80%        |
| src/db/utils/               | â‰¥ 90%        |

---

## 7. æµ‹è¯•è¿›åº¦è·Ÿè¸ª

### 7.1 è¿›åº¦è¡¨

| æ¨¡å—               | æµ‹è¯•æ–‡ä»¶                   | ç”¨ä¾‹æ•° | é€šè¿‡ | å¤±è´¥ | çŠ¶æ€ |
| ------------------ | -------------------------- | ------ | ---- | ---- | ---- |
| utils/password     | password.test.ts           | -      | -    | -    | â³   |
| utils/id           | id.test.ts                 | -      | -    | -    | â³   |
| auth/jwt           | jwt.test.ts                | -      | -    | -    | â³   |
| repositories/users | users.test.ts              | -      | -    | -    | â³   |
| auth/auth-service  | auth-service.test.ts       | -      | -    | -    | â³   |
| admin-auth         | admin-auth-service.test.ts | -      | -    | -    | â³   |
| subscription       | service.test.ts            | -      | -    | -    | â³   |
| skills             | skill-service.test.ts      | -      | -    | -    | â³   |

### 7.2 çŠ¶æ€è¯´æ˜

- â³ å¾…æµ‹è¯•
- ğŸ”„ è¿›è¡Œä¸­
- âœ… é€šè¿‡
- âŒ å¤±è´¥
- â¸ï¸ é˜»å¡

---

## 8. é—®é¢˜è·Ÿè¸ª

### 8.1 å·²çŸ¥é—®é¢˜

| ID  | æ¨¡å— | é—®é¢˜æè¿° | çŠ¶æ€ |
| --- | ---- | -------- | ---- |
| -   | -    | -        | -    |

### 8.2 æµ‹è¯•é˜»å¡é¡¹

| ID  | é˜»å¡åŸå›  | å½±å“æ¨¡å— | è§£å†³æ–¹æ¡ˆ |
| --- | -------- | -------- | -------- |
| -   | -        | -        | -        |

---

## 9. éªŒæ”¶æ ‡å‡†

### 9.1 å•å…ƒæµ‹è¯•éªŒæ”¶

- [ ] æ‰€æœ‰ P0 æ¨¡å—æµ‹è¯•é€šè¿‡
- [ ] è¡Œè¦†ç›–ç‡ â‰¥ 70%
- [ ] æ— è·³è¿‡çš„æµ‹è¯•ç”¨ä¾‹
- [ ] æµ‹è¯•æ‰§è¡Œæ—¶é—´ < 60 ç§’

### 9.2 é›†æˆæµ‹è¯•éªŒæ”¶

- [ ] Gateway RPC æ–¹æ³•æµ‹è¯•é€šè¿‡
- [ ] è®¤è¯æµç¨‹ç«¯åˆ°ç«¯éªŒè¯
- [ ] è®¢é˜…æµç¨‹ç«¯åˆ°ç«¯éªŒè¯

### 9.3 æ–‡æ¡£éªŒæ”¶

- [ ] æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£å®Œæ•´
- [ ] æ—¥å¿—æ£€æŸ¥ç‚¹æ–‡æ¡£å®Œæ•´
- [ ] é—®é¢˜è·Ÿè¸ªè®°å½•å®Œæ•´

---

_â€” æ–‡æ¡£ç»“æŸ â€”_
