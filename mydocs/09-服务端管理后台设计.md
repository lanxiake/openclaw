# OpenClaw 服务端管理后台设计文档

> 版本: 1.0 | 创建日期: 2026-02-07 | 状态: 初始设计
>
> 本文档设计 OpenClaw 平台运营管理后台（Admin Console）

---

## 修订记录

| 版本 | 日期 | 修订内容 |
|------|------|----------|
| 1.0 | 2026-02-07 | 初始设计：需求分析、数据库设计、API 设计、前端架构 |

---

## 1. 概述

### 1.1 背景

OpenClaw 平台需要一个独立的**服务端管理后台**，供平台运营团队管理用户、订阅、技能商店等核心业务。

**与用户端管理面板的区别：**

| 对比项 | 用户端管理面板 (web-admin) | 服务端管理后台 (admin-console) |
|--------|---------------------------|-------------------------------|
| 目标用户 | 最终用户 | 平台运营团队 |
| 功能范围 | 管理自己的设备、技能、订阅 | 管理所有用户、订阅、技能商店 |
| 数据权限 | 仅能访问自己的数据 | 可访问全平台数据 |
| 认证方式 | 用户账号登录 | 管理员账号登录 |

### 1.2 目标用户

| 角色 | 权限范围 | 典型操作 |
|------|----------|----------|
| 超级管理员 | 全部权限 | 系统配置、权限管理、所有运营操作 |
| 运营主管 | 用户管理 + 订阅管理 + 技能管理 | 处理用户投诉、调整订阅、上下架技能 |
| 运营专员 | 只读权限 + 有限写权限 | 查看数据、处理简单工单 |
| 技术支持 | 日志查看 + 设备管理 | 排查问题、查看日志 |

### 1.3 设计原则

1. **独立部署** - 与用户端完全分离，独立域名和认证
2. **安全优先** - 严格的权限控制、操作审计、敏感数据脱敏
3. **高效运营** - 批量操作、快速搜索、数据导出
4. **可追溯** - 所有操作记录审计日志

---

## 2. 功能需求

### 2.1 第一期功能 (P0)

#### 2.1.1 管理员认证

| 功能 | 说明 |
|------|------|
| 账号密码登录 | 管理员使用账号密码登录 |
| 二次验证 (MFA) | 可选的 TOTP 二次验证 |
| 会话管理 | 登录超时、强制登出、多端互踢 |
| 登录日志 | 记录登录时间、IP、设备信息 |

#### 2.1.2 仪表盘

**关键指标卡片：**

| 指标 | 说明 | 数据源 |
|------|------|--------|
| 总用户数 | 平台注册用户总数 | users 表 COUNT |
| 今日新增 | 今日注册用户数 | users 表 WHERE created_at >= today |
| 活跃用户 (7日) | 近 7 天有登录的用户 | users 表 WHERE last_login_at >= 7 days ago |
| 付费用户 | 有有效订阅的用户数 | subscriptions 表 WHERE status = 'active' |
| 本月收入 | 当月订阅收入 | orders 表 WHERE status = 'paid' AND created_at >= month_start |
| 在线设备 | 当前在线设备数 | devices 表 WHERE status = 'online' |
| 今日 API 调用 | 今日 API 调用次数 | api_logs 表 COUNT |

**图表：**

| 图表 | 类型 | 说明 |
|------|------|------|
| 用户增长趋势 | 折线图 | 近 30 天每日新增用户 |
| 订阅分布 | 饼图 | 按计划类型分布 |
| 收入趋势 | 柱状图 | 近 12 个月收入 |

**实时动态：**

| 动态类型 | 说明 |
|----------|------|
| 最近注册 | 最近 10 条用户注册 |
| 最近订阅 | 最近 10 条订阅订单 |
| 最近操作 | 最近 10 条管理员操作 |

#### 2.1.3 用户管理

**用户列表：**

| 功能 | 说明 |
|------|------|
| 分页展示 | 每页 20 条，支持调整 |
| 搜索 | 按手机号、邮箱、用户名搜索 |
| 筛选 | 按状态、订阅类型、注册时间筛选 |
| 排序 | 按注册时间、最后登录时间排序 |
| 导出 | 导出 CSV 文件 |

**用户详情：**

| 信息类别 | 字段 |
|----------|------|
| 基本信息 | ID、头像、昵称、手机、邮箱、注册时间 |
| 账户状态 | 状态（正常/禁用）、是否验证、MFA 状态 |
| 订阅信息 | 当前计划、开始时间、到期时间、自动续费 |
| 设备列表 | 已配对设备及状态 |
| 操作历史 | 最近 50 条操作日志 |

**用户操作：**

| 操作 | 权限 | 说明 |
|------|------|------|
| 查看详情 | operator.read | 查看用户完整信息 |
| 禁用账户 | operator.write | 禁用用户账户，需填写原因 |
| 启用账户 | operator.write | 启用已禁用的账户 |
| 重置密码 | operator.write | 发送密码重置链接 |
| 调整订阅 | operator.write | 手动升级/降级/续期订阅 |
| 强制登出 | operator.write | 登出用户所有设备 |

#### 2.1.4 订阅管理

**订阅计划管理：**

| 功能 | 说明 |
|------|------|
| 计划列表 | 显示所有订阅计划 |
| 创建计划 | 创建新的订阅计划 |
| 编辑计划 | 修改计划名称、价格、功能配额 |
| 启用/禁用 | 控制计划是否可购买 |

**订阅计划字段：**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 计划 ID |
| name | string | 计划名称（免费版、专业版、团队版） |
| code | string | 计划代码（free, pro, team） |
| price | number | 价格（分） |
| period | enum | 周期（month, year） |
| features | json | 功能列表 |
| limits | json | 配额限制（设备数、技能数、调用次数） |
| isActive | boolean | 是否启用 |
| sortOrder | number | 排序 |

**用户订阅管理：**

| 功能 | 说明 |
|------|------|
| 订阅列表 | 查看所有用户订阅 |
| 筛选 | 按计划、状态、即将到期筛选 |
| 手动续期 | 为用户手动续期 |
| 手动升降级 | 调整用户订阅计划 |
| 取消订阅 | 取消用户订阅 |

**订单管理：**

| 功能 | 说明 |
|------|------|
| 订单列表 | 查看所有订单 |
| 订单详情 | 查看订单详细信息 |
| 退款处理 | 处理退款申请 |

#### 2.1.5 操作日志

| 功能 | 说明 |
|------|------|
| 日志列表 | 查看管理员操作记录 |
| 筛选 | 按操作类型、管理员、时间范围筛选 |
| 详情查看 | 查看操作前后数据对比 |
| 导出日志 | 导出日志文件 |

**日志字段：**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 日志 ID |
| adminId | string | 操作管理员 ID |
| adminName | string | 操作管理员名称 |
| action | string | 操作类型 |
| resource | string | 操作资源 |
| resourceId | string | 资源 ID |
| before | json | 操作前数据 |
| after | json | 操作后数据 |
| reason | string | 操作原因 |
| ipAddress | string | IP 地址 |
| userAgent | string | 浏览器信息 |
| createdAt | timestamp | 操作时间 |

### 2.2 第二期功能 (P1)

#### 2.2.1 技能商店管理

| 功能 | 说明 |
|------|------|
| 技能列表 | 已上架、待审核、已下架 |
| 技能审核 | 审核新提交的技能 |
| 上下架 | 控制技能是否可见 |
| 分类管理 | 管理技能分类 |
| 推荐管理 | 设置首页推荐技能 |
| 统计分析 | 安装量、使用率、评分 |

#### 2.2.2 系统监控

| 功能 | 说明 |
|------|------|
| 服务状态 | Gateway、数据库、缓存状态 |
| API 监控 | 请求量、响应时间、错误率 |
| 资源使用 | CPU、内存、磁盘、带宽 |
| 实时日志 | WebSocket 实时日志流 |

### 2.3 第三期功能 (P2)

#### 2.3.1 系统配置

| 功能 | 说明 |
|------|------|
| 基础配置 | 站点名称、Logo、联系方式 |
| 功能开关 | 注册开关、支付开关等 |
| 安全配置 | 登录策略、密码策略 |
| 通知模板 | 短信/邮件模板管理 |

#### 2.3.2 数据分析

| 功能 | 说明 |
|------|------|
| 用户分析 | 用户画像、留存分析、漏斗分析 |
| 收入分析 | 收入趋势、ARPU、LTV |
| 技能分析 | 热门技能、使用趋势 |
| 自定义报表 | 自定义数据报表 |

---

## 3. 数据库设计

### 3.1 管理员相关表

#### 3.1.1 admins - 管理员表

```sql
CREATE TABLE admins (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(50) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  display_name VARCHAR(100) NOT NULL,
  email VARCHAR(255),
  phone VARCHAR(20),
  avatar_url VARCHAR(500),
  role VARCHAR(20) NOT NULL DEFAULT 'operator',  -- super_admin, admin, operator
  status VARCHAR(20) NOT NULL DEFAULT 'active',   -- active, disabled
  mfa_enabled BOOLEAN DEFAULT FALSE,
  mfa_secret VARCHAR(100),
  last_login_at TIMESTAMP,
  last_login_ip VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by UUID REFERENCES admins(id)
);

-- 索引
CREATE INDEX idx_admins_username ON admins(username);
CREATE INDEX idx_admins_status ON admins(status);
```

#### 3.1.2 admin_sessions - 管理员会话表

```sql
CREATE TABLE admin_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID NOT NULL REFERENCES admins(id) ON DELETE CASCADE,
  token_hash VARCHAR(255) NOT NULL,
  ip_address VARCHAR(50),
  user_agent TEXT,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_active_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_admin_sessions_admin_id ON admin_sessions(admin_id);
CREATE INDEX idx_admin_sessions_expires_at ON admin_sessions(expires_at);
```

#### 3.1.3 admin_audit_logs - 管理员操作日志表

```sql
CREATE TABLE admin_audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID NOT NULL REFERENCES admins(id),
  admin_name VARCHAR(100) NOT NULL,
  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50) NOT NULL,
  resource_id VARCHAR(100),
  before_data JSONB,
  after_data JSONB,
  reason TEXT,
  ip_address VARCHAR(50),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_admin_audit_logs_admin_id ON admin_audit_logs(admin_id);
CREATE INDEX idx_admin_audit_logs_action ON admin_audit_logs(action);
CREATE INDEX idx_admin_audit_logs_resource ON admin_audit_logs(resource_type, resource_id);
CREATE INDEX idx_admin_audit_logs_created_at ON admin_audit_logs(created_at DESC);
```

### 3.2 订阅计划表

#### 3.2.1 subscription_plans - 订阅计划表

```sql
CREATE TABLE subscription_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  code VARCHAR(50) NOT NULL UNIQUE,
  description TEXT,
  price INTEGER NOT NULL DEFAULT 0,  -- 价格（分）
  period VARCHAR(20) NOT NULL,       -- month, year
  features JSONB DEFAULT '[]',       -- 功能列表
  limits JSONB DEFAULT '{}',         -- 配额限制
  is_active BOOLEAN DEFAULT TRUE,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_subscription_plans_code ON subscription_plans(code);
CREATE INDEX idx_subscription_plans_is_active ON subscription_plans(is_active);
```

**limits 结构示例：**

```json
{
  "devices": 3,
  "skills": 10,
  "dailyCalls": 1000,
  "storage": 1073741824  // 1GB in bytes
}
```

### 3.3 统计相关表

#### 3.3.1 daily_stats - 每日统计表

```sql
CREATE TABLE daily_stats (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  date DATE NOT NULL UNIQUE,
  new_users INTEGER DEFAULT 0,
  active_users INTEGER DEFAULT 0,
  new_subscriptions INTEGER DEFAULT 0,
  revenue INTEGER DEFAULT 0,  -- 收入（分）
  api_calls INTEGER DEFAULT 0,
  online_devices INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_daily_stats_date ON daily_stats(date DESC);
```

### 3.4 ER 图

```
┌─────────────────┐         ┌─────────────────┐
│     admins      │         │ admin_sessions  │
├─────────────────┤         ├─────────────────┤
│ id (PK)         │────────<│ admin_id (FK)   │
│ username        │         │ token_hash      │
│ password_hash   │         │ expires_at      │
│ display_name    │         └─────────────────┘
│ role            │
│ status          │         ┌─────────────────┐
│ mfa_enabled     │         │admin_audit_logs │
└────────┬────────┘         ├─────────────────┤
         │                  │ admin_id (FK)   │
         └─────────────────>│ action          │
                            │ resource_type   │
                            │ before_data     │
                            │ after_data      │
                            └─────────────────┘

┌─────────────────┐         ┌─────────────────┐
│subscription_plans│        │   daily_stats   │
├─────────────────┤         ├─────────────────┤
│ id (PK)         │         │ date            │
│ name            │         │ new_users       │
│ code            │         │ active_users    │
│ price           │         │ revenue         │
│ limits          │         └─────────────────┘
└─────────────────┘

┌─────────────────┐         ┌─────────────────┐
│     users       │────────<│  subscriptions  │
│ (已有表)         │         │ (已有表)         │
└─────────────────┘         └─────────────────┘
```

---

## 4. API 设计

### 4.1 API 规范

| 规范 | 说明 |
|------|------|
| 基础路径 | `/api/admin/v1` |
| 协议 | HTTPS |
| 认证 | Bearer Token (JWT) |
| 响应格式 | JSON |

### 4.2 认证 API

#### 4.2.1 管理员登录

```
POST /api/admin/v1/auth/login

请求体:
{
  "username": "admin",
  "password": "password123"
}

响应:
{
  "success": true,
  "data": {
    "admin": {
      "id": "uuid",
      "username": "admin",
      "displayName": "超级管理员",
      "role": "super_admin",
      "mfaEnabled": false
    },
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "expiresIn": 3600
  }
}

错误:
- INVALID_CREDENTIALS: 用户名或密码错误
- ACCOUNT_DISABLED: 账户已禁用
- MFA_REQUIRED: 需要二次验证
```

#### 4.2.2 MFA 验证

```
POST /api/admin/v1/auth/mfa/verify

请求体:
{
  "token": "临时令牌",
  "code": "123456"
}

响应:
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "expiresIn": 3600
  }
}
```

#### 4.2.3 刷新令牌

```
POST /api/admin/v1/auth/refresh

请求头:
Authorization: Bearer <accessToken>

响应:
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "expiresIn": 3600
  }
}
```

#### 4.2.4 登出

```
POST /api/admin/v1/auth/logout

请求头:
Authorization: Bearer <accessToken>

响应:
{
  "success": true
}
```

### 4.3 仪表盘 API

#### 4.3.1 获取统计概览

```
GET /api/admin/v1/dashboard/stats

请求头:
Authorization: Bearer <accessToken>

响应:
{
  "success": true,
  "data": {
    "totalUsers": 12345,
    "newUsersToday": 56,
    "activeUsers7d": 3456,
    "paidUsers": 890,
    "revenueThisMonth": 8900000,  // 分
    "onlineDevices": 234,
    "apiCallsToday": 56789
  }
}
```

#### 4.3.2 获取趋势数据

```
GET /api/admin/v1/dashboard/trends?type=users&period=30d

请求头:
Authorization: Bearer <accessToken>

查询参数:
- type: users | revenue | subscriptions
- period: 7d | 30d | 90d | 1y

响应:
{
  "success": true,
  "data": {
    "labels": ["2026-01-08", "2026-01-09", ...],
    "values": [45, 52, 38, ...]
  }
}
```

#### 4.3.3 获取实时动态

```
GET /api/admin/v1/dashboard/activities?limit=10

请求头:
Authorization: Bearer <accessToken>

响应:
{
  "success": true,
  "data": [
    {
      "type": "user_register",
      "userId": "uuid",
      "userName": "用户名",
      "timestamp": "2026-02-07T10:30:00Z"
    },
    {
      "type": "subscription_created",
      "userId": "uuid",
      "planName": "专业版",
      "amount": 9900,
      "timestamp": "2026-02-07T10:28:00Z"
    }
  ]
}
```

### 4.4 用户管理 API

#### 4.4.1 获取用户列表

```
GET /api/admin/v1/users

请求头:
Authorization: Bearer <accessToken>

查询参数:
- page: 页码 (默认 1)
- limit: 每页条数 (默认 20)
- search: 搜索关键词
- status: 状态筛选 (active | suspended | all)
- subscriptionPlan: 订阅计划筛选
- startDate: 注册开始日期
- endDate: 注册结束日期
- sortBy: 排序字段 (createdAt | lastLoginAt)
- sortOrder: 排序方向 (asc | desc)

响应:
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "phone": "+8613800138000",
      "email": "user@example.com",
      "displayName": "用户名",
      "status": "active",
      "subscriptionPlan": "pro",
      "deviceCount": 2,
      "createdAt": "2026-01-01T00:00:00Z",
      "lastLoginAt": "2026-02-07T10:30:00Z"
    }
  ],
  "meta": {
    "total": 12345,
    "page": 1,
    "limit": 20,
    "totalPages": 618
  }
}
```

#### 4.4.2 获取用户详情

```
GET /api/admin/v1/users/:userId

请求头:
Authorization: Bearer <accessToken>

响应:
{
  "success": true,
  "data": {
    "id": "uuid",
    "phone": "+8613800138000",
    "email": "user@example.com",
    "displayName": "用户名",
    "avatarUrl": "https://...",
    "status": "active",
    "isPhoneVerified": true,
    "isEmailVerified": false,
    "mfaEnabled": false,
    "timezone": "Asia/Shanghai",
    "locale": "zh-CN",
    "createdAt": "2026-01-01T00:00:00Z",
    "lastLoginAt": "2026-02-07T10:30:00Z",
    "subscription": {
      "id": "uuid",
      "plan": {
        "id": "uuid",
        "name": "专业版",
        "code": "pro"
      },
      "status": "active",
      "startAt": "2026-02-01T00:00:00Z",
      "endAt": "2026-03-01T00:00:00Z",
      "autoRenew": true
    },
    "devices": [
      {
        "id": "uuid",
        "displayName": "我的电脑",
        "platform": "windows",
        "status": "online",
        "lastActiveAt": "2026-02-07T10:30:00Z"
      }
    ],
    "recentLogs": [
      {
        "action": "auth.login",
        "ipAddress": "192.168.1.1",
        "timestamp": "2026-02-07T10:30:00Z"
      }
    ]
  }
}
```

#### 4.4.3 更新用户状态

```
PATCH /api/admin/v1/users/:userId/status

请求头:
Authorization: Bearer <accessToken>

请求体:
{
  "status": "suspended",
  "reason": "违反服务条款：发送垃圾信息"
}

响应:
{
  "success": true,
  "data": {
    "id": "uuid",
    "status": "suspended",
    "updatedAt": "2026-02-07T10:30:00Z"
  }
}

错误:
- USER_NOT_FOUND: 用户不存在
- INVALID_STATUS: 无效的状态值
```

#### 4.4.4 重置用户密码

```
POST /api/admin/v1/users/:userId/reset-password

请求头:
Authorization: Bearer <accessToken>

请求体:
{
  "notifyUser": true,
  "reason": "用户申请重置"
}

响应:
{
  "success": true,
  "data": {
    "message": "密码重置链接已发送"
  }
}
```

#### 4.4.5 调整用户订阅

```
POST /api/admin/v1/users/:userId/subscription

请求头:
Authorization: Bearer <accessToken>

请求体:
{
  "action": "upgrade" | "downgrade" | "extend" | "cancel",
  "planId": "uuid",  // upgrade/downgrade 时必填
  "days": 30,        // extend 时必填
  "reason": "运营补偿"
}

响应:
{
  "success": true,
  "data": {
    "subscription": {
      "id": "uuid",
      "planId": "uuid",
      "status": "active",
      "endAt": "2026-04-01T00:00:00Z"
    }
  }
}
```

#### 4.4.6 强制用户登出

```
POST /api/admin/v1/users/:userId/force-logout

请求头:
Authorization: Bearer <accessToken>

请求体:
{
  "reason": "安全原因"
}

响应:
{
  "success": true,
  "data": {
    "loggedOutDevices": 3
  }
}
```

#### 4.4.7 导出用户列表

```
POST /api/admin/v1/users/export

请求头:
Authorization: Bearer <accessToken>

请求体:
{
  "format": "csv",
  "filters": {
    "status": "active",
    "startDate": "2026-01-01",
    "endDate": "2026-02-07"
  },
  "fields": ["id", "phone", "email", "displayName", "createdAt"]
}

响应:
{
  "success": true,
  "data": {
    "taskId": "uuid",
    "status": "processing"
  }
}
```

### 4.5 订阅管理 API

#### 4.5.1 获取订阅计划列表

```
GET /api/admin/v1/subscription-plans

请求头:
Authorization: Bearer <accessToken>

响应:
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "name": "免费版",
      "code": "free",
      "price": 0,
      "period": "month",
      "features": ["基础功能", "1 台设备"],
      "limits": {
        "devices": 1,
        "skills": 3,
        "dailyCalls": 100
      },
      "isActive": true,
      "sortOrder": 0,
      "subscriberCount": 5000
    },
    {
      "id": "uuid",
      "name": "专业版",
      "code": "pro",
      "price": 2900,
      "period": "month",
      "features": ["全部功能", "3 台设备", "优先支持"],
      "limits": {
        "devices": 3,
        "skills": -1,  // -1 表示无限
        "dailyCalls": -1
      },
      "isActive": true,
      "sortOrder": 1,
      "subscriberCount": 890
    }
  ]
}
```

#### 4.5.2 创建订阅计划

```
POST /api/admin/v1/subscription-plans

请求头:
Authorization: Bearer <accessToken>

请求体:
{
  "name": "企业版",
  "code": "enterprise",
  "price": 9900,
  "period": "month",
  "features": ["全部功能", "10 台设备", "专属客服", "API 接入"],
  "limits": {
    "devices": 10,
    "skills": -1,
    "dailyCalls": -1
  },
  "sortOrder": 2
}

响应:
{
  "success": true,
  "data": {
    "id": "uuid",
    "name": "企业版",
    "code": "enterprise",
    ...
  }
}
```

#### 4.5.3 更新订阅计划

```
PUT /api/admin/v1/subscription-plans/:planId

请求头:
Authorization: Bearer <accessToken>

请求体:
{
  "name": "企业版",
  "price": 8900,
  "features": ["更新后的功能列表"],
  "limits": { ... }
}

响应:
{
  "success": true,
  "data": { ... }
}
```

#### 4.5.4 获取订阅列表

```
GET /api/admin/v1/subscriptions

请求头:
Authorization: Bearer <accessToken>

查询参数:
- page: 页码
- limit: 每页条数
- planId: 计划 ID 筛选
- status: 状态筛选 (active | expired | cancelled)
- expiringDays: 即将到期天数筛选

响应:
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "user": {
        "id": "uuid",
        "displayName": "用户名",
        "phone": "+8613800138000"
      },
      "plan": {
        "id": "uuid",
        "name": "专业版"
      },
      "status": "active",
      "startAt": "2026-02-01T00:00:00Z",
      "endAt": "2026-03-01T00:00:00Z",
      "autoRenew": true
    }
  ],
  "meta": { ... }
}
```

#### 4.5.5 获取订单列表

```
GET /api/admin/v1/orders

请求头:
Authorization: Bearer <accessToken>

查询参数:
- page: 页码
- limit: 每页条数
- status: 状态筛选 (pending | paid | refunded | cancelled)
- startDate: 开始日期
- endDate: 结束日期

响应:
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "orderNo": "ORD202602070001",
      "user": {
        "id": "uuid",
        "displayName": "用户名"
      },
      "plan": {
        "id": "uuid",
        "name": "专业版"
      },
      "amount": 2900,
      "paymentMethod": "wechat",
      "status": "paid",
      "paidAt": "2026-02-07T10:30:00Z",
      "createdAt": "2026-02-07T10:29:00Z"
    }
  ],
  "meta": { ... }
}
```

#### 4.5.6 处理退款

```
POST /api/admin/v1/orders/:orderId/refund

请求头:
Authorization: Bearer <accessToken>

请求体:
{
  "amount": 2900,  // 退款金额（分）
  "reason": "用户申请退款"
}

响应:
{
  "success": true,
  "data": {
    "refundId": "uuid",
    "status": "processing"
  }
}
```

### 4.6 操作日志 API

#### 4.6.1 获取操作日志

```
GET /api/admin/v1/audit-logs

请求头:
Authorization: Bearer <accessToken>

查询参数:
- page: 页码
- limit: 每页条数
- adminId: 管理员 ID 筛选
- action: 操作类型筛选
- resourceType: 资源类型筛选
- startDate: 开始日期
- endDate: 结束日期

响应:
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "admin": {
        "id": "uuid",
        "displayName": "管理员"
      },
      "action": "user.suspend",
      "resourceType": "user",
      "resourceId": "uuid",
      "before": { "status": "active" },
      "after": { "status": "suspended" },
      "reason": "违规行为",
      "ipAddress": "192.168.1.1",
      "createdAt": "2026-02-07T10:30:00Z"
    }
  ],
  "meta": { ... }
}
```

#### 4.6.2 导出操作日志

```
POST /api/admin/v1/audit-logs/export

请求头:
Authorization: Bearer <accessToken>

请求体:
{
  "format": "csv",
  "filters": {
    "startDate": "2026-02-01",
    "endDate": "2026-02-07"
  }
}

响应:
{
  "success": true,
  "data": {
    "downloadUrl": "https://..."
  }
}
```

---

## 5. 前端架构

### 5.1 技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| React | 18+ | UI 框架 |
| TypeScript | 5.x | 类型安全 |
| Vite | 5.x | 构建工具 |
| React Router | 6.x | 路由 |
| TanStack Query | 5.x | 数据获取 |
| Zustand | 4.x | 状态管理 |
| shadcn/ui | latest | UI 组件库 |
| Tailwind CSS | 3.x | 样式 |
| Recharts | 2.x | 图表 |
| React Hook Form | 7.x | 表单 |
| Zod | 3.x | 验证 |

### 5.2 项目结构

```
apps/admin-console/
├── public/
│   └── favicon.ico
├── src/
│   ├── main.tsx                    # 应用入口
│   ├── App.tsx                     # 根组件
│   │
│   ├── components/                 # 组件
│   │   ├── ui/                     # shadcn/ui 组件
│   │   ├── layout/                 # 布局组件
│   │   │   ├── AdminLayout.tsx     # 管理后台布局
│   │   │   ├── Sidebar.tsx         # 侧边栏
│   │   │   ├── Header.tsx          # 顶部导航
│   │   │   └── Breadcrumb.tsx      # 面包屑
│   │   └── common/                 # 通用组件
│   │       ├── DataTable.tsx       # 数据表格
│   │       ├── SearchInput.tsx     # 搜索输入
│   │       ├── DateRangePicker.tsx # 日期范围选择
│   │       ├── ConfirmDialog.tsx   # 确认对话框
│   │       ├── StatCard.tsx        # 统计卡片
│   │       └── StatusBadge.tsx     # 状态徽章
│   │
│   ├── pages/                      # 页面
│   │   ├── auth/
│   │   │   └── LoginPage.tsx       # 登录页
│   │   ├── dashboard/
│   │   │   └── DashboardPage.tsx   # 仪表盘
│   │   ├── users/
│   │   │   ├── UserListPage.tsx    # 用户列表
│   │   │   └── UserDetailPage.tsx  # 用户详情
│   │   ├── subscriptions/
│   │   │   ├── PlanListPage.tsx    # 计划列表
│   │   │   ├── SubscriptionListPage.tsx  # 订阅列表
│   │   │   └── OrderListPage.tsx   # 订单列表
│   │   └── logs/
│   │       └── AuditLogPage.tsx    # 操作日志
│   │
│   ├── services/                   # API 服务
│   │   ├── api.ts                  # API 客户端
│   │   ├── auth.ts                 # 认证服务
│   │   ├── dashboard.ts            # 仪表盘服务
│   │   ├── users.ts                # 用户服务
│   │   ├── subscriptions.ts        # 订阅服务
│   │   └── auditLogs.ts            # 日志服务
│   │
│   ├── hooks/                      # 自定义 Hooks
│   │   ├── useAuth.ts              # 认证 Hook
│   │   ├── useUsers.ts             # 用户 Hook
│   │   ├── useSubscriptions.ts     # 订阅 Hook
│   │   └── useAuditLogs.ts         # 日志 Hook
│   │
│   ├── stores/                     # 状态管理
│   │   ├── authStore.ts            # 认证状态
│   │   └── uiStore.ts              # UI 状态
│   │
│   ├── routes/                     # 路由配置
│   │   ├── index.tsx               # 路由定义
│   │   └── ProtectedRoute.tsx      # 路由守卫
│   │
│   ├── lib/                        # 工具库
│   │   ├── utils.ts                # 工具函数
│   │   ├── constants.ts            # 常量
│   │   └── validators.ts           # 验证器
│   │
│   ├── types/                      # 类型定义
│   │   ├── admin.ts                # 管理员类型
│   │   ├── user.ts                 # 用户类型
│   │   ├── subscription.ts         # 订阅类型
│   │   └── api.ts                  # API 类型
│   │
│   └── styles/
│       └── globals.css             # 全局样式
│
├── package.json
├── tsconfig.json
├── vite.config.ts
├── tailwind.config.ts
└── postcss.config.js
```

### 5.3 路由设计

```typescript
// src/routes/index.tsx

export const routes = [
  // 公开路由
  {
    path: '/login',
    element: <LoginPage />,
  },

  // 受保护路由
  {
    path: '/',
    element: <ProtectedRoute><AdminLayout /></ProtectedRoute>,
    children: [
      // 仪表盘
      {
        index: true,
        element: <DashboardPage />,
      },

      // 用户管理
      {
        path: 'users',
        children: [
          { index: true, element: <UserListPage /> },
          { path: ':userId', element: <UserDetailPage /> },
        ],
      },

      // 订阅管理
      {
        path: 'subscriptions',
        children: [
          { index: true, element: <SubscriptionListPage /> },
          { path: 'plans', element: <PlanListPage /> },
          { path: 'orders', element: <OrderListPage /> },
        ],
      },

      // 操作日志
      {
        path: 'logs',
        element: <AuditLogPage />,
      },
    ],
  },
]
```

### 5.4 侧边栏菜单

```typescript
const menuItems = [
  {
    title: '概览',
    items: [
      { icon: LayoutDashboard, label: '仪表盘', path: '/' },
    ],
  },
  {
    title: '用户管理',
    items: [
      { icon: Users, label: '用户列表', path: '/users' },
    ],
  },
  {
    title: '订阅管理',
    items: [
      { icon: CreditCard, label: '订阅列表', path: '/subscriptions' },
      { icon: Package, label: '订阅计划', path: '/subscriptions/plans' },
      { icon: Receipt, label: '订单管理', path: '/subscriptions/orders' },
    ],
  },
  {
    title: '系统',
    items: [
      { icon: FileText, label: '操作日志', path: '/logs' },
    ],
  },
]
```

---

## 6. 安全设计

### 6.1 认证安全

| 安全措施 | 说明 |
|----------|------|
| 独立认证系统 | 管理员账号与用户账号完全隔离 |
| 强密码策略 | 最少 12 位，包含大小写字母、数字、特殊字符 |
| MFA 二次验证 | 支持 TOTP，超级管理员强制启用 |
| 会话超时 | 1 小时无操作自动登出 |
| 登录尝试限制 | 5 次失败后锁定 30 分钟 |
| IP 白名单 | 可选的 IP 白名单限制 |

### 6.2 权限控制

| 角色 | 权限范围 |
|------|----------|
| super_admin | 所有权限 |
| admin | 除系统配置外的所有权限 |
| operator | 只读权限 + 部分写权限（如调整订阅） |

### 6.3 审计日志

所有敏感操作记录审计日志：

| 操作类型 | 说明 |
|----------|------|
| admin.login | 管理员登录 |
| admin.logout | 管理员登出 |
| user.view | 查看用户详情 |
| user.suspend | 禁用用户 |
| user.activate | 启用用户 |
| user.password_reset | 重置用户密码 |
| user.subscription_adjust | 调整用户订阅 |
| user.force_logout | 强制用户登出 |
| plan.create | 创建订阅计划 |
| plan.update | 更新订阅计划 |
| order.refund | 处理退款 |
| export.users | 导出用户数据 |

### 6.4 数据脱敏

| 字段 | 脱敏规则 | 示例 |
|------|----------|------|
| 手机号 | 隐藏中间 4 位 | 138****8000 |
| 邮箱 | 隐藏 @ 前部分 | u***@example.com |
| 身份证 | 隐藏中间 10 位 | 110***********1234 |

---

## 7. 部署架构

### 7.1 开发环境

```
┌─────────────────────────────────────────────────────────────────┐
│                        开发环境                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────┐         ┌─────────────────┐              │
│   │   Vite Dev      │  proxy  │   Gateway       │              │
│   │   localhost:5180│ ──────► │   localhost:18789│             │
│   └─────────────────┘         └─────────────────┘              │
│                                       │                         │
│                                       ▼                         │
│                               ┌─────────────────┐              │
│                               │   PostgreSQL    │              │
│                               │   localhost:5432│              │
│                               └─────────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 生产环境

```
┌─────────────────────────────────────────────────────────────────┐
│                        生产环境                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────┐                                          │
│   │   管理员浏览器    │                                          │
│   └────────┬────────┘                                          │
│            │ HTTPS                                              │
│            ▼                                                    │
│   ┌─────────────────┐         ┌─────────────────┐              │
│   │   CDN/Nginx     │         │   API Gateway   │              │
│   │   admin.xxx.com │ ──────► │   api.xxx.com   │              │
│   └─────────────────┘         └────────┬────────┘              │
│                                        │                        │
│                                        ▼                        │
│                               ┌─────────────────┐              │
│                               │   Gateway 服务   │              │
│                               │   (内网)         │              │
│                               └────────┬────────┘              │
│                                        │                        │
│            ┌───────────────────────────┼───────────────────┐   │
│            ▼                           ▼                   ▼   │
│   ┌─────────────────┐         ┌─────────────────┐ ┌──────────┐│
│   │   PostgreSQL    │         │   Redis         │ │ 日志存储  ││
│   └─────────────────┘         └─────────────────┘ └──────────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 开发计划

### 8.1 第一期 (2 周)

| 周 | 任务 |
|---|------|
| Week 1 | 项目初始化、数据库设计、认证 API、登录页面 |
| Week 2 | 仪表盘、用户管理（列表+详情+操作）、操作日志 |

### 8.2 第二期 (1 周)

| 周 | 任务 |
|---|------|
| Week 3 | 订阅计划管理、用户订阅管理、订单管理 |

### 8.3 详细任务分解

#### Phase 1: 项目初始化 (Day 1)

- [ ] 创建 `apps/admin-console` 项目
- [ ] 配置 Vite、TypeScript、Tailwind
- [ ] 安装 shadcn/ui 组件
- [ ] 配置 ESLint、Prettier
- [ ] 创建基础目录结构

#### Phase 2: 数据库迁移 (Day 2)

- [ ] 创建 admins 表
- [ ] 创建 admin_sessions 表
- [ ] 创建 admin_audit_logs 表
- [ ] 创建 subscription_plans 表
- [ ] 创建 daily_stats 表
- [ ] 编写种子数据脚本

#### Phase 3: 认证系统 (Day 3-4)

- [ ] 实现管理员登录 API
- [ ] 实现 JWT 令牌生成和验证
- [ ] 实现会话管理
- [ ] 实现登录页面
- [ ] 实现认证状态管理

#### Phase 4: 仪表盘 (Day 5-6)

- [ ] 实现统计 API
- [ ] 实现趋势数据 API
- [ ] 实现仪表盘页面
- [ ] 实现统计卡片组件
- [ ] 实现图表组件

#### Phase 5: 用户管理 (Day 7-9)

- [ ] 实现用户列表 API
- [ ] 实现用户详情 API
- [ ] 实现用户操作 API（禁用、重置密码等）
- [ ] 实现用户列表页面
- [ ] 实现用户详情页面
- [ ] 实现数据表格组件
- [ ] 实现搜索筛选功能

#### Phase 6: 操作日志 (Day 10)

- [ ] 实现操作日志 API
- [ ] 实现操作日志页面
- [ ] 实现日志详情查看
- [ ] 实现日志导出功能

---

## 附录 A: 环境变量

```bash
# apps/admin-console/.env.development
VITE_API_BASE_URL=http://localhost:18789
VITE_APP_TITLE=OpenClaw Admin

# apps/admin-console/.env.production
VITE_API_BASE_URL=https://api.openclaw.ai
VITE_APP_TITLE=OpenClaw Admin
```

---

## 附录 B: 类型定义

```typescript
// src/types/admin.ts

export interface Admin {
  id: string
  username: string
  displayName: string
  email?: string
  phone?: string
  avatarUrl?: string
  role: 'super_admin' | 'admin' | 'operator'
  status: 'active' | 'disabled'
  mfaEnabled: boolean
  lastLoginAt?: string
  createdAt: string
}

export interface AdminSession {
  id: string
  adminId: string
  ipAddress: string
  userAgent: string
  expiresAt: string
  lastActiveAt: string
}

export interface AuditLog {
  id: string
  admin: {
    id: string
    displayName: string
  }
  action: string
  resourceType: string
  resourceId?: string
  before?: Record<string, unknown>
  after?: Record<string, unknown>
  reason?: string
  ipAddress: string
  createdAt: string
}

// src/types/subscription.ts

export interface SubscriptionPlan {
  id: string
  name: string
  code: string
  description?: string
  price: number
  period: 'month' | 'year'
  features: string[]
  limits: {
    devices: number
    skills: number
    dailyCalls: number
    storage?: number
  }
  isActive: boolean
  sortOrder: number
  subscriberCount?: number
}

// src/types/stats.ts

export interface DashboardStats {
  totalUsers: number
  newUsersToday: number
  activeUsers7d: number
  paidUsers: number
  revenueThisMonth: number
  onlineDevices: number
  apiCallsToday: number
}

export interface TrendData {
  labels: string[]
  values: number[]
}
```

---

## 附录 C: API 错误码

| 错误码 | HTTP 状态码 | 说明 |
|--------|-------------|------|
| AUTH_REQUIRED | 401 | 需要认证 |
| INVALID_CREDENTIALS | 401 | 用户名或密码错误 |
| ACCOUNT_DISABLED | 403 | 账户已禁用 |
| MFA_REQUIRED | 401 | 需要二次验证 |
| MFA_INVALID | 401 | MFA 验证码错误 |
| FORBIDDEN | 403 | 无权限 |
| NOT_FOUND | 404 | 资源不存在 |
| VALIDATION_ERROR | 400 | 参数验证失败 |
| RATE_LIMITED | 429 | 请求频率限制 |
| INTERNAL_ERROR | 500 | 服务器内部错误 |
