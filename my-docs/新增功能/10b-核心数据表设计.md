# 10b - 核心数据表设计

> 版本: 1.0 | 创建日期: 2026-02-12 | 状态: 规划中
>
> 上级文档: [10-多租户架构改造总体方案.md](./10-多租户架构改造总体方案.md)
>
> 参考文档: [03-记忆与存储系统设计.md](./03-记忆与存储系统设计.md)

---

## 1. 概述

本文档设计产品所需但尚未建表的核心数据结构。所有新表的设计原则：

- **所有用户数据表必须有 `userId` 外键**（多租户隔离基础）
- **使用 Drizzle ORM** 定义 schema，通过 drizzle-kit 生成 migration
- **与现有 schema 风格一致**：text 主键 UUID、timestamp with timezone、jsonb 复杂字段

---

## 2. 新增表设计

### 2.1 对话与消息

> 对应记忆系统 L2 情景记忆层（03-记忆与存储系统设计.md §2.1）

#### conversations（对话会话表）

| 字段          | 类型          | 约束                       | 说明                              |
| ------------- | ------------- | -------------------------- | --------------------------------- |
| id            | text          | PK                         | UUID                              |
| userId        | text          | FK → users.id, NOT NULL    | 所属用户                          |
| title         | text          |                            | 对话标题（AI 自动生成或用户命名） |
| type          | text enum     | NOT NULL                   | `chat` / `task` / `agent`         |
| status        | text enum     | NOT NULL, default `active` | `active` / `archived` / `deleted` |
| deviceId      | text          |                            | 发起对话的设备 ID                 |
| agentConfig   | jsonb         |                            | 本次对话的 Agent 配置快照         |
| metadata      | jsonb         |                            | 扩展元数据                        |
| lastMessageAt | timestamp(tz) |                            | 最后消息时间（冗余，加速排序）    |
| messageCount  | integer       | default 0                  | 消息数（冗余，加速展示）          |
| createdAt     | timestamp(tz) | NOT NULL                   | 创建时间                          |
| updatedAt     | timestamp(tz) | NOT NULL                   | 更新时间                          |

**索引**:

- `conversations_user_id_idx` → (userId)
- `conversations_user_updated_idx` → (userId, updatedAt DESC)
- `conversations_status_idx` → (status)

#### messages（对话消息表）

| 字段           | 类型          | 约束                            | 说明                                     |
| -------------- | ------------- | ------------------------------- | ---------------------------------------- |
| id             | text          | PK                              | UUID                                     |
| conversationId | text          | FK → conversations.id, NOT NULL | 所属对话                                 |
| userId         | text          | FK → users.id, NOT NULL         | 冗余 userId（加速查询）                  |
| role           | text enum     | NOT NULL                        | `user` / `assistant` / `system` / `tool` |
| content        | text          |                                 | 消息文本内容                             |
| contentType    | text enum     | default `text`                  | `text` / `markdown` / `json` / `image`   |
| toolCalls      | jsonb         |                                 | AI 工具调用记录                          |
| toolResults    | jsonb         |                                 | 工具执行结果                             |
| attachments    | jsonb         |                                 | 附件列表 `[{fileId, name, type, url}]`   |
| tokenCount     | integer       |                                 | Token 消耗数                             |
| modelId        | text          |                                 | 使用的 AI 模型 ID                        |
| metadata       | jsonb         |                                 | 扩展元数据                               |
| createdAt      | timestamp(tz) | NOT NULL                        | 创建时间                                 |

**索引**:

- `messages_conversation_id_idx` → (conversationId, createdAt)
- `messages_user_id_idx` → (userId)
- `messages_created_at_idx` → (createdAt)

**设计说明**:

- `userId` 冗余存储：避免每次查消息都要 JOIN conversations
- `toolCalls`/`toolResults` 用 jsonb：灵活记录不同工具的调用格式
- `attachments` 引用 `user_files` 表的 fileId

---

### 2.2 记忆

> 对应记忆系统 L2 情景记忆 + L3 档案记忆（03-记忆与存储系统设计.md §2.1）
>
> L1 工作记忆在 Redis/内存中，不需要建表
>
> L4 知识记忆在 Neo4j 中（Phase 5 引入），不在 PostgreSQL

#### user_memories（用户记忆表）

| 字段       | 类型          | 约束                    | 说明                                           |
| ---------- | ------------- | ----------------------- | ---------------------------------------------- |
| id         | text          | PK                      | UUID                                           |
| userId     | text          | FK → users.id, NOT NULL | 所属用户                                       |
| type       | text enum     | NOT NULL                | `episodic` / `profile` / `preference` / `fact` |
| category   | text          |                         | 记忆分类（如 `work`, `personal`, `skill`）     |
| content    | text          | NOT NULL                | 记忆文本内容                                   |
| summary    | text          |                         | 记忆摘要（用于展示）                           |
| embedding  | jsonb         |                         | 向量嵌入（初期 jsonb，Phase 5 迁移 pgvector）  |
| importance | integer       | default 5               | 重要性 1-10（影响检索权重）                    |
| sourceType | text enum     |                         | `conversation` / `file` / `manual` / `system`  |
| sourceId   | text          |                         | 来源 ID（conversationId / fileId）             |
| metadata   | jsonb         |                         | 扩展元数据                                     |
| expiresAt  | timestamp(tz) |                         | 过期时间（null = 永久）                        |
| isActive   | boolean       | default true            | 是否有效                                       |
| createdAt  | timestamp(tz) | NOT NULL                | 创建时间                                       |
| updatedAt  | timestamp(tz) | NOT NULL                | 更新时间                                       |

**索引**:

- `user_memories_user_id_idx` → (userId)
- `user_memories_user_type_idx` → (userId, type)
- `user_memories_user_category_idx` → (userId, category)
- `user_memories_importance_idx` → (importance DESC)
- `user_memories_expires_at_idx` → (expiresAt) WHERE expiresAt IS NOT NULL

**设计说明**:

- `embedding` 初期用 jsonb 存储向量数组，Phase 5 引入 pgvector 后改为 `vector(1536)` 类型
- `type` 对应记忆系统的 L2（episodic）和 L3（profile, preference, fact）
- `importance` 由 AI 自动评估，影响检索时的排序权重
- `expiresAt` 实现"选择性遗忘"（参考 03-记忆与存储系统设计.md §8.2）

---

### 2.3 文件存储

> 对应 03-记忆与存储系统设计.md §6 多媒体存储

#### user_files（用户文件元数据表）

| 字段          | 类型          | 约束                    | 说明                                                   |
| ------------- | ------------- | ----------------------- | ------------------------------------------------------ |
| id            | text          | PK                      | UUID                                                   |
| userId        | text          | FK → users.id, NOT NULL | 所属用户                                               |
| fileName      | text          | NOT NULL                | 原始文件名                                             |
| fileSize      | integer       | NOT NULL                | 文件大小（字节）                                       |
| mimeType      | text          | NOT NULL                | MIME 类型                                              |
| storageKey    | text          | NOT NULL                | MinIO 存储 key                                         |
| storageBucket | text          | NOT NULL                | MinIO bucket 名                                        |
| category      | text enum     | default `attachment`    | `attachment` / `avatar` / `skill_package` / `document` |
| sourceType    | text enum     |                         | `conversation` / `upload` / `skill`                    |
| sourceId      | text          |                         | 来源 ID                                                |
| thumbnailKey  | text          |                         | 缩略图存储 key                                         |
| checksum      | text          |                         | 文件 SHA-256 哈希                                      |
| metadata      | jsonb         |                         | 扩展元数据（图片尺寸、PDF 页数等）                     |
| isPublic      | boolean       | default false           | 是否公开可访问                                         |
| expiresAt     | timestamp(tz) |                         | 过期时间（临时文件）                                   |
| createdAt     | timestamp(tz) | NOT NULL                | 上传时间                                               |

**索引**:

- `user_files_user_id_idx` → (userId)
- `user_files_storage_key_idx` → (storageKey) UNIQUE
- `user_files_category_idx` → (category)
- `user_files_expires_at_idx` → (expiresAt) WHERE expiresAt IS NOT NULL

**MinIO Bucket 路径规则**（参考 03-记忆与存储系统设计.md §6.1）:

```
openclaw-media/
├── {userId}/avatars/          # 头像
├── {userId}/attachments/      # 对话附件
│   └── {conversationId}/
├── {userId}/documents/        # 文档
├── {userId}/skills/           # 自建技能包
└── exports/{userId}/          # 导出文件
```

---

### 2.4 用户自建技能

> 对应 01-产品与架构设计.md §5 技能系统

#### user_custom_skills（用户自建技能表）

| 字段          | 类型          | 约束                      | 说明                                                     |
| ------------- | ------------- | ------------------------- | -------------------------------------------------------- |
| id            | text          | PK                        | UUID                                                     |
| userId        | text          | FK → users.id, NOT NULL   | 所属用户                                                 |
| name          | text          | NOT NULL                  | 技能名称                                                 |
| description   | text          |                           | 技能描述                                                 |
| version       | text          | default '1.0.0'           | 版本号                                                   |
| code          | text          |                           | 技能代码（小型技能直接存 DB）                            |
| packageFileId | text          | FK → user_files.id        | 技能包文件 ID（大型技能）                                |
| manifest      | jsonb         | NOT NULL                  | 技能清单（入口、权限、依赖等）                           |
| status        | text enum     | NOT NULL, default `draft` | `draft` / `testing` / `ready` / `published` / `disabled` |
| testResults   | jsonb         |                           | 最近测试结果                                             |
| syncedDevices | jsonb         |                           | 已同步的设备 ID 列表                                     |
| isPublished   | boolean       | default false             | 是否已提交到技能商店                                     |
| storeItemId   | text          | FK → skill_store_items.id | 关联的商店条目                                           |
| metadata      | jsonb         |                           | 扩展元数据                                               |
| createdAt     | timestamp(tz) | NOT NULL                  | 创建时间                                                 |
| updatedAt     | timestamp(tz) | NOT NULL                  | 更新时间                                                 |

**索引**:

- `user_custom_skills_user_id_idx` → (userId)
- `user_custom_skills_status_idx` → (status)
- `user_custom_skills_user_name_idx` → (userId, name) UNIQUE

**设计说明**:

- 小型技能（<100KB）直接存 `code` 字段；大型技能存 MinIO，`packageFileId` 指向 user_files
- `manifest` 包含技能元信息：工具声明、权限需求、运行时依赖
- `syncedDevices` 记录已同步设备，便于增量同步
- `storeItemId` 关联到 skill_store_items，实现"发布到商店"

#### 技能生命周期

```
用户创建 (draft) → AI 辅助测试 (testing) → 本地可用 (ready)
                                                ↓
                                        同步到设备 (syncedDevices)
                                                ↓
                                    提交到商店审核 (published → skill_store_items)
```

---

### 2.5 AI 助手配置

#### user_assistant_configs（用户助手配置表）

| 字段              | 类型          | 约束                    | 说明                   |
| ----------------- | ------------- | ----------------------- | ---------------------- |
| id                | text          | PK                      | UUID                   |
| userId            | text          | FK → users.id, NOT NULL | 所属用户               |
| name              | text          | NOT NULL                | 助手名称（如"小助手"） |
| isDefault         | boolean       | default false           | 是否为默认助手配置     |
| personality       | jsonb         |                         | 性格设定               |
| preferences       | jsonb         |                         | 交互偏好               |
| modelConfig       | jsonb         |                         | AI 模型配置            |
| devicePermissions | jsonb         |                         | 设备级权限配置         |
| systemPrompt      | text          |                         | 自定义系统提示         |
| metadata          | jsonb         |                         | 扩展元数据             |
| createdAt         | timestamp(tz) | NOT NULL                | 创建时间               |
| updatedAt         | timestamp(tz) | NOT NULL                | 更新时间               |

**索引**:

- `user_assistant_configs_user_id_idx` → (userId)
- `user_assistant_configs_default_idx` → (userId, isDefault) WHERE isDefault = true

**personality 结构**:

```typescript
interface AssistantPersonality {
  /** 语气风格: formal / casual / friendly / professional */
  tone?: string;
  /** 回复详细程度: concise / balanced / detailed */
  verbosity?: string;
  /** 是否主动建议 */
  proactive?: boolean;
  /** 幽默感程度 0-10 */
  humor?: number;
  /** 自定义角色描述 */
  roleDescription?: string;
}
```

**preferences 结构**:

```typescript
interface AssistantPreferences {
  /** 首选语言 */
  language?: string;
  /** 时区 */
  timezone?: string;
  /** 操作确认阈值: low / medium / high（越高越谨慎） */
  confirmationLevel?: string;
  /** 自动执行任务的范围 */
  autoExecuteScopes?: string[];
}
```

**modelConfig 结构**:

```typescript
interface AssistantModelConfig {
  /** 首选模型 */
  modelId?: string;
  /** 温度 */
  temperature?: number;
  /** 最大 token */
  maxTokens?: number;
  /** 自定义模型参数 */
  params?: Record<string, unknown>;
}
```

**devicePermissions 结构**:

```typescript
interface DevicePermissions {
  /** 设备 ID → 权限列表 */
  [deviceId: string]: {
    /** 允许的操作类型 */
    allowedOperations?: string[];
    /** 禁止的操作类型 */
    deniedOperations?: string[];
    /** 允许访问的路径 */
    allowedPaths?: string[];
    /** 禁止访问的路径 */
    deniedPaths?: string[];
  };
}
```

---

### 2.6 用量配额

#### usage_quotas（用量配额表）

| 字段        | 类型          | 约束                    | 说明                                                      |
| ----------- | ------------- | ----------------------- | --------------------------------------------------------- |
| id          | text          | PK                      | UUID                                                      |
| userId      | text          | FK → users.id, NOT NULL | 所属用户                                                  |
| quotaType   | text enum     | NOT NULL                | `tokens` / `storage` / `devices` / `skills` / `api_calls` |
| periodStart | timestamp(tz) | NOT NULL                | 计费周期开始                                              |
| periodEnd   | timestamp(tz) | NOT NULL                | 计费周期结束                                              |
| limitValue  | integer       | NOT NULL                | 配额上限                                                  |
| usedValue   | integer       | default 0               | 已使用量                                                  |
| metadata    | jsonb         |                         | 扩展元数据                                                |
| createdAt   | timestamp(tz) | NOT NULL                | 创建时间                                                  |
| updatedAt   | timestamp(tz) | NOT NULL                | 更新时间                                                  |

**索引**:

- `usage_quotas_user_type_period_idx` → (userId, quotaType, periodStart) UNIQUE
- `usage_quotas_user_id_idx` → (userId)
- `usage_quotas_period_end_idx` → (periodEnd)

**设计说明**:

- 每月为每个用户创建一条配额记录
- `limitValue` 根据用户订阅套餐的 `tokensPerMonth`/`storageMb`/`maxDevices` 设定
- 配额检查由 Gateway 在 Agent 调用 AI 模型前执行
- 可通过 Redis 缓存当前配额值，减少 DB 查询

---

## 3. ER 关系总览

```
users (已有)
  │
  ├── conversations (新增)
  │     └── messages (新增)
  │
  ├── user_memories (新增)
  │
  ├── user_files (新增)
  │
  ├── user_custom_skills (新增)
  │     └── → user_files (技能包)
  │     └── → skill_store_items (发布)
  │
  ├── user_assistant_configs (新增)
  │
  ├── usage_quotas (新增)
  │
  ├── user_devices (已有)
  ├── subscriptions (已有)
  ├── user_skills (已有)
  ├── user_installed_skills (已有)
  ├── audit_logs (已有)
  └── export_logs (已有)
```

---

## 4. 实施步骤

### Step 1: 创建 Schema 文件

- `src/db/schema/conversations.ts` — conversations + messages
- `src/db/schema/memories.ts` — user_memories
- `src/db/schema/files.ts` — user_files
- `src/db/schema/custom-skills.ts` — user_custom_skills
- `src/db/schema/assistant-configs.ts` — user_assistant_configs
- `src/db/schema/usage-quotas.ts` — usage_quotas
- 更新 `src/db/schema/index.ts` 导出

### Step 2: 生成 Migration

```bash
pnpm db:generate   # 生成 migration SQL
pnpm db:migrate    # 应用到数据库
```

### Step 3: 创建 Repository

- `src/db/repositories/conversations.ts` — extends TenantScopedRepository
- `src/db/repositories/memories.ts`
- `src/db/repositories/files.ts`
- `src/db/repositories/custom-skills.ts`
- `src/db/repositories/assistant-configs.ts`
- `src/db/repositories/usage-quotas.ts`
- 更新 `src/db/repositories/index.ts` 导出

### Step 4: 单元测试

每个 Repository 编写基础 CRUD 测试 + userId 隔离测试

---

## 5. 与记忆系统设计的对应关系

参考 03-记忆与存储系统设计.md：

| 记忆层级       | 本方案对应                                                                | 存储技术           |
| -------------- | ------------------------------------------------------------------------- | ------------------ |
| L1 工作记忆    | Redis 缓存（Phase 5）                                                     | Redis / 内存       |
| L2 情景记忆    | `user_memories` (type=episodic) + `conversations`/`messages`              | PostgreSQL         |
| L3 档案记忆    | `user_memories` (type=profile/preference/fact) + `user_assistant_configs` | PostgreSQL         |
| L4 知识记忆    | Phase 5 引入 Neo4j                                                        | Neo4j（延后）      |
| 多媒体存储     | `user_files` + MinIO                                                      | PostgreSQL + MinIO |
| 记忆提供者接口 | Phase 5 实现 MemoryProvider                                               | 代码层             |

---

_— 文档结束 —_
