# 10g - 多租户架构改造详细实施计划

> 版本: 1.0 | 创建日期: 2026-02-12 | 状态: 规划中
>
> 上级文档: [10-多租户架构改造总体方案.md](./10-多租户架构改造总体方案.md)

---

## 修订记录

| 版本 | 日期       | 修订内容             |
| ---- | ---------- | -------------------- |
| 1.0  | 2026-02-12 | 初稿，12 Sprint 计划 |

---

## 1. 计划总则

### 1.1 实施原则

1. **自闭环**：每个 Sprint 完成后，系统可正常运行，不引入半成品
2. **先测试后推进**：每个 Sprint 包含完整的测试验收，通过后才进入下一个
3. **向后兼容**：改造期间不破坏现有功能，新旧代码共存
4. **小步快跑**：Sprint 粒度足够小，单个 Sprint 可独立评审和回滚

### 1.2 Sprint 总览

```
┌─────────────────────────────────────────────────────────────────────┐
│                    第一阶段：数据库层                                 │
│                                                                     │
│  Sprint 1          Sprint 2          Sprint 3          Sprint 4     │
│  多租户基础层      对话与消息表      记忆与文件表      技能/配置/配额 │
│  ────────────►  ────────────►  ────────────►  ────────────►        │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                    第二阶段：App Server                              │
│                                                                     │
│  Sprint 5          Sprint 6          Sprint 7          Sprint 8     │
│  服务脚手架        管理员API(P0)     管理员API+用户API  新功能API    │
│  ────────────►  ────────────►  ────────────►  ────────────►        │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                    第三阶段：Agent 改造                              │
│                                                                     │
│  Sprint 9                    Sprint 10                              │
│  Agent多租户基础              Agent高级功能                          │
│  ────────────────────►  ────────────────────►                      │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                    第四阶段：基础设施 + 前端                         │
│                                                                     │
│  Sprint 11                   Sprint 12                              │
│  Redis/MinIO/pgvector        前端API迁移                            │
│  ────────────────────►  ────────────────────►                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.3 依赖关系图

```
Sprint 1 (多租户基础层)
   ↓
Sprint 2 (对话与消息表) ─── Sprint 3 (记忆与文件表) ─── Sprint 4 (技能/配置/配额)
   ↓                              ↓                              ↓
   └──────────────────────────────┴──────────────────────────────┘
                                  ↓
                          Sprint 5 (App Server 脚手架)
                                  ↓
                    Sprint 6 (管理员 API P0)
                                  ↓
              Sprint 7 (管理员 API P1 + 用户 API)
                                  ↓
                    Sprint 8 (新功能 API)
                                  ↓
              Sprint 9 (Agent 多租户基础) ←── 依赖 Sprint 2 的 conversations/messages
                                  ↓
              Sprint 10 (Agent 高级功能) ←── 依赖 Sprint 4 的 usage_quotas
                                  ↓
              Sprint 11 (基础设施) ←── 可与 Sprint 5-8 部分并行
                                  ↓
              Sprint 12 (前端迁移) ←── 依赖 Sprint 6-8 的 REST API
```

### 1.4 测试策略

每个 Sprint 的测试层级：

| 层级     | 工具        | 覆盖率要求 | 何时执行        |
| -------- | ----------- | ---------- | --------------- |
| 单元测试 | Vitest      | ≥80%       | 每个任务完成后  |
| 集成测试 | Vitest + DB | 关键路径   | Sprint 完成后   |
| 回归测试 | `pnpm test` | 全量通过   | Sprint 完成后   |
| E2E 测试 | Playwright  | 关键流程   | 前端相关 Sprint |

---

## 2. 第一阶段：数据库层

> 设计文档: [10a-数据库多租户隔离方案.md](./10a-数据库多租户隔离方案.md), [10b-核心数据表设计.md](./10b-核心数据表设计.md)

### Sprint 1: 多租户基础层

**目标**: 建立多租户代码基础设施，不改变任何现有行为

**前置依赖**: 无

#### 任务清单

| #   | 任务                                 | 产出文件                                  |
| --- | ------------------------------------ | ----------------------------------------- |
| 1.1 | 创建 TenantScopedRepository 基类     | `src/db/repositories/tenant-scope.ts`     |
| 1.2 | 创建 auth-context 工具函数           | `src/gateway/auth-context.ts`             |
| 1.3 | 现有 Repository 补充可选 userId 参数 | `src/db/repositories/subscriptions.ts` 等 |
| 1.4 | 更新 Repository index 导出           | `src/db/repositories/index.ts`            |

#### 任务 1.1 详细说明

**文件**: `src/db/repositories/tenant-scope.ts`

```typescript
export class TenantScopedRepository {
  constructor(
    protected readonly db: Database,
    protected readonly userId: string,
  ) {
    if (!userId) {
      throw new Error("[TenantScopedRepository] userId is required");
    }
  }
  get tenantId(): string {
    return this.userId;
  }
}
```

**测试要点**:

- 构造时 userId 为空字符串抛出异常
- 构造时 userId 为 undefined 抛出异常
- 正常构造时 tenantId 返回 userId

#### 任务 1.2 详细说明

**文件**: `src/gateway/auth-context.ts`

```typescript
interface UserContext {
  userId: string;
  deviceId?: string;
  role?: string;
}

function extractUserContext(params: Record<string, unknown>): UserContext;
```

**测试要点**:

- 从 Bearer Token 正确提取 userId
- Token 过期时抛出 AuthError
- 无 Token 时从设备连接回退提取
- 完全无认证时抛出 AuthError

#### 任务 1.3 详细说明

修改现有 Repository 方法，**向后兼容**地添加可选 userId 参数：

```typescript
// 改造前
async findById(id: string): Promise<Subscription | null>

// 改造后（向后兼容）
async findById(id: string, userId?: string): Promise<Subscription | null>
```

**需要检查的文件**:

- `src/db/repositories/subscriptions.ts` → findById 增加可选 userId
- `src/db/repositories/users.ts` → findById 增加 isActive 校验
- `src/db/repositories/audit.ts` → findAll 增加可选 userId 过滤

**测试要点**:

- 不传 userId 时行为与改造前完全一致（向后兼容）
- 传 userId 时正确过滤
- 传 userId 但数据属于其他用户时返回 null

#### 验收标准

| #   | 标准                                | 验证命令                                                   |
| --- | ----------------------------------- | ---------------------------------------------------------- |
| 1   | TenantScopedRepository 单元测试通过 | `pnpm vitest run src/db/repositories/tenant-scope.test.ts` |
| 2   | auth-context 单元测试通过           | `pnpm vitest run src/gateway/auth-context.test.ts`         |
| 3   | 现有 Repository 改造后单元测试通过  | `pnpm vitest run src/db/repositories/`                     |
| 4   | 全量测试通过（不破坏现有功能）      | `pnpm test`                                                |
| 5   | Lint 通过                           | `pnpm lint`                                                |

---

### Sprint 2: 核心数据表 — 对话与消息

**目标**: 创建 conversations + messages 表及 Repository

**前置依赖**: Sprint 1（TenantScopedRepository 基类）

#### 任务清单

| #   | 任务                                 | 产出文件                                    |
| --- | ------------------------------------ | ------------------------------------------- |
| 2.1 | 创建 conversations + messages schema | `src/db/schema/conversations.ts`            |
| 2.2 | 更新 schema index 导出               | `src/db/schema/index.ts`                    |
| 2.3 | 生成并执行 migration                 | `src/db/migrations/XXXX_conversations.sql`  |
| 2.4 | 创建 ConversationRepository          | `src/db/repositories/conversations.ts`      |
| 2.5 | 创建 MessageRepository               | `src/db/repositories/messages.ts`           |
| 2.6 | 更新 Repository index 导出           | `src/db/repositories/index.ts`              |
| 2.7 | 编写单元测试                         | `src/db/repositories/conversations.test.ts` |

#### Schema 定义要点

- conversations: id, userId(FK), title, type, status, deviceId, agentConfig, metadata, lastMessageAt, messageCount, createdAt, updatedAt
- messages: id, conversationId(FK), userId(FK), role, content, contentType, toolCalls, toolResults, attachments, tokenCount, modelId, metadata, createdAt
- 索引: userId, (userId, updatedAt DESC), (conversationId, createdAt)

#### Repository 实现要点

- ConversationRepository extends TenantScopedRepository
- 自动 userId 过滤: findAll, findById, create, update, delete
- MessageRepository extends TenantScopedRepository
- 按 conversationId 分页查询时也校验 userId

#### 验收标准

| #   | 标准                                       | 验证命令                                                    |
| --- | ------------------------------------------ | ----------------------------------------------------------- |
| 1   | `pnpm db:generate` 生成 migration 无报错   | `pnpm db:generate`                                          |
| 2   | `pnpm db:migrate` 执行成功                 | `pnpm db:migrate`                                           |
| 3   | ConversationRepository CRUD 测试通过       | `pnpm vitest run src/db/repositories/conversations.test.ts` |
| 4   | MessageRepository CRUD 测试通过            | `pnpm vitest run src/db/repositories/messages.test.ts`      |
| 5   | userId 隔离测试通过（用户 A 查不到用户 B） | 同上                                                        |
| 6   | 全量测试通过                               | `pnpm test`                                                 |

---

### Sprint 3: 核心数据表 — 记忆与文件

**目标**: 创建 user_memories + user_files 表及 Repository

**前置依赖**: Sprint 1（TenantScopedRepository）

#### 任务清单

| #   | 任务                      | 产出文件                                    |
| --- | ------------------------- | ------------------------------------------- |
| 3.1 | 创建 user_memories schema | `src/db/schema/memories.ts`                 |
| 3.2 | 创建 user_files schema    | `src/db/schema/files.ts`                    |
| 3.3 | 更新 schema index 导出    | `src/db/schema/index.ts`                    |
| 3.4 | 生成并执行 migration      | `src/db/migrations/XXXX_memories_files.sql` |
| 3.5 | 创建 MemoryRepository     | `src/db/repositories/memories.ts`           |
| 3.6 | 创建 FileRepository       | `src/db/repositories/files.ts`              |
| 3.7 | 编写单元测试              | 对应 .test.ts 文件                          |

#### 特殊说明

- user_memories.embedding 字段初期用 `jsonb` 类型（Sprint 11 pgvector 引入后迁移为 `vector(1536)`）
- user_files.storageKey 初期只存路径字符串（Sprint 11 MinIO 引入后才有实际文件）
- MemoryRepository 包含按 type 过滤、按 importance 排序的查询方法
- FileRepository 包含按 category 过滤、storageKey 唯一索引校验

#### 验收标准

| #   | 标准                                        | 验证命令                                               |
| --- | ------------------------------------------- | ------------------------------------------------------ |
| 1   | Migration 生成并执行成功                    | `pnpm db:generate && pnpm db:migrate`                  |
| 2   | MemoryRepository CRUD + userId 隔离测试通过 | `pnpm vitest run src/db/repositories/memories.test.ts` |
| 3   | FileRepository CRUD + userId 隔离测试通过   | `pnpm vitest run src/db/repositories/files.test.ts`    |
| 4   | 全量测试通过                                | `pnpm test`                                            |

---

### Sprint 4: 核心数据表 — 技能/配置/配额

**目标**: 创建 user_custom_skills + user_assistant_configs + usage_quotas 表及 Repository

**前置依赖**: Sprint 1（TenantScopedRepository）

#### 任务清单

| #   | 任务                               | 产出文件                                           |
| --- | ---------------------------------- | -------------------------------------------------- |
| 4.1 | 创建 user_custom_skills schema     | `src/db/schema/custom-skills.ts`                   |
| 4.2 | 创建 user_assistant_configs schema | `src/db/schema/assistant-configs.ts`               |
| 4.3 | 创建 usage_quotas schema           | `src/db/schema/usage-quotas.ts`                    |
| 4.4 | 更新 schema index 导出             | `src/db/schema/index.ts`                           |
| 4.5 | 生成并执行 migration               | `src/db/migrations/XXXX_skills_configs_quotas.sql` |
| 4.6 | 创建 CustomSkillRepository         | `src/db/repositories/custom-skills.ts`             |
| 4.7 | 创建 AssistantConfigRepository     | `src/db/repositories/assistant-configs.ts`         |
| 4.8 | 创建 UsageQuotaRepository          | `src/db/repositories/usage-quotas.ts`              |
| 4.9 | 编写单元测试                       | 对应 .test.ts 文件                                 |

#### 特殊说明

- user_custom_skills: (userId, name) 唯一约束；packageFileId FK → user_files.id
- user_assistant_configs: (userId, isDefault) 部分唯一约束；确保每用户只有一个 isDefault=true
- usage_quotas: (userId, quotaType, periodStart) 唯一约束；incrementUsage 方法需原子操作
- AssistantConfigRepository.findDefault(userId) → 查找 isDefault=true 的配置
- UsageQuotaRepository.findCurrent(userId, quotaType) → 查找当前有效期的配额
- UsageQuotaRepository.incrementUsage(userId, quotaType, amount) → 原子递增 usedValue

#### 验收标准

| #   | 标准                                         | 验证命令                                                        |
| --- | -------------------------------------------- | --------------------------------------------------------------- |
| 1   | Migration 生成并执行成功                     | `pnpm db:generate && pnpm db:migrate`                           |
| 2   | CustomSkillRepository CRUD + 隔离测试通过    | `pnpm vitest run src/db/repositories/custom-skills.test.ts`     |
| 3   | AssistantConfigRepository + findDefault 测试 | `pnpm vitest run src/db/repositories/assistant-configs.test.ts` |
| 4   | UsageQuotaRepository + incrementUsage 原子性 | `pnpm vitest run src/db/repositories/usage-quotas.test.ts`      |
| 5   | 全量测试通过                                 | `pnpm test`                                                     |

---

### 第一阶段完成检查点

**完成 Sprint 1-4 后的系统状态**:

- ✅ TenantScopedRepository 基类可用
- ✅ auth-context 工具函数可用
- ✅ 现有 Repository 向后兼容地支持可选 userId
- ✅ 7 张新表已创建（conversations, messages, user_memories, user_files, user_custom_skills, user_assistant_configs, usage_quotas）
- ✅ 7 个新 Repository 已实现并测试
- ✅ 所有新 Repository 继承 TenantScopedRepository，自动 userId 隔离
- ✅ 现有功能完全不受影响
- ✅ 全量测试通过

**里程碑验证**:

```bash
pnpm db:migrate && pnpm test && pnpm lint
```

---

## 3. 第二阶段：App Server

> 设计文档: [10c-AppServer设计方案.md](./10c-AppServer设计方案.md)

### Sprint 5: App Server 脚手架

**目标**: 创建可启动的 Fastify HTTP 服务，具备认证和错误处理能力

**前置依赖**: Sprint 1-4（Repository 层）

#### 任务清单

| #   | 任务                           | 产出文件                                        |
| --- | ------------------------------ | ----------------------------------------------- |
| 5.1 | 创建 apps/api-server/ 项目结构 | `apps/api-server/package.json`, `tsconfig.json` |
| 5.2 | 实现 Fastify 服务入口          | `apps/api-server/src/server.ts`, `app.ts`       |
| 5.3 | 实现环境变量配置               | `apps/api-server/src/config.ts`                 |
| 5.4 | 实现用户 JWT 认证插件          | `apps/api-server/src/plugins/auth.ts`           |
| 5.5 | 实现管理员 JWT 认证插件        | `apps/api-server/src/plugins/admin-auth.ts`     |
| 5.6 | 实现全局错误处理插件           | `apps/api-server/src/plugins/error-handler.ts`  |
| 5.7 | 实现健康检查路由               | `apps/api-server/src/routes/health.ts`          |
| 5.8 | 编写测试                       | 对应 .test.ts 文件                              |

#### 关键设计

- `package.json` 引用 workspace 依赖：`"@openclaw/db": "workspace:*"`（或直接 import src/db/）
- Fastify 插件注册顺序：CORS → Rate Limit → Error Handler → Auth → Routes
- 认证插件复用 `src/assistant/admin-auth/` 和 `src/gateway/auth.ts` 的 JWT 校验逻辑
- 健康检查端点：`GET /api/health` 返回 `{ status, version, uptime }`

#### 验收标准

| #   | 标准                                      | 验证命令                                |
| --- | ----------------------------------------- | --------------------------------------- |
| 1   | `pnpm --filter api-server build` 构建成功 | 构建命令                                |
| 2   | 服务启动后 `GET /api/health` 返回 200     | `curl http://localhost:3000/api/health` |
| 3   | 无 Token 访问受保护路由返回 401           | 测试                                    |
| 4   | 有效 Token 访问受保护路由返回 200         | 测试                                    |
| 5   | 无效 Token 返回 401                       | 测试                                    |
| 6   | 管理员 Token 和用户 Token 正确区分        | 测试                                    |

---

### Sprint 6: App Server — 管理员 API (P0)

**目标**: 迁移最核心的管理员 API，使 admin-console 可以通过 HTTP 访问

**前置依赖**: Sprint 5（App Server 脚手架）

#### 任务清单

| #   | 任务           | 产出文件                                            |
| --- | -------------- | --------------------------------------------------- |
| 6.1 | 管理员认证 API | `apps/api-server/src/routes/admin/auth.ts`          |
| 6.2 | 用户管理 API   | `apps/api-server/src/routes/admin/users.ts`         |
| 6.3 | 订阅管理 API   | `apps/api-server/src/routes/admin/subscriptions.ts` |
| 6.4 | 套餐管理 API   | `apps/api-server/src/routes/admin/plans.ts`         |
| 6.5 | 编写集成测试   | 对应 .test.ts 文件                                  |

#### API 映射

```
POST   /api/admin/auth/login        ← admin.login
POST   /api/admin/auth/refresh       ← admin.refreshToken
POST   /api/admin/auth/logout        ← admin.logout
POST   /api/admin/auth/password      ← admin.changePassword

GET    /api/admin/users              ← admin.users.list
GET    /api/admin/users/:id          ← admin.users.get
POST   /api/admin/users/:id/suspend  ← admin.users.suspend
POST   /api/admin/users/:id/activate ← admin.users.activate
GET    /api/admin/users/stats        ← admin.users.stats

GET    /api/admin/subscriptions      ← admin.subscriptions.list
POST   /api/admin/subscriptions/:id/cancel     ← admin.subscriptions.cancel
POST   /api/admin/subscriptions/:id/extend     ← admin.subscriptions.extend
GET    /api/admin/subscriptions/stats          ← admin.subscriptions.stats

GET    /api/admin/plans              ← admin.plans.list
POST   /api/admin/plans              ← admin.plans.create
PUT    /api/admin/plans/:id          ← admin.plans.update
```

#### 关键设计

- 每个路由复用现有 Service 层（如 `getAdminUserService()`、`getAdminSubscriptionService()`）
- 管理员角色权限校验：operator < admin < super_admin
- 请求参数用 Zod schema 校验
- 响应格式统一：`{ success: true, data: {...}, meta?: {...} }`
- 审计日志：所有写操作记录 adminId + IP + UserAgent

#### 验收标准

| #   | 标准                                     | 验证方式    |
| --- | ---------------------------------------- | ----------- |
| 1   | 管理员登录获取 Token                     | 集成测试    |
| 2   | 用户列表分页+搜索+过滤                   | 集成测试    |
| 3   | 用户停用/激活审计日志正确                | 集成测试    |
| 4   | 订阅操作权限校验（admin vs super_admin） | 集成测试    |
| 5   | 套餐 CRUD 与 Gateway RPC 结果一致        | 对比测试    |
| 6   | 全量测试通过                             | `pnpm test` |

---

### Sprint 7: App Server — 管理员 API (P1) + 用户 API

**目标**: 完成剩余管理员 API 和用户基础 API

**前置依赖**: Sprint 6

#### 任务清单

| #   | 任务           | 产出文件                                        |
| --- | -------------- | ----------------------------------------------- |
| 7.1 | 技能管理 API   | `apps/api-server/src/routes/admin/skills.ts`    |
| 7.2 | 审计日志 API   | `apps/api-server/src/routes/admin/audit.ts`     |
| 7.3 | 系统配置 API   | `apps/api-server/src/routes/admin/config.ts`    |
| 7.4 | 监控 API       | `apps/api-server/src/routes/admin/monitor.ts`   |
| 7.5 | 仪表盘 API     | `apps/api-server/src/routes/admin/dashboard.ts` |
| 7.6 | 用户认证 API   | `apps/api-server/src/routes/auth/index.ts`      |
| 7.7 | 用户自服务 API | `apps/api-server/src/routes/users/index.ts`     |
| 7.8 | 编写集成测试   | 对应 .test.ts 文件                              |

#### API 映射（管理员）

```
GET    /api/admin/skills             ← admin.skills.list
POST   /api/admin/skills             ← admin.skills.create
POST   /api/admin/skills/:id/review  ← admin.skills.review
POST   /api/admin/skills/:id/publish ← admin.skills.publish
GET    /api/admin/skills/categories  ← admin.skills.categories.list
...（完整列表见 10c §4.10）

GET    /api/admin/audit-logs         ← admin.audit.list
GET    /api/admin/config             ← admin.config.list
PUT    /api/admin/config/:key        ← admin.config.update
GET    /api/admin/monitor/*          ← admin.monitor.*
GET    /api/admin/dashboard          ← admin.dashboard.*
```

#### API 映射（用户）

```
POST   /api/auth/register            ← assistant.auth.register
POST   /api/auth/login               ← assistant.auth.login
POST   /api/auth/refresh             ← assistant.auth.refreshToken
POST   /api/auth/send-code           ← assistant.auth.sendCode
POST   /api/auth/logout              ← assistant.auth.logout

GET    /api/users/me                  ← 新增
PUT    /api/users/me                  ← 新增
GET    /api/users/me/devices          ← assistant.device.list
GET    /api/users/me/subscription     ← assistant.subscription.info
```

#### 验收标准

| #   | 标准                                   | 验证方式    |
| --- | -------------------------------------- | ----------- |
| 1   | 所有管理员 API 与 Gateway RPC 结果一致 | 对比测试    |
| 2   | 用户注册 + 登录 + Token 刷新流程完整   | 集成测试    |
| 3   | 用户 /me 接口返回当前用户信息          | 集成测试    |
| 4   | 用户 A 的 Token 无法访问用户 B 的数据  | 隔离测试    |
| 5   | 全量测试通过                           | `pnpm test` |

---

### Sprint 8: App Server — 新功能 API

**目标**: 实现 Sprint 2-4 新建表对应的 CRUD API

**前置依赖**: Sprint 7（用户认证 API）+ Sprint 2-4（新表 Repository）

#### 任务清单

| #   | 任务                                      | 产出文件                                               |
| --- | ----------------------------------------- | ------------------------------------------------------ |
| 8.1 | 对话管理 API                              | `apps/api-server/src/routes/conversations/index.ts`    |
| 8.2 | 记忆管理 API                              | `apps/api-server/src/routes/memories/index.ts`         |
| 8.3 | AI 助手配置 API                           | `apps/api-server/src/routes/assistant-config/index.ts` |
| 8.4 | 用户自建技能 API                          | `apps/api-server/src/routes/skills/index.ts`           |
| 8.5 | 文件管理 API（元数据 CRUD，不含实际上传） | `apps/api-server/src/routes/files/index.ts`            |
| 8.6 | 技能商店 API                              | `apps/api-server/src/routes/store/index.ts`            |
| 8.7 | Swagger 文档配置                          | `apps/api-server/src/plugins/swagger.ts`               |
| 8.8 | 编写集成测试                              | 对应 .test.ts 文件                                     |

#### 关键设计

- 所有用户 API 自动从 JWT Token 提取 userId
- Repository 实例化时注入 userId：`new ConversationRepo(db, request.user.userId)`
- 文件 API 初期只做元数据 CRUD（storageKey 占位），Sprint 11 MinIO 引入后才支持实际上传
- 技能商店浏览 API 公开（无需认证），安装/评价需要用户认证

#### 验收标准

| #   | 标准                              | 验证方式    |
| --- | --------------------------------- | ----------- |
| 1   | 对话 CRUD API 正常工作            | 集成测试    |
| 2   | 记忆列表 + 编辑 + 删除 API 正常   | 集成测试    |
| 3   | 助手配置 CRUD + activate API 正常 | 集成测试    |
| 4   | 自建技能 CRUD API 正常            | 集成测试    |
| 5   | 所有 API 的 userId 隔离正确       | 隔离测试    |
| 6   | Swagger UI 可访问 (`/docs`)       | 手动验证    |
| 7   | 全量测试通过                      | `pnpm test` |

---

### 第二阶段完成检查点

**完成 Sprint 5-8 后的系统状态**:

- ✅ App Server (`apps/api-server/`) 独立运行在 :3000
- ✅ 管理员 API 完整迁移（30+ 个 REST 端点）
- ✅ 用户 API 完整实现（注册/登录/自服务 + 新功能 CRUD）
- ✅ JWT 认证双体系（用户 + 管理员）
- ✅ Swagger 文档可用
- ✅ Gateway 原有 RPC 仍正常工作（双写期）
- ✅ 前端尚未切换，仍走 Gateway WebSocket

**里程碑验证**:

```bash
# 启动 App Server
cd apps/api-server && pnpm dev

# 健康检查
curl http://localhost:3000/api/health

# 管理员登录
curl -X POST http://localhost:3000/api/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password"}'

# 全量测试
pnpm test && pnpm lint
```

---

## 4. 第三阶段：Agent 改造

> 设计文档: [10d-Agent多租户改造方案.md](./10d-Agent多租户改造方案.md)

### Sprint 9: Agent 多租户基础

**目标**: Agent 运行时具备用户感知能力，设备操作权限隔离

**前置依赖**: Sprint 1（auth-context）+ Sprint 2（conversations/messages 表）

#### 任务清单

| #   | 任务                                    | 产出文件                                               |
| --- | --------------------------------------- | ------------------------------------------------------ |
| 9.1 | Session Key 增加 userId 维度            | `src/routing/session-key.ts`（修改）                   |
| 9.2 | 定义 UserAgentContext 接口和加载函数    | `src/agents/user-context.ts`（新增）                   |
| 9.3 | chat.send 注入用户上下文                | `src/gateway/server-methods/chat.ts`（修改）           |
| 9.4 | dispatchInboundMessage 传递 userContext | `src/auto-reply/dispatch.ts`（修改）                   |
| 9.5 | 工具调用权限校验                        | `src/agents/tool-guard.ts`（新增）                     |
| 9.6 | 工具调用前插入权限检查                  | `src/agents/pi-embedded-subscribe.handlers.ts`（修改） |
| 9.7 | 编写测试                                | 对应 .test.ts 文件                                     |

#### 关键设计

- Session Key 向后兼容：旧格式 Key（无 userId 前缀）视为 "default" 用户
- UserAgentContext 加载：并行查询 devices + assistantConfig + quota
- chat.send 改造：增加 `extractUserContext()` 调用，失败时回退到单用户模式
- 工具权限：exec、process、file_read、file_write 等工具需校验 deviceId 归属

#### 验收标准

| #   | 标准                                    | 验证方式    |
| --- | --------------------------------------- | ----------- |
| 1   | 新 Session Key 包含 userId，解析正确    | 单元测试    |
| 2   | UserAgentContext 正确加载用户数据       | 单元测试    |
| 3   | chat.send 携带 userContext              | 集成测试    |
| 4   | 用户 A 无法通过 Agent 操作用户 B 的设备 | 集成测试    |
| 5   | 单用户模式向后兼容（无 Token 时不报错） | 回归测试    |
| 6   | 全量测试通过                            | `pnpm test` |

---

### Sprint 10: Agent 高级功能

**目标**: 系统提示个性化、消息持久化到 DB、配额计费

**前置依赖**: Sprint 9 + Sprint 4（usage_quotas 表）

#### 任务清单

| #    | 任务                       | 产出文件                                               |
| ---- | -------------------------- | ------------------------------------------------------ |
| 10.1 | 系统提示个性化             | `src/agents/identity.ts`（修改）                       |
| 10.2 | 消息持久化服务             | `src/agents/message-persistence.ts`（新增）            |
| 10.3 | Agent 事件流集成消息写入   | `src/agents/pi-embedded-subscribe.handlers.ts`（修改） |
| 10.4 | 配额检查（chat.send 前置） | `src/gateway/server-methods/chat.ts`（修改）           |
| 10.5 | 配额扣减（消息持久化后）   | `src/agents/message-persistence.ts`                    |
| 10.6 | 编写测试                   | 对应 .test.ts 文件                                     |

#### 关键设计

- 个性化提示：在 Agent 的 system prompt 末尾追加用户配置的性格/偏好
- 消息持久化：Agent 回复完成后同步写入 `messages` 表，更新 `conversations.lastMessageAt`
- 配额检查：chat.send 开始前查 `usage_quotas`，配额耗尽返回错误
- 配额扣减：AI 回复后按 tokenCount 扣减 `usage_quotas.usedValue`

#### 验收标准

| #   | 标准                                 | 验证方式    |
| --- | ------------------------------------ | ----------- |
| 1   | 不同用户配置生成不同系统提示         | 单元测试    |
| 2   | AI 对话消息正确持久化到 messages 表  | 集成测试    |
| 3   | conversations.lastMessageAt 自动更新 | 集成测试    |
| 4   | 配额耗尽时 chat.send 返回错误        | 集成测试    |
| 5   | Token 消耗正确计入 usage_quotas      | 集成测试    |
| 6   | 全量测试通过                         | `pnpm test` |

---

### 第三阶段完成检查点

**完成 Sprint 9-10 后的系统状态**:

- ✅ Agent 运行时绑定 userId
- ✅ Session Key 包含用户维度
- ✅ 设备操作权限隔离（用户只能操作自己的设备）
- ✅ AI 对话消息持久化到 PostgreSQL
- ✅ 系统提示根据用户配置个性化
- ✅ Token 配额计费正常
- ✅ 单用户模式向后兼容

---

## 5. 第四阶段：基础设施 + 前端

> 设计文档: [10e-基础设施部署方案.md](./10e-基础设施部署方案.md), [10f-前端API迁移方案.md](./10f-前端API迁移方案.md)

### Sprint 11: 基础设施

**目标**: 引入 Redis、MinIO、pgvector，Docker Compose 一键启动

**前置依赖**: Sprint 8（文件 API 需要 MinIO）+ Sprint 10（配额缓存需要 Redis）

#### 任务清单

| #     | 任务                                     | 产出文件                                            |
| ----- | ---------------------------------------- | --------------------------------------------------- |
| 11.1  | Docker Compose 开发环境                  | `docker-compose.dev.yml`                            |
| 11.2  | Redis 连接模块                           | `src/infrastructure/redis/connection.ts`            |
| 11.3  | Redis Session 缓存                       | `src/infrastructure/redis/session-cache.ts`         |
| 11.4  | Redis 配额缓存                           | `src/infrastructure/redis/quota-cache.ts`           |
| 11.5  | Redis Pub/Sub 事件总线                   | `src/infrastructure/redis/pubsub.ts`                |
| 11.6  | MinIO 连接模块                           | `src/infrastructure/minio/connection.ts`            |
| 11.7  | MinIO 文件服务                           | `src/infrastructure/minio/file-service.ts`          |
| 11.8  | 文件 API 对接 MinIO 实际上传/下载        | `apps/api-server/src/routes/files/index.ts`（修改） |
| 11.9  | pgvector 扩展启用 + memories schema 更新 | migration + `src/db/schema/memories.ts`（修改）     |
| 11.10 | 语义搜索服务                             | `src/infrastructure/vector/memory-search.ts`        |
| 11.11 | 编写测试                                 | 对应 .test.ts 文件                                  |

#### 验收标准

| #   | 标准                                                   | 验证方式    |
| --- | ------------------------------------------------------ | ----------- |
| 1   | `docker compose -f docker-compose.dev.yml up` 一键启动 | 手动验证    |
| 2   | Redis 缓存读写正常                                     | 集成测试    |
| 3   | Redis Pub/Sub 事件传递正常                             | 集成测试    |
| 4   | MinIO 文件上传/下载/删除正常                           | 集成测试    |
| 5   | 文件 API 支持实际文件上传（multipart）                 | 集成测试    |
| 6   | pgvector 语义搜索返回相关结果                          | 集成测试    |
| 7   | 全量测试通过                                           | `pnpm test` |

---

### Sprint 12: 前端 API 迁移

**目标**: 前端从 Gateway WebSocket 迁移到 App Server HTTP REST

**前置依赖**: Sprint 6-8（App Server REST API 就绪）

#### 任务清单

| #     | 任务                                           | 产出文件                                               |
| ----- | ---------------------------------------------- | ------------------------------------------------------ |
| 12.1  | 创建共享 API 客户端包                          | `packages/api-client/`                                 |
| 12.2  | 实现 ApiClient 核心 + BrowserTokenProvider     | `packages/api-client/src/client.ts`, `auth.ts`         |
| 12.3  | 实现所有 API 端点封装                          | `packages/api-client/src/endpoints/`                   |
| 12.4  | admin-console 迁移：Hook 改用 HTTP             | `apps/admin-console/src/hooks/*.ts`（修改）            |
| 12.5  | admin-console 迁移：认证流程改 HTTP            | `apps/admin-console/src/stores/authStore.ts`           |
| 12.6  | admin-console 迁移：移除 gateway-client        | `apps/admin-console/src/lib/gateway-client.ts`（删除） |
| 12.7  | web-admin 迁移：CRUD Hook 改用 HTTP            | `apps/web-admin/src/hooks/*.ts`（修改）                |
| 12.8  | web-admin：保留 WebSocket（实时对话+设备状态） | 不动                                                   |
| 12.9  | Windows 客户端：Main 进程增加 HTTP 客户端      | `apps/windows/src/main/api-client.ts`                  |
| 12.10 | Windows 客户端：Preload 增加 api 接口          | `apps/windows/src/preload/index.ts`（修改）            |
| 12.11 | Windows 客户端：Renderer CRUD 改 HTTP          | `apps/windows/src/renderer/hooks/`（修改）             |
| 12.12 | E2E 测试                                       | 全端 E2E 测试                                          |

#### 迁移顺序

```
12.1-12.3 共享 API 客户端（基础）
    ↓
12.4-12.6 admin-console（影响面最小，纯 CRUD）
    ↓ 测试通过
12.7-12.8 web-admin（保留 WebSocket）
    ↓ 测试通过
12.9-12.11 Windows 客户端（最复杂，最后）
    ↓ 测试通过
12.12 全端 E2E 验收
```

#### 验收标准

| #   | 标准                                       | 验证方式    |
| --- | ------------------------------------------ | ----------- |
| 1   | `@openclaw/api-client` 包单元测试通过      | 单元测试    |
| 2   | admin-console 全部走 HTTP REST，功能正常   | E2E 测试    |
| 3   | web-admin CRUD 走 HTTP，对话走 WebSocket   | E2E 测试    |
| 4   | Windows 客户端 CRUD + 实时功能正常         | 手动测试    |
| 5   | Token 自动刷新和过期登出正常               | E2E 测试    |
| 6   | 浏览器 DevTools Network 面板可见 HTTP 请求 | 手动验证    |
| 7   | 全量测试通过                               | `pnpm test` |

---

### 第四阶段完成检查点

**完成 Sprint 11-12 后的系统状态（最终状态）**:

- ✅ Docker Compose 一键启动全部基础设施
- ✅ Redis 缓存 + Pub/Sub 就绪
- ✅ MinIO 文件上传/下载就绪
- ✅ pgvector 语义搜索就绪
- ✅ 前端全部迁移到 HTTP REST（实时部分保留 WebSocket）
- ✅ Gateway 仅保留实时控制面职责
- ✅ 多租户完整隔离

---

## 6. Sprint 可并行分析

以下 Sprint 之间无依赖，可以并行开发：

| 并行组            | Sprint           | 条件                                 |
| ----------------- | ---------------- | ------------------------------------ |
| Sprint 2/3/4      | 核心表三组       | 均只依赖 Sprint 1                    |
| Sprint 9 与 7-8   | Agent 改造 + API | Sprint 9 依赖 Sprint 1+2，不依赖 5-8 |
| Sprint 11 与 9-10 | 基础设施 + Agent | 部分可并行（Docker Compose 先行）    |

**推荐并行策略**:

```
时间线 →

开发者 A:  Sprint 1 → Sprint 2 → Sprint 5 → Sprint 6 → Sprint 7 → Sprint 8
开发者 B:  ·········→ Sprint 3 → Sprint 4 → Sprint 9 → Sprint 10
开发者 C:  ·········→ ·········→ ·········→ Sprint 11 → Sprint 12
```

---

## 7. 风险与缓解

| 风险                             | 影响 | 缓解措施                                        |
| -------------------------------- | ---- | ----------------------------------------------- |
| Sprint 1 基类设计不合理          | 高   | 先写测试用例验证接口，再实现                    |
| Migration 执行失败               | 高   | 先在开发库测试，备份生产数据库后再执行          |
| App Server 与 Gateway 双写不一致 | 中   | 复用相同的 Service 层代码，不重新实现           |
| Agent 改造影响面广               | 高   | Sprint 9 先做最小改动（上下文注入），观察稳定性 |
| 前端迁移期间功能中断             | 中   | 逐模块迁移，每迁移一个 Hook 就测试              |
| Docker 环境差异                  | 低   | 统一 docker-compose，CI 使用相同镜像            |

---

## 8. 总工作量估算

| Sprint   | 新增/修改文件数 | 新增测试文件数 | 复杂度 |
| -------- | --------------- | -------------- | ------ |
| 1        | 4-5             | 3              | 低     |
| 2        | 4-5             | 2              | 低     |
| 3        | 4-5             | 2              | 低     |
| 4        | 6-7             | 3              | 中     |
| 5        | 8-10            | 4              | 中     |
| 6        | 5-6             | 4              | 中     |
| 7        | 8-10            | 6              | 高     |
| 8        | 8-10            | 6              | 高     |
| 9        | 6-8             | 4              | 高     |
| 10       | 4-5             | 3              | 中     |
| 11       | 10-12           | 5              | 高     |
| 12       | 15-20           | 6              | 高     |
| **合计** | **~80-100**     | **~48**        |        |

---

_— 文档结束 —_
